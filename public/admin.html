<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Geata Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      color: #333;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
    }
    h1, h2, h3 {
      margin-top: 0;
    }
    .card {
      background: #fff;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      margin-bottom: 16px;
    }
    label {
      display: block;
      margin-bottom: 4px;
      font-size: 14px;
    }
    input, select, textarea {
      width: 100%;
      padding: 6px 8px;
      margin-bottom: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
      box-sizing: border-box;
    }
    button {
      padding: 8px 12px;
      border-radius: 4px;
      border: none;
      background: #007bff;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      margin-right: 4px;
      margin-bottom: 4px;
    }
    button[disabled] {
      opacity: 0.6;
      cursor: default;
    }
    .btn-secondary {
      background: #6c757d;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
    }
    .col-half {
      flex: 1 1 48%;
      min-width: 280px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      text-align: left;
      vertical-align: top;
    }
    th {
      background: #f0f0f0;
      font-weight: 600;
    }
    .status {
      font-size: 13px;
      margin-top: 4px;
      min-height: 16px;
    }
    .status.error {
      color: #b00020;
    }
    .status.ok {
      color: #007b00;
    }
    .small {
      font-size: 12px;
      color: #555;
    }
    .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      background: #eee;
      margin: 0 2px 2px 0;
    }
    @media (max-width: 768px) {
      .row {
        flex-direction: column;
      }
      .col-half {
        flex: 1 1 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Geata Admin Panel</h1>

    <div class="card">
      <h2>Admin Authentication</h2>
      <label for="adminKey">Admin API Key</label>
      <input
        id="adminKey"
        type="password"
        placeholder="Enter ADMIN_API_KEY (local default: dev-only-admin-key)" />
      <div id="adminStatus" class="status"></div>
    </div>

    <div class="card">
      <h2>Devices & Users</h2>
      <div class="row">
        <div class="col-half">
          <h3>Devices</h3>
          <label for="deviceSelect">Select Device</label>
          <select id="deviceSelect"></select>
          <button id="refreshDevicesBtn">Refresh Devices</button>
          <div id="deviceStatus" class="status"></div>

          <h3>Create / Reuse User for This Device</h3>
          <p class="small">
            If phone/email matches an existing user, that user will be updated and attached.<br />
            Otherwise, a new user will be created.
          </p>
          <label for="newUserName">Name</label>
          <input id="newUserName" type="text" placeholder="Name (optional)" />

          <label for="newUserEmail">Email</label>
          <input id="newUserEmail" type="email" placeholder="email@example.com (optional)" />

          <label for="newUserPhone">Phone</label>
          <input id="newUserPhone" type="tel" placeholder="e.g. 0861234567 or +353861234567" />

          <label for="newUserPassword">Password</label>
          <input id="newUserPassword" type="password" placeholder="Password for app login (optional)" />

          <label for="newUserRole">Role</label>
          <select id="newUserRole">
            <option value="operator">operator</option>
            <option value="admin">admin</option>
          </select>

          <button id="createAttachUserBtn">Create / Attach User</button>
          <div id="createUserStatus" class="status"></div>

          <h3>Bulk Import from CSV</h3>
          <p class="small">
            CSV columns (header row required): <code>name,email,phone,role</code>.<br />
            <code>role</code> can be <code>admin</code> or <code>operator</code> (default is operator).
          </p>
          <input type="file" id="csvFileInput" accept=".csv,text/csv" />
          <button id="importCsvBtn">Import CSV for Selected Device</button>
          <p class="small">
            Parsed in the browser and sent to <code>POST /devices/:id/users/import</code>.
          </p>
          <div id="csvStatus" class="status"></div>
        </div>

        <div class="col-half">
          <h3>Users on Selected Device</h3>
          <table id="deviceUsersTable">
            <thead>
              <tr>
                <th>User ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Role</th>
                <th>Schedule</th>
                <th>Remove</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div id="deviceUsersStatus" class="status"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Edit User Details (global)</h2>
      <p class="small">
        Use the lookup table below, click <strong>Edit</strong> on a user, then change their details here.<br />
        Changes apply to all devices that user has access to.
      </p>
      <div id="editUserPanel">
        <label>User ID</label>
        <input id="editUserId" type="text" readonly />

        <label for="editUserName">Name</label>
        <input id="editUserName" type="text" />

        <label for="editUserEmail">Email</label>
        <input id="editUserEmail" type="email" />

        <label for="editUserPhone">Phone</label>
        <input id="editUserPhone" type="tel" />

        <label for="editUserPassword">New Password</label>
        <input id="editUserPassword" type="password" placeholder="Leave blank to keep existing" />

        <button id="saveUserChangesBtn">Save Changes</button>
        <div id="editUserStatus" class="status"></div>
      </div>
    </div>

    <div class="card">
      <h2>Edit Access Schedule (for the current device)</h2>
      <p class="small">
        Select a device, then click "Schedule" on a user in the table above.
      </p>
      <div id="schedulePanel">
        <label>Device ID</label>
        <input id="scheduleDeviceId" type="text" readonly />

        <label>User ID</label>
        <input id="scheduleUserId" type="text" readonly />

        <label for="activeFrom">Active From (YYYY-MM-DD)</label>
        <input id="activeFrom" type="date" />

        <label for="activeTo">Active To (YYYY-MM-DD)</label>
        <input id="activeTo" type="date" />

        <label>Days of Week</label>
        <div class="small">
          <label><input type="checkbox" class="dow" value="1" /> Mon</label>
          <label><input type="checkbox" class="dow" value="2" /> Tue</label>
          <label><input type="checkbox" class="dow" value="3" /> Wed</label>
          <label><input type="checkbox" class="dow" value="4" /> Thu</label>
          <label><input type="checkbox" class="dow" value="5" /> Fri</label>
          <label><input type="checkbox" class="dow" value="6" /> Sat</label>
          <label><input type="checkbox" class="dow" value="0" /> Sun</label>
        </div>

        <label>Time Windows (up to 2)</label>
        <div class="small">Window 1</div>
        <input id="w1start" type="time" /> to
        <input id="w1end" type="time" />
        <div class="small">Window 2</div>
        <input id="w2start" type="time" /> to
        <input id="w2end" type="time" />

        <button id="saveScheduleBtn">Save Schedule</button>
        <div id="scheduleStatus" class="status"></div>
      </div>
    </div>

    <div class="card">
      <h2>User Lookup (All Users)</h2>
      <label for="userSearch">Search (name / email / phone)</label>
      <input id="userSearch" type="text" placeholder="Type to search users" />
      <button id="userSearchBtn">Search</button>
      <button id="userRefreshBtn" class="btn-secondary">Show All</button>
      <div id="userLookupStatus" class="status"></div>

      <table id="userLookupTable">
        <thead>
          <tr>
            <th>User ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Devices (gate(role))</th>
            <th>Edit</th>
            <th>Remove User</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p class="small">
        Uses <code>GET /users?q=...</code>. Each device entry is shown as <code>deviceId(role)</code>.
      </p>
    </div>
  </div>

  <script>
    const adminKeyInput       = document.getElementById('adminKey');
    const adminStatus         = document.getElementById('adminStatus');

    const deviceSelect        = document.getElementById('deviceSelect');
    const refreshDevicesBtn   = document.getElementById('refreshDevicesBtn');
    const deviceStatus        = document.getElementById('deviceStatus');

    const createAttachUserBtn = document.getElementById('createAttachUserBtn');
    const createUserStatus    = document.getElementById('createUserStatus');
    const newUserName         = document.getElementById('newUserName');
    const newUserEmail        = document.getElementById('newUserEmail');
    const newUserPhone        = document.getElementById('newUserPhone');
    const newUserPassword     = document.getElementById('newUserPassword');
    const newUserRole         = document.getElementById('newUserRole');

    const csvFileInput        = document.getElementById('csvFileInput');
    const importCsvBtn        = document.getElementById('importCsvBtn');
    const csvStatus           = document.getElementById('csvStatus');

    const deviceUsersTable    = document.getElementById('deviceUsersTable');
    const deviceUsersTbody    = deviceUsersTable.querySelector('tbody');
    const deviceUsersStatus   = document.getElementById('deviceUsersStatus');

    const editUserId          = document.getElementById('editUserId');
    const editUserName        = document.getElementById('editUserName');
    const editUserEmail       = document.getElementById('editUserEmail');
    const editUserPhone       = document.getElementById('editUserPhone');
    const editUserPassword    = document.getElementById('editUserPassword');
    const saveUserChangesBtn  = document.getElementById('saveUserChangesBtn');
    const editUserStatus      = document.getElementById('editUserStatus');

    const scheduleDeviceId    = document.getElementById('scheduleDeviceId');
    const scheduleUserId      = document.getElementById('scheduleUserId');
    const activeFromInput     = document.getElementById('activeFrom');
    const activeToInput       = document.getElementById('activeTo');
    const dowCheckboxes       = document.querySelectorAll('.dow');
    const w1startInput        = document.getElementById('w1start');
    const w1endInput          = document.getElementById('w1end');
    const w2startInput        = document.getElementById('w2start');
    const w2endInput          = document.getElementById('w2end');
    const saveScheduleBtn     = document.getElementById('saveScheduleBtn');
    const scheduleStatus      = document.getElementById('scheduleStatus');

    const userSearchInput     = document.getElementById('userSearch');
    const userSearchBtn       = document.getElementById('userSearchBtn');
    const userRefreshBtn      = document.getElementById('userRefreshBtn');
    const userLookupTable     = document.getElementById('userLookupTable');
    const userLookupTbody     = userLookupTable.querySelector('tbody');
    const userLookupStatus    = document.getElementById('userLookupStatus');

    function getAdminKey() {
      return adminKeyInput.value.trim();
    }

    function setStatus(el, msg, isError) {
      if (!el) return;
      el.textContent = msg || '';
      el.className = 'status' + (isError ? ' error' : ' ok');
    }

    // --------- DEVICES ---------

    async function loadDevices() {
      try {
        const res = await fetch('/devices');
        if (!res.ok) {
          setStatus(deviceStatus, 'Failed to load devices (HTTP ' + res.status + ')', true);
          return;
        }
        const devices = await res.json();
        deviceSelect.innerHTML = '';
        devices.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d.id;
          opt.textContent = d.name + ' (' + d.id + ')';
          deviceSelect.appendChild(opt);
        });
        if (devices.length === 0) {
          setStatus(deviceStatus, 'No devices found', true);
        } else {
          setStatus(deviceStatus, 'Devices loaded', false);
          loadDeviceUsers();
        }
      } catch (err) {
        console.error(err);
        setStatus(deviceStatus, 'Network error while loading devices', true);
      }
    }

    // --------- DEVICE USERS ---------

    async function loadDeviceUsers() {
      const adminKey = getAdminKey();
      if (!adminKey) {
        setStatus(deviceUsersStatus, 'Admin key is required', true);
        return;
      }
      const deviceId = deviceSelect.value;
      if (!deviceId) {
        setStatus(deviceUsersStatus, 'Select a device first', true);
        return;
      }

      try {
        const res = await fetch('/devices/' + encodeURIComponent(deviceId) + '/users', {
          headers: {
            'x-api-key': adminKey
          }
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          setStatus(deviceUsersStatus, data.error || ('HTTP ' + res.status), true);
          return;
        }
        const users = await res.json();
        deviceUsersTbody.innerHTML = '';
        users.forEach(u => {
          const tr = document.createElement('tr');

          const tdId = document.createElement('td');
          tdId.textContent = u.userId || u.id;
          tr.appendChild(tdId);

          const tdName = document.createElement('td');
          tdName.textContent = u.name || '';
          tr.appendChild(tdName);

          const tdEmail = document.createElement('td');
          tdEmail.textContent = u.email || '';
          tr.appendChild(tdEmail);

          const tdPhone = document.createElement('td');
          tdPhone.textContent = u.phone || '';
          tr.appendChild(tdPhone);

          const tdRole = document.createElement('td');
          tdRole.textContent = u.role || '';
          tr.appendChild(tdRole);

          const tdSchedule = document.createElement('td');
          const schedBtn = document.createElement('button');
          schedBtn.textContent = 'Schedule';
          schedBtn.addEventListener('click', () => {
            openSchedule(deviceId, u.userId || u.id);
          });
          tdSchedule.appendChild(schedBtn);
          tr.appendChild(tdSchedule);

          const tdRemove = document.createElement('td');
          const remBtn = document.createElement('button');
          remBtn.textContent = 'Remove';
          remBtn.addEventListener('click', () => {
            removeUserFromDevice(deviceId, u.userId || u.id);
          });
          tdRemove.appendChild(remBtn);
          tr.appendChild(tdRemove);

          deviceUsersTbody.appendChild(tr);
        });
        setStatus(deviceUsersStatus, 'Loaded ' + users.length + ' users', false);
      } catch (err) {
        console.error(err);
        setStatus(deviceUsersStatus, 'Network error while loading device users', true);
      }
    }

    async function removeUserFromDevice(deviceId, userId) {
      const adminKey = getAdminKey();
      if (!adminKey) {
        alert('Admin key is required');
        return;
      }
      if (!confirm('Remove user ' + userId + ' from device ' + deviceId + '?')) {
        return;
      }
      try {
        const res = await fetch(
          '/devices/' + encodeURIComponent(deviceId) + '/users/' + encodeURIComponent(userId),
          {
            method: 'DELETE',
            headers: { 'x-api-key': adminKey }
          }
        );
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          alert('Error removing user: ' + (data.error || ('HTTP ' + res.status)));
          return;
        }
        loadDeviceUsers();
        loadUserLookup();
      } catch (err) {
        console.error(err);
        alert('Network error removing user');
      }
    }

    // --------- CREATE / ATTACH USER ---------

    async function handleCreateAttachUser() {
      const adminKey = getAdminKey();
      if (!adminKey) {
        setStatus(createUserStatus, 'Admin key is required', true);
        return;
      }
      const deviceId = deviceSelect.value;
      if (!deviceId) {
        setStatus(createUserStatus, 'Select a device first', true);
        return;
      }

      const name     = newUserName.value.trim();
      const email    = newUserEmail.value.trim();
      const phone    = newUserPhone.value.trim();
      const password = newUserPassword.value;
      const role     = newUserRole.value;

      if (!phone && !email) {
        setStatus(createUserStatus, 'At least phone or email is required', true);
        return;
      }

      setStatus(createUserStatus, 'Sending...', false);

      try {
        const res = await fetch('/devices/' + encodeURIComponent(deviceId) + '/users', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': adminKey
          },
          body: JSON.stringify({ name, email, phone, password, role })
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          setStatus(createUserStatus, data.error || ('HTTP ' + res.status), true);
          return;
        }

        setStatus(
          createUserStatus,
          'User attached: ' + (data.user && data.user.id ? data.user.id : data.userId),
          false
        );
        newUserName.value = '';
        newUserEmail.value = '';
        newUserPhone.value = '';
        newUserPassword.value = '';
        newUserRole.value = 'operator';

        loadDeviceUsers();
        loadUserLookup();
      } catch (err) {
        console.error(err);
        setStatus(createUserStatus, 'Network error', true);
      }
    }

    // --------- CSV IMPORT (FILE INPUT) ---------

    function parseCsvText(text) {
      const trimmed = text.trim();
      if (!trimmed) return [];

      const lines = trimmed.split(/\r?\n/).filter(l => l.trim().length > 0);
      if (lines.length < 2) {
        return [];
      }

      const header = lines[0].split(',').map(h => h.trim().toLowerCase());
      const idxName  = header.indexOf('name');
      const idxEmail = header.indexOf('email');
      const idxPhone = header.indexOf('phone');
      const idxRole  = header.indexOf('role');

      const rows = [];

      for (let i = 1; i < lines.length; i++) {
        const parts = lines[i].split(',');
        const name  = idxName  >= 0 ? (parts[idxName]  || '').trim() : '';
        const email = idxEmail >= 0 ? (parts[idxEmail] || '').trim() : '';
        const phone = idxPhone >= 0 ? (parts[idxPhone] || '').trim() : '';
        const role  = idxRole  >= 0 ? (parts[idxRole]  || '').trim() : 'operator';

        if (!name && !email && !phone) continue;

        rows.push({ name, email, phone, role });
      }

      return rows;
    }

    async function handleImportCsv() {
      const adminKey = getAdminKey();
      if (!adminKey) {
        setStatus(csvStatus, 'Admin key is required', true);
        return;
      }
      const deviceId = deviceSelect.value;
      if (!deviceId) {
        setStatus(csvStatus, 'Select a device first', true);
        return;
      }

      const file = csvFileInput.files[0];
      if (!file) {
        setStatus(csvStatus, 'Choose a CSV file first', true);
        return;
      }

      setStatus(csvStatus, 'Reading file...', false);

      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          const text = e.target.result;
          const rows = parseCsvText(text);

          if (!rows || rows.length === 0) {
            setStatus(csvStatus, 'No valid rows found in CSV. Check header and at least one data row.', true);
            return;
          }

          setStatus(csvStatus, 'Importing ' + rows.length + ' row(s)...', false);

          const res = await fetch('/devices/' + encodeURIComponent(deviceId) + '/users/import', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': adminKey
            },
            body: JSON.stringify({ rows })
          });

          const data = await res.json().catch(() => ({}));

          if (!res.ok) {
            setStatus(csvStatus, data.error || ('HTTP ' + res.status), true);
            return;
          }

          const createdCount = (data.created || []).length;
          const reusedCount  = (data.reused  || []).length;

          setStatus(csvStatus, 'Import OK. Created: ' + createdCount + ', Reused: ' + reusedCount, false);

          loadDeviceUsers();
          loadUserLookup();
        } catch (err) {
          console.error(err);
          setStatus(csvStatus, 'Error parsing/importing CSV', true);
        }
      };
      reader.onerror = function() {
        setStatus(csvStatus, 'Error reading CSV file', true);
      };
      reader.readAsText(file);
    }

    // --------- GLOBAL EDIT USER ---------

    function openGlobalEditUser(u) {
      editUserId.value       = u.id;
      editUserName.value     = u.name || '';
      editUserEmail.value    = u.email || '';
      editUserPhone.value    = u.phone || '';
      editUserPassword.value = '';
      setStatus(editUserStatus, 'Editing user ' + u.id, false);
    }

    async function handleSaveUserChanges() {
      const adminKey = getAdminKey();
      if (!adminKey) {
        setStatus(editUserStatus, 'Admin key is required', true);
        return;
      }
      const userId = editUserId.value.trim();
      if (!userId) {
        setStatus(editUserStatus, 'No user selected for edit', true);
        return;
      }

      const name     = editUserName.value.trim();
      const email    = editUserEmail.value.trim();
      const phone    = editUserPhone.value.trim();
      const password = editUserPassword.value;

      setStatus(editUserStatus, 'Saving...', false);

      try {
        const res = await fetch('/users/' + encodeURIComponent(userId), {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': adminKey
          },
          body: JSON.stringify({ name, email, phone, password })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          setStatus(editUserStatus, data.error || ('HTTP ' + res.status), true);
          return;
        }
        setStatus(editUserStatus, 'User updated', false);
        editUserPassword.value = '';
        loadDeviceUsers();
        loadUserLookup(userSearchInput.value);
      } catch (err) {
        console.error(err);
        setStatus(editUserStatus, 'Network error saving user', true);
      }
    }

    // --------- SCHEDULE ---------

    function clearScheduleForm() {
      activeFromInput.value = '';
      activeToInput.value   = '';
      dowCheckboxes.forEach(cb => cb.checked = false);
      w1startInput.value = '';
      w1endInput.value   = '';
      w2startInput.value = '';
      w2endInput.value   = '';
    }

    async function openSchedule(deviceId, userId) {
      const adminKey = getAdminKey();
      if (!adminKey) {
        setStatus(scheduleStatus, 'Admin key is required', true);
        return;
      }
      scheduleDeviceId.value = deviceId;
      scheduleUserId.value   = userId;
      clearScheduleForm();
      setStatus(scheduleStatus, 'Loading schedule...', false);

      try {
        const res = await fetch(
          '/devices/' + encodeURIComponent(deviceId) + '/users/' + encodeURIComponent(userId) + '/schedule',
          {
            headers: { 'x-api-key': adminKey }
          }
        );
        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          setStatus(scheduleStatus, data.error || ('HTTP ' + res.status), true);
          return;
        }

        if (data.defaultAccess) {
          setStatus(scheduleStatus, data.message || 'User has 24/7 access', false);
          return;
        }

        if (data.activeFrom) activeFromInput.value = data.activeFrom;
        if (data.activeTo)   activeToInput.value   = data.activeTo;

        if (Array.isArray(data.daysOfWeek)) {
          dowCheckboxes.forEach(cb => {
            cb.checked = data.daysOfWeek.includes(parseInt(cb.value, 10));
          });
        }
        if (Array.isArray(data.windows)) {
          if (data.windows[0]) {
            w1startInput.value = data.windows[0].start || '';
            w1endInput.value   = data.windows[0].end   || '';
          }
          if (data.windows[1]) {
            w2startInput.value = data.windows[1].start || '';
            w2endInput.value   = data.windows[1].end   || '';
          }
        }

        setStatus(scheduleStatus, 'Schedule loaded', false);
      } catch (err) {
        console.error(err);
        setStatus(scheduleStatus, 'Network error loading schedule', true);
      }
    }

    async function handleSaveSchedule() {
      const adminKey = getAdminKey();
      if (!adminKey) {
        setStatus(scheduleStatus, 'Admin key is required', true);
        return;
      }
      const deviceId = scheduleDeviceId.value.trim();
      const userId   = scheduleUserId.value.trim();
      if (!deviceId || !userId) {
        setStatus(scheduleStatus, 'No device/user selected', true);
        return;
      }

      const activeFrom = activeFromInput.value || null;
      const activeTo   = activeToInput.value   || null;

      const daysOfWeek = [];
      dowCheckboxes.forEach(cb => {
        if (cb.checked) daysOfWeek.push(parseInt(cb.value, 10));
      });

      const windows = [];
      if (w1startInput.value && w1endInput.value) {
        windows.push({ start: w1startInput.value, end: w1endInput.value });
      }
      if (w2startInput.value && w2endInput.value) {
        windows.push({ start: w2startInput.value, end: w2endInput.value });
      }

      const body = { activeFrom, activeTo, daysOfWeek, windows };

      try {
        const res = await fetch(
          '/devices/' + encodeURIComponent(deviceId) + '/users/' + encodeURIComponent(userId) + '/schedule',
          {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': adminKey
            },
            body: JSON.stringify(body)
          }
        );
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          setStatus(scheduleStatus, data.error || ('HTTP ' + res.status), true);
          return;
        }
        setStatus(scheduleStatus, 'Schedule saved', false);
      } catch (err) {
        console.error(err);
        setStatus(scheduleStatus, 'Network error saving schedule', true);
      }
    }

    // --------- USER LOOKUP (GLOBAL) ---------

    async function loadUserLookup(query) {
      const adminKey = getAdminKey();
      if (!adminKey) {
        setStatus(userLookupStatus, 'Admin key is required', true);
        return;
      }

      const params = new URLSearchParams();
      if (query && query.trim()) {
        params.set('q', query.trim());
      }

      try {
        const res = await fetch('/users?' + params.toString(), {
          headers: { 'x-api-key': adminKey }
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          setStatus(userLookupStatus, data.error || ('HTTP ' + res.status), true);
          return;
        }

        const users = data;
        userLookupTbody.innerHTML = '';

        users.forEach(u => {
          const tr = document.createElement('tr');

          const tdId = document.createElement('td');
          tdId.textContent = u.id;
          tr.appendChild(tdId);

          const tdName = document.createElement('td');
          tdName.textContent = u.name || '';
          tr.appendChild(tdName);

          const tdEmail = document.createElement('td');
          tdEmail.textContent = u.email || '';
          tr.appendChild(tdEmail);

          const tdPhone = document.createElement('td');
          tdPhone.textContent = u.phone || '';
          tr.appendChild(tdPhone);

          const tdDevices = document.createElement('td');
          if (Array.isArray(u.devices) && u.devices.length > 0) {
            u.devices.forEach(d => {
              const span = document.createElement('span');
              span.className = 'tag';
              span.textContent = d.deviceId + '(' + d.role + ')';
              tdDevices.appendChild(span);
            });
          }
          tr.appendChild(tdDevices);

          const tdEdit = document.createElement('td');
          const editBtn = document.createElement('button');
          editBtn.textContent = 'Edit';
          editBtn.addEventListener('click', () => {
            openGlobalEditUser(u);
          });
          tdEdit.appendChild(editBtn);
          tr.appendChild(tdEdit);

          const tdRemove = document.createElement('td');
          const remBtn = document.createElement('button');
          remBtn.textContent = 'Delete User';
          remBtn.addEventListener('click', () => {
            deleteUserGlobal(u.id);
          });
          tdRemove.appendChild(remBtn);
          tr.appendChild(tdRemove);

          userLookupTbody.appendChild(tr);
        });

        setStatus(userLookupStatus, 'Loaded ' + users.length + ' users', false);
      } catch (err) {
        console.error(err);
        setStatus(userLookupStatus, 'Network error loading users', true);
      }
    }

    async function deleteUserGlobal(userId) {
      const adminKey = getAdminKey();
      if (!adminKey) {
        alert('Admin key is required');
        return;
      }
      if (!confirm('Delete user ' + userId + ' from system (all devices)?')) {
        return;
      }

      try {
        const res = await fetch('/users/' + encodeURIComponent(userId), {
          method: 'DELETE',
          headers: { 'x-api-key': adminKey }
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          alert('Error deleting user: ' + (data.error || ('HTTP ' + res.status)));
          return;
        }
        loadUserLookup(userSearchInput.value);
        loadDeviceUsers();
      } catch (err) {
        console.error(err);
        alert('Network error deleting user');
      }
    }

    // --------- EVENT WIRING ---------

    refreshDevicesBtn.addEventListener('click', loadDevices);
    deviceSelect.addEventListener('change', loadDeviceUsers);

    createAttachUserBtn.addEventListener('click', handleCreateAttachUser);

    if (importCsvBtn) {
      importCsvBtn.addEventListener('click', handleImportCsv);
    }

    saveUserChangesBtn.addEventListener('click', handleSaveUserChanges);
    saveScheduleBtn.addEventListener('click', handleSaveSchedule);

    userSearchBtn.addEventListener('click', () => {
      loadUserLookup(userSearchInput.value);
    });
    userRefreshBtn.addEventListener('click', () => {
      userSearchInput.value = '';
      loadUserLookup('');
    });

    window.addEventListener('load', () => {
      setStatus(adminStatus, 'Enter your admin key to manage devices', false);
      loadDevices();
      // User lookup: press "Show All" or "Search" after entering key
    });
  </script>
</body>
</html>
