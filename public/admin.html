<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Geata Admin (Profile-driven)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --bg:#0b2535;
      --bg2:#123653;
      --ink:#f5f7fa;
      --muted:#b8d7ff;
      --line:rgba(255,255,255,.12);
      --accent:#1c5e86;
      --accent2:#345a77;
      --danger:#d9534f;
      --ok:#ffb300;
      --whitebox: rgba(255,255,255,0.95);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background: radial-gradient(circle at top, #1e3f5d 0, #cfdfee 45%, #b3cde5 100%);
      color:var(--ink);
    }
    .container{max-width:1200px;margin:0 auto;padding:18px 14px 40px}
    h1{margin:0 0 8px;font-size:22px;letter-spacing:.04em}
    .subtitle{margin:0 0 14px;color:rgba(245,247,250,.75);font-size:13px}
    .topnav{
      display:flex;gap:8px;flex-wrap:wrap;align-items:center;
      margin:10px 0 14px;
    }
    .navbtn{
      border:1px solid var(--line);
      background:#17405f;
      color:var(--ink);
      border-radius:999px;
      padding:8px 12px;
      font-size:13px;
      cursor:pointer;
    }
    .navbtn.active{background:var(--accent)}
    .card{
      background:var(--bg);
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      box-shadow:0 12px 30px rgba(0,0,0,.18);
      padding:14px 14px 16px;
      margin-bottom:12px;
    }
    .card h2{margin:0 0 6px;font-size:17px}
    .pill-title{
      display:inline-block;
      padding:2px 10px;
      border-radius:999px;
      background:rgba(28,94,134,.2);
      color:#bfe7ff;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.08em;
      margin-bottom:6px;
    }
    .two{
      display:grid;
      grid-template-columns:repeat(2, minmax(0, 1fr));
      gap:12px;
    }
    @media(max-width:900px){ .two{grid-template-columns:1fr} }
    label{display:block;margin:0 0 4px;font-size:13px;color:#e3f2fd}
    input, select{
      width:100%;
      padding:8px 9px;
      border-radius:8px;
      border:1px solid #ccd2dd;
      font-size:13px;
      margin-bottom:8px;
    }
    button{
      padding:7px 11px;
      border-radius:999px;
      border:none;
      background:var(--accent);
      color:#fff;
      cursor:pointer;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      margin-right:6px;
      margin-bottom:6px;
      white-space:nowrap;
    }
    button.secondary{background:var(--accent2)}
    button.danger{background:var(--danger)}
    button[disabled]{opacity:.5;cursor:default}
    .status{min-height:16px;font-size:12px;margin-top:4px}
    .status.ok{color:var(--ok)}
    .status.err{color:#b00020}
    .small{font-size:12px;color:rgba(245,247,250,.8)}
    .whitebox{
      background:var(--whitebox);
      color:#122b3a;
      border-radius:10px;
      padding:10px 12px;
      border:1px solid rgba(0,0,0,.12);
      margin:8px 0 10px;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    code{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px}
    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      background:var(--bg2);
      border-radius:10px;
      overflow:hidden;
      margin-top:8px;
    }
    th,td{border:1px solid rgba(255,255,255,.10);padding:7px;vertical-align:top;text-align:left}
    th{background:#17405f}
    .pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      background:rgba(28,94,134,.2);
      border:1px solid rgba(255,255,255,.3);
      color:var(--ink);
      font-size:11px;
      margin:0 6px 6px 0;
    }

    /* Event checkbox panel */
    .event-panel{
      background:var(--bg2);
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      padding:10px 12px;
    }
    .event-row{
      display:grid;
      grid-template-columns:26px 1fr;
      align-items:center;
      gap:10px;
      padding:6px 2px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .event-row:last-child{border-bottom:none}
    .event-row input[type="checkbox"]{
      width:16px;height:16px;margin:0;
      justify-self:start;
    }
    .event-row span{color:var(--ink);font-size:13px;line-height:1.2}

    /* prevent global width:100% breaking checkboxes/radios */
    input[type="checkbox"], input[type="radio"]{width:auto !important;margin:0 !important}
  </style>
</head>

<body>
  <div class="container">
    <h1>Geata Admin Panel</h1>
    <p class="subtitle">Profile-driven admin UI (Users → choose user → choose gate → edit schedule + email subscriptions). Gates → choose gate → manage users + settings + I/O test.</p>

    <div class="topnav">
      <button class="navbtn active" data-screen="screen-auth">Auth</button>
      <button class="navbtn" data-screen="screen-users">Users</button>
      <button class="navbtn" data-screen="screen-gates">Gates</button>
      <button class="navbtn" data-screen="screen-schedules">Schedules</button>
      <button class="navbtn" data-screen="screen-events">Events</button>
    </div>

    <!-- AUTH -->
    <section id="screen-auth" class="card">
      <div class="pill-title">Security</div>
      <h2>Admin Authentication</h2>

      <label for="authApiKey">Admin API Key</label>
      <input id="authApiKey" type="text" placeholder="Enter Admin API key" />
      <button id="authSaveKey">Save Key</button>
      <button id="authClearKey" class="secondary">Clear</button>
      <div id="authStatus" class="status"></div>

      <div class="whitebox">
        <div class="small" style="color:#122b3a">
          This UI calls your server endpoints with header <code>x-api-key</code>.
          The key is stored in your browser <code>localStorage</code>.
        </div>
      </div>

      <button id="bootstrapBtn" class="secondary">Load Devices + Users + Schedules</button>
      <div id="bootstrapStatus" class="status"></div>
    </section>

    <!-- USERS -->
    <section id="screen-users" class="card" style="display:none">
      <div class="pill-title">Profiles</div>
      <h2>Users</h2>

      <div class="two">
        <div>
          <label for="usersSearch">Search Users</label>
          <input id="usersSearch" type="text" placeholder="name/email/phone/userId" />
          <button id="usersSearchBtn" class="secondary">Search</button>
          <button id="usersShowAllBtn" class="secondary">Show All</button>
          <div id="usersListStatus" class="status"></div>

          <label for="usersSelect">Select User</label>
          <select id="usersSelect">
            <option value="">-- Select a user --</option>
          </select>
          <button id="usersLoadProfileBtn">Load Profile</button>
          <div id="usersProfileStatus" class="status"></div>
        </div>

        <div>
          <div class="whitebox">
            <div class="row">
              <div><strong>User:</strong></div>
              <code id="usersPickedUser">(none)</code>
            </div>
            <div class="row" style="margin-top:6px">
              <div><strong>Email:</strong></div>
              <code id="usersPickedEmail">(none)</code>
            </div>
            <div class="row" style="margin-top:6px">
              <div><strong>Phone:</strong></div>
              <code id="usersPickedPhone">(none)</code>
            </div>
          </div>

          <label for="usersDeviceSelect">Select Gate for this User</label>
          <select id="usersDeviceSelect" disabled>
            <option value="">-- Select a gate --</option>
          </select>

          <div class="whitebox">
            <div class="small" style="color:#122b3a">
              You are editing the per-device assignment for this user:
              <code>scheduleId</code> on <code>device_users</code>, and email subscriptions in
              <code>device_notification_subscriptions</code>.
            </div>
          </div>
        </div>
      </div>

      <div class="two">
        <!-- Schedule assignment -->
        <div class="card" style="background:var(--bg2); border:1px solid rgba(255,255,255,.10)">
          <div class="pill-title">Schedule</div>
          <h2 style="font-size:15px;margin-top:0">Per-device Schedule Assignment</h2>

          <label for="usersScheduleSelect">Schedule for this gate</label>
          <select id="usersScheduleSelect" disabled>
            <option value="">24/7 (no schedule)</option>
          </select>

          <button id="usersSaveScheduleBtn" disabled>Save Schedule</button>
          <div id="usersScheduleStatus" class="status"></div>

          <div class="small">
            Saves via: <code>PUT /devices/:deviceId/users/:userId/schedule-assignment</code>
          </div>
        </div>

        <!-- Email subscriptions -->
        <div class="card" style="background:var(--bg2); border:1px solid rgba(255,255,255,.10)">
          <div class="pill-title">Emails</div>
          <h2 style="font-size:15px;margin-top:0">Per-device Email Subscriptions</h2>

          <div id="usersEmailPanel"></div>
          <button id="usersSaveEmailBtn" disabled>Save Email Subscriptions</button>
          <div id="usersEmailStatus" class="status"></div>

          <div class="small">
            Loads from: <code>GET /profiles/users/:id</code> (profile)<br/>
            Saves via: <code>PUT /devices/:deviceId/users/:userId/notifications</code>
          </div>
        </div>
      </div>

      <div class="section-divider" style="height:1px;background:linear-gradient(to right, rgba(255,255,255,.15), rgba(0,0,0,0));margin:12px 0"></div>

      <div class="pill-title">Debug</div>
      <h2 style="font-size:15px;margin-top:0">Profile JSON (read-only)</h2>
      <div class="whitebox">
        <pre id="usersProfileJson" style="margin:0; white-space:pre-wrap; word-break:break-word; font-size:12px;"></pre>
      </div>
    </section>

    <!-- GATES -->
    <section id="screen-gates" class="card" style="display:none">
      <div class="pill-title">Gates</div>
      <h2>Gates</h2>

      <div class="two">
        <div>
          <label for="gatesSelect">Select Gate</label>
          <select id="gatesSelect">
            <option value="">-- Select a gate --</option>
          </select>
          <button id="gatesLoadBtn" class="secondary">Load Gate Data</button>
          <div id="gatesStatus" class="status"></div>

          <div class="whitebox">
            <div class="row">
              <div><strong>Gate:</strong></div>
              <code id="gatesPickedGate">(none)</code>
            </div>
          </div>
        </div>

        <div>
          <div class="pill-title">Device Settings</div>
          <h2 style="font-size:15px;margin-top:0">AUX1 Function</h2>

          <div class="card" style="background:var(--bg2);border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:10px 12px">
            <label style="margin-top:4px">
              <input type="radio" name="aux1ModeGate" value="relay" />
              Relay On/Off (single gate)
            </label>
            <label style="margin-top:8px">
              <input type="radio" name="aux1ModeGate" value="gate2" />
              Gate2 monitor (two gates)
            </label>
            <div class="small" style="margin-top:8px">
              Saved in <code>device_settings.settings</code> as <code>{"aux1Mode":"relay|gate2"}</code>.
            </div>
          </div>

          <button id="gatesLoadSettingsBtn" class="secondary">Load Settings</button>
          <button id="gatesSaveSettingsBtn" disabled>Save Settings</button>
          <div id="gatesSettingsStatus" class="status"></div>
        </div>
      </div>

      <div class="section-divider" style="height:1px;background:linear-gradient(to right, rgba(255,255,255,.15), rgba(0,0,0,0));margin:12px 0"></div>

      <div class="pill-title">Users on gate</div>
      <h2 style="font-size:15px;margin-top:0">Users enrolled on this gate</h2>

      <table id="gatesUsersTable">
        <thead>
          <tr>
            <th>User ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Role</th>
            <th>Schedule</th>
            <th>Remove</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div id="gatesUsersStatus" class="status"></div>

      <div class="section-divider" style="height:1px;background:linear-gradient(to right, rgba(255,255,255,.15), rgba(0,0,0,0));margin:12px 0"></div>

      <div class="pill-title">I/O</div>
      <h2 style="font-size:15px;margin-top:0">I/O Test (Admin)</h2>

      <div class="two">
        <div>
          <button id="gatesAux1PulseBtn" class="secondary">AUX1 Pulse (1s)</button>
          <button id="gatesAux2PulseBtn" class="secondary">Output3 Pulse (2s)</button>
          <div id="gatesIoStatus" class="status"></div>

          <div class="small">
            Uses: <code>POST /devices/:id/aux1-test</code> and <code>/aux2-test</code>
          </div>
        </div>
        <div>
          <div class="row" style="gap:6px">
            <button id="simGateOpenedBtn">Sim GATE_OPENED</button>
            <button id="simGateClosedBtn">Sim GATE_CLOSED</button>
            <button id="simForcedBtn">Sim GATE_FORCED_OPEN</button>
            <button id="simTamperBtn">Sim TAMPER_OPENED (+Output3)</button>
          </div>
          <div id="gatesSimStatus" class="status"></div>

          <div class="small">
            Uses: <code>POST /devices/:id/simulate-event</code>
          </div>
        </div>
      </div>
    </section>

    <!-- SCHEDULES -->
    <section id="screen-schedules" class="card" style="display:none">
      <div class="pill-title">Time</div>
      <h2>Schedules (read-only list)</h2>
      <button id="schedRefreshBtn" class="secondary">Refresh</button>
      <div id="schedStatus" class="status"></div>

      <table id="schedTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Description</th>
            <th>Slots</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="small" style="margin-top:8px">
        This UI is intentionally simple. You can manage schedules via your existing endpoints:
        <code>GET/POST/PUT/DELETE /schedules</code>.
      </div>
    </section>

    <!-- EVENTS -->
    <section id="screen-events" class="card" style="display:none">
      <div class="pill-title">Audit</div>
      <h2>Recent Events</h2>

      <div class="two">
        <div>
          <label for="eventsDevice">Device filter (optional)</label>
          <select id="eventsDevice">
            <option value="">-- Any device --</option>
          </select>
        </div>
        <div>
          <label for="eventsLimit">Limit</label>
          <input id="eventsLimit" type="number" min="10" max="5000" value="200" />
        </div>
      </div>

      <button id="eventsLoadBtn" class="secondary">Load</button>
      <div id="eventsStatus" class="status"></div>

      <table id="eventsTable">
        <thead>
          <tr>
            <th>Time (UTC)</th>
            <th>Device</th>
            <th>User</th>
            <th>Event</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="small" style="margin-top:8px">
        Uses: <code>GET /events?deviceId=&limit=</code>
      </div>
    </section>
  </div>

  <script>
    // =========================
    // Constants
    // =========================
    const EMAIL_EVENT_TYPES = [
      "OPEN_REQUESTED",
      "CMD_COMPLETED",
      "GATE_OPENED",
      "GATE_CLOSED",
      "GATE_FORCED_OPEN",
      "DOOR_FORCED_OPEN",
      "GATE_OPEN_TOO_LONG",
      "TAMPER_OPENED",
      "ACCESS_DENIED_NOT_ASSIGNED",
      "ACCESS_DENIED_SCHEDULE",
      "AUX1_REQUESTED",
      "AUX2_REQUESTED",
      "AUX1_DENIED_NOT_ASSIGNED",
      "AUX1_DENIED_SCHEDULE",
      "AUX2_DENIED_NOT_ASSIGNED",
      "AUX2_DENIED_SCHEDULE"
    ];

    // =========================
    // State
    // =========================
    let apiKey = localStorage.getItem("geata_admin_api_key") || "";
    let allDevices = [];
    let allUsers = [];
    let allSchedules = [];
    const profilesByUserId = new Map(); // userId -> profile

    // current context
    let currentUserId = "";
    let currentUserProfile = null;
    let currentUserDeviceId = "";

    let currentGateId = "";

    // =========================
    // Helpers
    // =========================
    function $(id){ return document.getElementById(id); }

    function setStatus(el, msg, isErr=false){
      if(!el) return;
      el.textContent = msg || "";
      el.className = "status " + (isErr ? "err" : "ok");
    }

    function headersJson(){
      const h = { "Content-Type":"application/json" };
      if(apiKey) h["x-api-key"] = apiKey;
      return h;
    }

    async function apiJson(path, opts={}){
      const res = await fetch(path, {
        method: opts.method || "GET",
        headers: opts.headers || headersJson(),
        body: opts.body
      });
      const text = await res.text().catch(()=> "");
      let data = null;
      try{ data = text ? JSON.parse(text) : null; }catch{ data = text; }

      if(!res.ok){
        const msg = (data && data.error) ? data.error : (typeof data === "string" ? data : ("HTTP " + res.status));
        const err = new Error(msg);
        err.status = res.status;
        err.data = data;
        throw err;
      }
      return data;
    }

    function renderEventCheckboxPanel(containerEl, eventTypes){
      if(!containerEl) return;
      containerEl.innerHTML = "";
      const panel = document.createElement("div");
      panel.className = "event-panel";
      (eventTypes || []).forEach(ev=>{
        const row = document.createElement("label");
        row.className = "event-row";
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.value = ev;
        const txt = document.createElement("span");
        txt.textContent = ev;
        row.appendChild(cb);
        row.appendChild(txt);
        panel.appendChild(row);
      });
      containerEl.appendChild(panel);
    }

    function setPanelChecked(containerEl, selectedList){
      if(!containerEl) return;
      const set = new Set((selectedList || []).map(String));
      containerEl.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
        cb.checked = set.has(cb.value);
      });
    }

    function getPanelChecked(containerEl){
      if(!containerEl) return [];
      const out = [];
      containerEl.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => out.push(cb.value));
      return out;
    }

    function fillDeviceSelect(selectEl, includeBlank=true, blankText="-- Select a gate --"){
      if(!selectEl) return;
      const cur = selectEl.value;
      selectEl.innerHTML = "";
      if(includeBlank){
        const o = document.createElement("option");
        o.value = "";
        o.textContent = blankText;
        selectEl.appendChild(o);
      }
      allDevices.forEach(d=>{
        const o = document.createElement("option");
        o.value = d.id;
        o.textContent = d.name ? `${d.id} – ${d.name}` : d.id;
        selectEl.appendChild(o);
      });
      if(cur && allDevices.some(d=>d.id===cur)) selectEl.value = cur;
    }

    function fillUserSelect(selectEl, users){
      if(!selectEl) return;
      const cur = selectEl.value;
      const list = users || allUsers;
      selectEl.innerHTML = `<option value="">-- Select a user --</option>`;
      list.forEach(u=>{
        const o = document.createElement("option");
        o.value = u.id;
        const label = `${u.name || "(no name)"}${u.email ? " · " + u.email : ""}${u.phone ? " · " + u.phone : ""} [${u.id}]`;
        o.textContent = label;
        selectEl.appendChild(o);
      });
      if(cur && list.some(u=>u.id===cur)) selectEl.value = cur;
    }

    function dayName(d){ return ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][d] || "?"; }
    function describeSlots(slots){
      if(!slots || !slots.length) return "—";
      return slots.map(s=>{
        const days = Array.isArray(s.daysOfWeek) ? s.daysOfWeek : [];
        const dayStr = days.length ? days.map(dayName).join(",") : "All days";
        return `${dayStr} ${s.start || ""}-${s.end || ""}`;
      }).join(" | ");
    }

    // =========================
    // Profile API
    // =========================
    async function loadUserProfile(userId, {force=false} = {}){
      if(!userId) return null;
      if(!force && profilesByUserId.has(userId)) return profilesByUserId.get(userId);
      const profile = await apiJson(`/profiles/users/${encodeURIComponent(userId)}`);
      profilesByUserId.set(userId, profile);
      return profile;
    }

    function getProfileDevice(profile, deviceId){
      if(!profile || !Array.isArray(profile.devices)) return null;
      return profile.devices.find(d=>d.deviceId===deviceId) || null;
    }

    // =========================
    // Navigation
    // =========================
    function showScreen(id){
      const screens = ["screen-auth","screen-users","screen-gates","screen-schedules","screen-events"];
      screens.forEach(s=>{
        const el = $(s);
        if(el) el.style.display = (s===id ? "block" : "none");
      });
      document.querySelectorAll(".navbtn").forEach(b=>{
        b.classList.toggle("active", b.dataset.screen === id);
      });
    }

    // =========================
    // Bootstrap data
    // =========================
    async function loadDevices(){
      allDevices = Array.isArray(await apiJson("/devices")) ? await apiJson("/devices") : [];
    }
    async function loadUsers(query=null){
      const url = query ? ("/users?q=" + encodeURIComponent(query)) : "/users";
      const list = await apiJson(url);
      allUsers = Array.isArray(list) ? list : [];
    }
    async function loadSchedules(){
      const list = await apiJson("/schedules");
      allSchedules = Array.isArray(list) ? list : [];
    }

    function rebuildScheduleSelect(selectEl){
      if(!selectEl) return;
      const cur = selectEl.value;
      selectEl.innerHTML = `<option value="">24/7 (no schedule)</option>`;
      allSchedules.forEach(s=>{
        const o = document.createElement("option");
        o.value = String(s.id);
        o.textContent = s.name;
        selectEl.appendChild(o);
      });
      if(cur && allSchedules.some(s=>String(s.id)===cur)) selectEl.value = cur;
    }

    // =========================
    // Auth screen
    // =========================
    function initAuth(){
      $("authApiKey").value = apiKey;

      $("authSaveKey").addEventListener("click", ()=>{
        apiKey = $("authApiKey").value.trim();
        localStorage.setItem("geata_admin_api_key", apiKey);
        setStatus($("authStatus"), apiKey ? "API key saved" : "API key cleared", false);
      });

      $("authClearKey").addEventListener("click", ()=>{
        apiKey = "";
        $("authApiKey").value = "";
        localStorage.removeItem("geata_admin_api_key");
        setStatus($("authStatus"), "API key cleared", false);
      });

      $("bootstrapBtn").addEventListener("click", async ()=>{
        setStatus($("bootstrapStatus"), "Loading…", false);
        try{
          await loadDevices();
          await loadUsers(null);
          await loadSchedules();

          // fill selects used across screens
          fillDeviceSelect($("gatesSelect"), true, "-- Select a gate --");
          fillDeviceSelect($("eventsDevice"), true, "-- Any device --");
          fillUserSelect($("usersSelect"), allUsers);

          rebuildScheduleSelect($("usersScheduleSelect"));

          setStatus($("bootstrapStatus"), `Loaded: ${allDevices.length} devices, ${allUsers.length} users, ${allSchedules.length} schedules`, false);
        }catch(e){
          setStatus($("bootstrapStatus"), "Load failed: " + e.message, true);
        }
      });
    }

    // =========================
    // Users screen
    // =========================
    function resetUsersDeviceEditor(){
      $("usersDeviceSelect").innerHTML = `<option value="">-- Select a gate --</option>`;
      $("usersDeviceSelect").disabled = true;

      $("usersScheduleSelect").disabled = true;
      $("usersSaveScheduleBtn").disabled = true;

      setPanelChecked($("usersEmailPanel"), []);
      $("usersSaveEmailBtn").disabled = true;

      currentUserDeviceId = "";
      $("usersProfileJson").textContent = "";
    }

    async function loadAndRenderUserProfile(userId){
      currentUserId = userId || "";
      currentUserProfile = null;
      currentUserDeviceId = "";

      resetUsersDeviceEditor();

      if(!currentUserId){
        $("usersPickedUser").textContent = "(none)";
        $("usersPickedEmail").textContent = "(none)";
        $("usersPickedPhone").textContent = "(none)";
        return;
      }

      setStatus($("usersProfileStatus"), "Loading profile…", false);
      try{
        const profile = await loadUserProfile(currentUserId, {force:true});
        currentUserProfile = profile;

        // header info
        $("usersPickedUser").textContent = `${profile.user?.name || "(no name)"} [${profile.user?.id || currentUserId}]`;
        $("usersPickedEmail").textContent = profile.user?.email || "(none)";
        $("usersPickedPhone").textContent = profile.user?.phone || "(none)";

        // device select based on enrolled devices in profile
        const sel = $("usersDeviceSelect");
        sel.innerHTML = `<option value="">-- Select a gate --</option>`;
        const devs = Array.isArray(profile.devices) ? profile.devices : [];
        devs.forEach(d=>{
          const o = document.createElement("option");
          o.value = d.deviceId;
          o.textContent = d.deviceName ? `${d.deviceId} – ${d.deviceName}` : d.deviceId;
          sel.appendChild(o);
        });
        sel.disabled = false;

        // profile json
        $("usersProfileJson").textContent = JSON.stringify(profile, null, 2);

        setStatus($("usersProfileStatus"), "Profile loaded", false);
      }catch(e){
        setStatus($("usersProfileStatus"), "Profile load error: " + e.message, true);
      }
    }

    async function onUsersGateChanged(){
      const deviceId = $("usersDeviceSelect").value || "";
      currentUserDeviceId = deviceId;

      // clear statuses
      setStatus($("usersScheduleStatus"), "", false);
      setStatus($("usersEmailStatus"), "", false);

      // disable if missing
      if(!currentUserProfile || !currentUserId || !deviceId){
        $("usersScheduleSelect").disabled = true;
        $("usersSaveScheduleBtn").disabled = true;
        $("usersSaveEmailBtn").disabled = true;
        setPanelChecked($("usersEmailPanel"), []);
        return;
      }

      // enable editors
      $("usersScheduleSelect").disabled = false;
      $("usersSaveScheduleBtn").disabled = false;
      $("usersSaveEmailBtn").disabled = false;

      // set schedule select from profile
      const dev = getProfileDevice(currentUserProfile, deviceId);
      const scheduleId = dev?.scheduleId ? String(dev.scheduleId) : "";
      $("usersScheduleSelect").value = scheduleId;

      // set email checkboxes from profile
      const evs = dev?.notifications?.eventTypes || [];
      setPanelChecked($("usersEmailPanel"), evs);
    }

    function initUsers(){
      renderEventCheckboxPanel($("usersEmailPanel"), EMAIL_EVENT_TYPES);

      $("usersSearchBtn").addEventListener("click", async ()=>{
        const q = $("usersSearch").value.trim();
        setStatus($("usersListStatus"), "Searching…", false);
        try{
          await loadUsers(q || null);
          fillUserSelect($("usersSelect"), allUsers);
          setStatus($("usersListStatus"), `Found ${allUsers.length} users`, false);
        }catch(e){
          setStatus($("usersListStatus"), "Search error: " + e.message, true);
        }
      });

      $("usersShowAllBtn").addEventListener("click", async ()=>{
        $("usersSearch").value = "";
        setStatus($("usersListStatus"), "Loading…", false);
        try{
          await loadUsers(null);
          fillUserSelect($("usersSelect"), allUsers);
          setStatus($("usersListStatus"), `Loaded ${allUsers.length} users`, false);
        }catch(e){
          setStatus($("usersListStatus"), "Load error: " + e.message, true);
        }
      });

      $("usersLoadProfileBtn").addEventListener("click", async ()=>{
        const userId = $("usersSelect").value;
        await loadAndRenderUserProfile(userId);
      });

      $("usersSelect").addEventListener("change", async ()=>{
        // convenience: auto-load profile
        const userId = $("usersSelect").value;
        await loadAndRenderUserProfile(userId);
      });

      $("usersDeviceSelect").addEventListener("change", onUsersGateChanged);

      $("usersSaveScheduleBtn").addEventListener("click", async ()=>{
        if(!currentUserId || !currentUserDeviceId){
          setStatus($("usersScheduleStatus"), "Pick user + gate", true);
          return;
        }
        const scheduleId = $("usersScheduleSelect").value || null;
        setStatus($("usersScheduleStatus"), "Saving…", false);
        try{
          await apiJson(`/devices/${encodeURIComponent(currentUserDeviceId)}/users/${encodeURIComponent(currentUserId)}/schedule-assignment`, {
            method:"PUT",
            body: JSON.stringify({ scheduleId })
          });

          // refresh profile cache so UI stays correct
          currentUserProfile = await loadUserProfile(currentUserId, {force:true});
          $("usersProfileJson").textContent = JSON.stringify(currentUserProfile, null, 2);

          setStatus($("usersScheduleStatus"), "Saved schedule", false);
        }catch(e){
          setStatus($("usersScheduleStatus"), "Save error: " + e.message, true);
        }
      });

      $("usersSaveEmailBtn").addEventListener("click", async ()=>{
        if(!currentUserId || !currentUserDeviceId){
          setStatus($("usersEmailStatus"), "Pick user + gate", true);
          return;
        }
        const eventTypes = getPanelChecked($("usersEmailPanel"));
        setStatus($("usersEmailStatus"), "Saving…", false);
        try{
          await apiJson(`/devices/${encodeURIComponent(currentUserDeviceId)}/users/${encodeURIComponent(currentUserId)}/notifications`, {
            method:"PUT",
            body: JSON.stringify({ eventTypes })
          });

          // refresh profile cache so UI stays correct
          currentUserProfile = await loadUserProfile(currentUserId, {force:true});
          $("usersProfileJson").textContent = JSON.stringify(currentUserProfile, null, 2);

          setStatus($("usersEmailStatus"), "Saved email subscriptions", false);
        }catch(e){
          setStatus($("usersEmailStatus"), "Save error: " + e.message, true);
        }
      });
    }

    // =========================
    // Gates screen
    // =========================
    function getAux1ModePickedGate(){
      const picked = document.querySelector('input[name="aux1ModeGate"]:checked');
      return picked ? picked.value : "relay";
    }
    function setAux1ModeRadiosGate(mode){
      const m = mode ? String(mode) : "relay";
      document.querySelectorAll('input[name="aux1ModeGate"]').forEach(r=> r.checked = (r.value === m));
    }

    async function loadGateUsers(gateId){
      const tbody = document.querySelector("#gatesUsersTable tbody");
      tbody.innerHTML = "";
      if(!gateId) return;

      setStatus($("gatesUsersStatus"), "Loading users…", false);
      try{
        const list = await apiJson(`/devices/${encodeURIComponent(gateId)}/users`);
        (list || []).forEach(u=>{
          const tr = document.createElement("tr");

          // schedule select
          const scheduleSelect = document.createElement("select");
          scheduleSelect.innerHTML = `<option value="">24/7 (no schedule)</option>`;
          allSchedules.forEach(s=>{
            const o = document.createElement("option");
            o.value = String(s.id);
            o.textContent = s.name;
            scheduleSelect.appendChild(o);
          });
          if(u.scheduleId) scheduleSelect.value = String(u.scheduleId);

          const btnSaveSched = document.createElement("button");
          btnSaveSched.textContent = "Save";
          btnSaveSched.className = "";
          btnSaveSched.addEventListener("click", async ()=>{
            try{
              const scheduleId = scheduleSelect.value || null;
              await apiJson(`/devices/${encodeURIComponent(gateId)}/users/${encodeURIComponent(u.userId)}/schedule-assignment`, {
                method:"PUT",
                body: JSON.stringify({ scheduleId })
              });
              setStatus($("gatesUsersStatus"), "Saved schedule for user", false);
            }catch(e){
              setStatus($("gatesUsersStatus"), "Schedule save error: " + e.message, true);
            }
          });

          const tdSched = document.createElement("td");
          tdSched.appendChild(scheduleSelect);
          tdSched.appendChild(document.createElement("br"));
          tdSched.appendChild(btnSaveSched);

          const btnRemove = document.createElement("button");
          btnRemove.textContent = "Remove";
          btnRemove.className = "danger";
          btnRemove.addEventListener("click", async ()=>{
            if(!confirm(`Remove user ${u.userId} from gate ${gateId}?`)) return;
            try{
              await apiJson(`/devices/${encodeURIComponent(gateId)}/users/${encodeURIComponent(u.userId)}`, { method:"DELETE" });
              await loadGateUsers(gateId);
              setStatus($("gatesUsersStatus"), "Removed user", false);
            }catch(e){
              setStatus($("gatesUsersStatus"), "Remove error: " + e.message, true);
            }
          });

          tr.innerHTML = `
            <td>${u.userId || ""}</td>
            <td>${u.name || ""}</td>
            <td>${u.email || ""}</td>
            <td>${u.phone || ""}</td>
            <td>${u.role || ""}</td>
          `;
          tr.appendChild(tdSched);

          const tdRemove = document.createElement("td");
          tdRemove.appendChild(btnRemove);
          tr.appendChild(tdRemove);

          tbody.appendChild(tr);
        });

        setStatus($("gatesUsersStatus"), `Loaded ${list.length} users`, false);
      }catch(e){
        setStatus($("gatesUsersStatus"), "Load error: " + e.message, true);
      }
    }

    async function loadGateSettings(gateId){
      if(!gateId) return;
      setStatus($("gatesSettingsStatus"), "Loading settings…", false);
      try{
        const settings = await apiJson(`/devices/${encodeURIComponent(gateId)}/settings`);
        const mode = settings?.aux1Mode || "relay";
        setAux1ModeRadiosGate(mode);
        $("gatesSaveSettingsBtn").disabled = false;
        setStatus($("gatesSettingsStatus"), "Loaded settings", false);
      }catch(e){
        setStatus($("gatesSettingsStatus"), "Settings load error: " + e.message, true);
      }
    }

    async function saveGateSettings(gateId){
      if(!gateId) return;
      setStatus($("gatesSettingsStatus"), "Saving settings…", false);
      try{
        // keep it simple: write only aux1Mode
        const payload = { aux1Mode: getAux1ModePickedGate() };
        await apiJson(`/devices/${encodeURIComponent(gateId)}/settings`, {
          method:"PUT",
          body: JSON.stringify(payload)
        });
        setStatus($("gatesSettingsStatus"), "Saved settings", false);
      }catch(e){
        setStatus($("gatesSettingsStatus"), "Settings save error: " + e.message, true);
      }
    }

    async function ioPulse(gateId, path, durationMs, statusEl){
      if(!gateId){
        setStatus(statusEl, "Select a gate first", true);
        return;
      }
      try{
        await apiJson(`/devices/${encodeURIComponent(gateId)}/${path}`, {
          method:"POST",
          body: JSON.stringify({ durationMs })
        });
        setStatus(statusEl, `Triggered ${path} (${durationMs}ms)`, false);
      }catch(e){
        setStatus(statusEl, "I/O error: " + e.message, true);
      }
    }

    async function ioSim(gateId, type, alsoPulse=false){
      if(!gateId){
        setStatus($("gatesSimStatus"), "Select a gate first", true);
        return;
      }
      try{
        await apiJson(`/devices/${encodeURIComponent(gateId)}/simulate-event`, {
          method:"POST",
          body: JSON.stringify({ type })
        });
        if(alsoPulse){
          await apiJson(`/devices/${encodeURIComponent(gateId)}/aux2-test`, {
            method:"POST",
            body: JSON.stringify({ durationMs: 2000 })
          });
        }
        setStatus($("gatesSimStatus"), "Simulated " + type, false);
      }catch(e){
        setStatus($("gatesSimStatus"), "Sim error: " + e.message, true);
      }
    }

    function initGates(){
      $("gatesLoadBtn").addEventListener("click", async ()=>{
        const gateId = $("gatesSelect").value || "";
        currentGateId = gateId;
        $("gatesPickedGate").textContent = gateId || "(none)";
        setStatus($("gatesStatus"), "", false);
        setStatus($("gatesUsersStatus"), "", false);
        setStatus($("gatesSettingsStatus"), "", false);

        if(!gateId){
          setStatus($("gatesStatus"), "Select a gate", true);
          return;
        }

        setStatus($("gatesStatus"), "Loading gate data…", false);
        try{
          await loadGateUsers(gateId);
          await loadGateSettings(gateId);
          $("gatesSaveSettingsBtn").disabled = false;
          setStatus($("gatesStatus"), "Gate loaded", false);
        }catch(e){
          setStatus($("gatesStatus"), "Load error: " + e.message, true);
        }
      });

      $("gatesLoadSettingsBtn").addEventListener("click", async ()=>{
        const gateId = $("gatesSelect").value || "";
        currentGateId = gateId;
        if(!gateId){ setStatus($("gatesSettingsStatus"), "Select a gate", true); return; }
        await loadGateSettings(gateId);
      });

      $("gatesSaveSettingsBtn").addEventListener("click", async ()=>{
        const gateId = $("gatesSelect").value || "";
        currentGateId = gateId;
        if(!gateId){ setStatus($("gatesSettingsStatus"), "Select a gate", true); return; }
        await saveGateSettings(gateId);
      });

      $("gatesAux1PulseBtn").addEventListener("click", ()=>{
        const gateId = $("gatesSelect").value || "";
        ioPulse(gateId, "aux1-test", 1000, $("gatesIoStatus"));
      });
      $("gatesAux2PulseBtn").addEventListener("click", ()=>{
        const gateId = $("gatesSelect").value || "";
        ioPulse(gateId, "aux2-test", 2000, $("gatesIoStatus"));
      });

      $("simGateOpenedBtn").addEventListener("click", ()=>{
        const gateId = $("gatesSelect").value || "";
        ioSim(gateId, "GATE_OPENED");
      });
      $("simGateClosedBtn").addEventListener("click", ()=>{
        const gateId = $("gatesSelect").value || "";
        ioSim(gateId, "GATE_CLOSED");
      });
      $("simForcedBtn").addEventListener("click", ()=>{
        const gateId = $("gatesSelect").value || "";
        ioSim(gateId, "GATE_FORCED_OPEN");
      });
      $("simTamperBtn").addEventListener("click", ()=>{
        const gateId = $("gatesSelect").value || "";
        ioSim(gateId, "TAMPER_OPENED", true);
      });
    }

    // =========================
    // Schedules screen
    // =========================
    async function renderSchedules(){
      const tbody = document.querySelector("#schedTable tbody");
      tbody.innerHTML = "";
      allSchedules.forEach(s=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${s.id}</td>
          <td>${s.name || ""}</td>
          <td>${s.description || ""}</td>
          <td>${describeSlots(s.slots || [])}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function initSchedules(){
      $("schedRefreshBtn").addEventListener("click", async ()=>{
        setStatus($("schedStatus"), "Loading…", false);
        try{
          await loadSchedules();
          await renderSchedules();
          // keep other schedule selects in sync
          rebuildScheduleSelect($("usersScheduleSelect"));
          setStatus($("schedStatus"), `Loaded ${allSchedules.length} schedules`, false);
        }catch(e){
          setStatus($("schedStatus"), "Load error: " + e.message, true);
        }
      });
    }

    // =========================
    // Events screen
    // =========================
    async function loadEvents(){
      const tbody = document.querySelector("#eventsTable tbody");
      tbody.innerHTML = "";
      setStatus($("eventsStatus"), "Loading…", false);

      const deviceId = $("eventsDevice").value || "";
      const limit = Math.max(10, Math.min(5000, parseInt($("eventsLimit").value || "200", 10)));

      const qs = new URLSearchParams();
      if(deviceId) qs.set("deviceId", deviceId);
      qs.set("limit", String(limit));

      try{
        const rows = await apiJson("/events?" + qs.toString());
        (rows || []).forEach(ev=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${ev.at || ""}</td>
            <td>${(ev.device_id || "")}${ev.device_name ? " – " + ev.device_name : ""}</td>
            <td>${[ev.user_name, ev.user_phone, ev.user_id ? "[" + ev.user_id + "]" : ""].filter(Boolean).join(" | ")}</td>
            <td>${ev.event_type || ""}</td>
            <td>${ev.details || ""}</td>
          `;
          tbody.appendChild(tr);
        });
        setStatus($("eventsStatus"), `Loaded ${rows.length} events`, false);
      }catch(e){
        setStatus($("eventsStatus"), "Load error: " + e.message, true);
      }
    }

    function initEvents(){
      $("eventsLoadBtn").addEventListener("click", loadEvents);
    }

    // =========================
    // Wiring nav
    // =========================
    function initNav(){
      document.querySelectorAll(".navbtn").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          showScreen(btn.dataset.screen);
        });
      });
    }

    // =========================
    // Initial load
    // =========================
    window.addEventListener("load", async ()=>{
      initNav();
      initAuth();
      initUsers();
      initGates();
      initSchedules();
      initEvents();

      // Pre-render checkbox panels
      renderEventCheckboxPanel($("usersEmailPanel"), EMAIL_EVENT_TYPES);

      // attempt to load if key already present
      if(apiKey){
        try{
          await loadDevices();
          await loadUsers(null);
          await loadSchedules();

          fillDeviceSelect($("gatesSelect"), true, "-- Select a gate --");
          fillDeviceSelect($("eventsDevice"), true, "-- Any device --");
          fillUserSelect($("usersSelect"), allUsers);
          rebuildScheduleSelect($("usersScheduleSelect"));
          await renderSchedules();

          setStatus($("bootstrapStatus"), `Loaded: ${allDevices.length} devices, ${allUsers.length} users, ${allSchedules.length} schedules`, false);
        }catch(e){
          setStatus($("bootstrapStatus"), "Auto-load failed (check API key): " + e.message, true);
        }
      }
    });
  </script>
</body>
</html>
