<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Geata Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg-main: #cfdfee;
      --bg-card: #0b2535;
      --bg-card-soft: #123653;
      --accent: #1c5e86;
      --accent-dark: #1c5e86;
      --accent-soft: rgba(28, 94, 134, 0.2);
      --danger: #d9534f;
      --text-main: #f5f7fa;
      --text-muted: #7b8a9b;
      --whitebox: rgba(255,255,255,0.95);
    }

    * { box-sizing: border-box; }
	
	/* Email/IO event checkbox panel (blue + aligned) */
.event-panel {
  background: var(--bg-card-soft);
  border: 1px solid rgba(255,255,255,0.10);
  border-radius: 12px;
  padding: 10px 12px;
}

.event-row {
  display: grid;
  grid-template-columns: 26px 1fr;  /* checkbox column + text column */
  align-items: center;
  gap: 10px;
  padding: 6px 2px;
  border-bottom: 1px solid rgba(255,255,255,0.08);
}

.event-row:last-child {
  border-bottom: none;
}

.event-row input[type="checkbox"] {
  width: 16px;
  height: 16px;
  margin: 0;
  justify-self: start; /* hard left */
}

.event-row span {
  color: var(--text-main);
  font-size: 13px;
  line-height: 1.2;
}


    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #1e3f5d 0, var(--bg-main) 45%, #b3cde5 100%);
      color: var(--text-main);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px 16px 40px;
    }

    h1 {
      margin: 0 0 12px;
      font-size: 26px;
      letter-spacing: 0.04em;
    }

    .subtitle {
      margin: 0 0 20px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .card {
      background: var(--bg-card);
      color: var(--text-main);
      border-radius: 14px;
      padding: 14px 16px 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.18);
      margin-bottom: 16px;
      border: 1px solid rgba(255,255,255,0.08);
    }

    .card-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      margin-bottom: 8px;
      gap: 10px;
      flex-wrap: wrap;
    }

    .card-title {
      margin: 0;
      font-size: 18px;
      letter-spacing: 0.02em;
    }

    .card-subtitle {
      margin: 0;
      font-size: 12px;
      color: #2e7d32;
    }

    .pill-title {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent-dark);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 6px;
    }

    label {
      display: block;
      margin-bottom: 4px;
      font-size: 13px;
      font-weight: 500;
      color: #e3f2fd;
    }

    input, select, textarea {
      padding: 7px 9px;
      margin-bottom: 8px;
      border-radius: 8px;
      border: 1px solid #ccd2dd;
      font-size: 13px;
      width: 100%;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent-dark);
      box-shadow: 0 0 0 1px rgba(0, 123, 255, 0.35);
    }

    textarea { min-height: 140px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }

    button {
      padding: 7px 11px;
      border-radius: 999px;
      border: none;
      background: var(--accent-dark);
      color: #fff;
      font-size: 13px;
      cursor: pointer;
      margin-right: 6px;
      margin-bottom: 6px;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    button.btn-secondary { background: #345a77; }
    button.btn-danger { background: var(--danger); }

    button[disabled] {
      opacity: 0.5;
      cursor: default;
    }

    .btn-small { font-size: 12px; padding: 5px 9px; }

    .status {
      font-size: 12px;
      min-height: 16px;
      margin-top: 4px;
    }

    .status.error { color: #b00020; }
    .status.ok { color: #ffb300; }

    .small { font-size: 12px; color: #b8d7ff; }
    .small-green { font-size: 12px; color: #2e7d32; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      table-layout: auto;
      min-width: 650px;
      background: var(--bg-card-soft);
      border-radius: 10px;
      overflow: hidden;
    }

    th, td {
      border: 1px solid #2a4358;
      padding: 6px;
      text-align: left;
      vertical-align: top;
    }

    th { background: #17405f; font-weight: 600; }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--accent-soft);
      font-size: 11px;
      margin-right: 4px;
      margin-bottom: 4px;
      color: var(--text-main);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .two-column {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }

    @media (max-width: 900px) {
      .two-column { grid-template-columns: 1fr; }
      table { min-width: 0; }
    }

    .section-divider {
      height: 1px;
      margin: 10px 0 12px;
      background: linear-gradient(to right, rgba(255,255,255,0.12), rgba(0,0,0,0));
    }

    .screen { display: none; }
    .screen.active { display: block; }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 14px;
      flex-wrap: wrap;
    }

    .topbar-left, .topbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .home-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }

    @media (max-width: 900px) {
      .home-grid { grid-template-columns: 1fr; }
    }

    .home-btn {
      width: 100%;
      justify-content: center;
      padding: 16px 14px;
      font-size: 14px;
      border-radius: 14px;
      background: #17405f;
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 12px 30px rgba(0,0,0,0.16);
    }

    .home-btn:hover { filter: brightness(1.05); }

    #deviceContextBar { display: none; margin-bottom: 14px; }
    #deviceContextBar.active { display: block; }

    .device-label-big {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #ECFEFF;
    }

    .device-label-value {
      font-size: 13px;
      color: #e3f2fd;
    }

    .view-mode input[readonly],
    .view-mode textarea[readonly],
    .view-mode select[disabled] {
      background: var(--whitebox);
    }

    .whitebox {
      background: var(--whitebox);
      color: #122b3a;
      border-radius: 10px;
      padding: 10px 12px;
      border: 1px solid rgba(0,0,0,0.12);
      margin: 8px 0 10px;
    }

    .whitebox .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .whitebox code { font-size: 12px; }

    .inline-actions {
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      margin-top: 6px;
    }
  </style>
</head>

<body>
  <div class="container">

    <div id="homeHeader">
      <h1>Geata Admin Panel</h1>
      <p class="subtitle">Home ‚Üí choose a section. All admin actions require a valid Admin API key.</p>
    </div>

    <!-- DEVICE CONTEXT BAR: only for Select Devices & Users page -->
    <div id="deviceContextBar" class="card">
      <div class="card-header">
        <div>
          <div class="pill-title">Device Context</div>
          <h2 class="card-title">Select Device (for this page only)</h2>
          <p class="card-subtitle">Used by ‚ÄúSelect Devices & Users‚Äù only (other pages have their own selectors).</p>
        </div>
      </div>

      <label for="selectedDeviceSelect" style="font-size: 14px;">Select Device</label>
      <select id="selectedDeviceSelect">
        <option value="">-- Select a device --</option>
      </select>

      <div class="device-label-big">
        Current Device:
        <span id="selectedDeviceText" class="device-label-value">None selected</span>
      </div>
    </div>

    <!-- HOME -->
    <section id="screen-home" class="screen active">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="pill-title">Home</div>
            <h2 class="card-title">Admin Sections</h2>
            <p class="card-subtitle">Each section opens on its own page.</p>
          </div>
        </div>

        <div class="home-grid">
          <button class="home-btn" data-nav="screen-auth">Admin Authentication</button>
          <button class="home-btn" data-nav="screen-devices">Devices</button>
          <button class="home-btn" data-nav="screen-device-users">Select Devices & Users</button>
          <button class="home-btn" data-nav="screen-device-settings">Device Settings</button>
          <button class="home-btn" data-nav="screen-io">Device I/O Test (Engineer)</button>
          <button class="home-btn" data-nav="screen-directory">User Lookup (All Users)</button>
          <button class="home-btn" data-nav="screen-edit-user">Edit User Details</button>
          <button class="home-btn" data-nav="screen-attach-user">Add User to Device</button>
          <button class="home-btn" data-nav="screen-csv">Import/Export</button>
          <button class="home-btn" data-nav="screen-schedules">Schedules</button>
          <button class="home-btn" data-nav="screen-emails">Email Notifications</button>
          <button class="home-btn" data-nav="screen-reports">Reports/Audit Trail</button>
          <button class="home-btn" data-nav="screen-logs">Logs</button>
          <button class="home-btn" data-nav="screen-events">Recent Events</button>
        </div>

        <div class="section-divider"></div>
        <div class="small-green">
          Suggested flow: Admin Authentication ‚Üí Devices ‚Üí Select Devices & Users ‚Üí Email Notifications.
        </div>
      </div>
    </section>

    <!-- AUTH -->
    <section id="screen-auth" class="screen">
      <div class="topbar">
        <div class="topbar-left">
          <button class="btn-secondary btn-small" data-back>‚Üê Back</button>
          <button class="btn-secondary btn-small" data-home>üè† Home</button>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="pill-title">Security</div>
            <h2 class="card-title">Admin Authentication</h2>
          </div>
        </div>

        <label for="apiKeyInput">Admin API Key</label>
        <input id="apiKeyInput" type="text" placeholder="Enter admin API key" />
        <button id="setApiKeyBtn">Save Key</button>
        <button id="clearApiKeyBtn" class="btn-secondary btn-small">Clear</button>
        <div id="apiKeyStatus" class="status"></div>

        <div class="small">
          Stored locally in your browser for convenience (does not affect server env vars).
        </div>
      </div>
    </section>

    <!-- DEVICES -->
    <section id="screen-devices" class="screen">
      <div class="topbar">
        <div class="topbar-left">
          <button class="btn-secondary btn-small" data-back>‚Üê Back</button>
          <button class="btn-secondary btn-small" data-home>üè† Home</button>
        </div>
        <div class="topbar-right">
          <button id="refreshDevicesBtn" class="btn-secondary btn-small">Refresh</button>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="pill-title">Gates</div>
            <h2 class="card-title">Devices</h2>
            <p class="card-subtitle">List and register gate controllers.</p>
          </div>
        </div>

        <div id="devicesStatus" class="status"></div>

        <table id="devicesTable">
          <thead>
            <tr>
              <th>Device ID</th>
              <th>Name</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="section-divider"></div>

        <h3 style="margin-top: 6px; font-size: 15px;">Add Device</h3>
        <div class="two-column">
          <div>
            <label for="newDeviceId">Device ID</label>
            <input id="newDeviceId" type="text" placeholder="e.g. gate1" />
          </div>
          <div>
            <label for="newDeviceName">Name</label>
            <input id="newDeviceName" type="text" placeholder="e.g. Warehouse Gate" />
          </div>
        </div>

        <button id="addDeviceBtn">Save</button>
        <div id="addDeviceStatus" class="status"></div>

        <div class="small">
          After saving, the Add Device form resets for the next entry.
        </div>
      </div>
    </section>

    <!-- SELECT DEVICES & USERS -->
    <section id="screen-device-users" class="screen" data-show-context="true">
      <div class="topbar">
        <div class="topbar-left">
          <button class="btn-secondary btn-small" data-back>‚Üê Back</button>
          <button class="btn-secondary btn-small" data-home>üè† Home</button>
        </div>
        <div class="topbar-right">
          <button id="refreshDeviceUsersBtn" class="btn-secondary btn-small">Refresh</button>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="pill-title">Per Gate</div>
            <h2 class="card-title">Users on Selected Device</h2>
            <p class="card-subtitle">Choose a gate in the Device Context bar, then manage users on that gate.</p>
          </div>
        </div>

        <div class="device-label-big">
          Current Device:
          <span id="selectedDeviceTextUsers" class="device-label-value">None selected</span>
        </div>

        <div id="deviceUsersStatus" class="status"></div>

        <table id="deviceUsersTable">
          <thead>
            <tr>
              <th>User ID</th>
              <th>Name</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Role</th>
              <th>Schedule / Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="small">
          ‚ÄúEdit‚Äù opens the Edit User Details page (shows enrolled devices + email subscriptions link).
        </div>
      </div>
    </section>

    <!-- DEVICE SETTINGS -->
    <section id="screen-device-settings" class="screen">
      <div class="topbar">
        <div class="topbar-left">
          <button class="btn-secondary btn-small" data-back>‚Üê Back</button>
          <button class="btn-secondary btn-small" data-home>üè† Home</button>
        </div>
        <div class="topbar-right">
          <button id="deviceSettingsEditBtn" class="btn-secondary btn-small">Edit</button>
          <button id="deviceSettingsSaveBtn" class="btn-small" disabled>Save</button>
        </div>
      </div>

      <div id="deviceSettingsCard" class="card view-mode">
        <div class="card-header">
          <div>
            <div class="pill-title">Config</div>
            <h2 class="card-title">Device Settings</h2>
            <p class="card-subtitle">This page has its own device selector (independent of Select Devices & Users).</p>
          </div>
        </div>

        <label for="deviceSettingsSelect">Select Device</label>
        <select id="deviceSettingsSelect">
          <option value="">-- Select a device --</option>
        </select>

        <button id="deviceSettingsLoadBtn" class="btn-secondary btn-small">Load</button>
        <div id="deviceSettingsStatus" class="status"></div>

        <div class="whitebox" id="aux1ModePanel">
          <div class="pill-title">AUX 1 Function</div>

          <label style="margin-top:8px; color:#122b3a;">
            <input type="radio" name="aux1Mode" value="relay" />
            Relay On/Off (single gate) ‚Äî AUX1 acts as a simple switch output
          </label>

          <label style="margin-top:8px; color:#122b3a;">
            <input type="radio" name="aux1Mode" value="gate2" />
            Gate2 monitor (two gates) ‚Äî Input 2 is used to monitor pedestrian gate status
          </label>

          <div class="small" style="margin-top:8px; color:#1c3b4f;">
            ‚ÄúRelay On/Off‚Äù = app shows ON persistently when enabled. <br/>
            ‚ÄúGate2 monitor‚Äù = app uses Input2 like Input1 (Opened/Closed/Forced/Ajar) for the second gate.
          </div>
        </div>

        <label for="deviceSettingsJson">Settings JSON</label>
        <textarea id="deviceSettingsJson" readonly placeholder="Click Load, then Edit to change..."></textarea>

        <div class="small">
          Uses backend endpoints: <code>GET/PUT /devices/:deviceId/settings</code>.
        </div>
      </div>
    </section>

    <!-- DEVICE I/O TEST (Engineer) -->
    <section id="screen-io" class="screen">
      <div class="topbar">
        <div class="topbar-left">
          <button class="btn-secondary btn-small" data-back>‚Üê Back</button>
          <button class="btn-secondary btn-small" data-home>üè† Home</button>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="pill-title">Engineer</div>
            <h2 class="card-title">Device I/O Test</h2>
            <p class="card-subtitle">Admin/Engineer use. Choose device + user for subscription test.</p>
          </div>
        </div>

        <div class="two-column">
          <div>
            <label for="ioDeviceSelect">Select Device</label>
            <select id="ioDeviceSelect">
              <option value="">-- Select a device --</option>
            </select>
          </div>
          <div>
            <label for="ioUserSelect">Select Enrolled User</label>
            <select id="ioUserSelect">
              <option value="">-- Select a user --</option>
            </select>
          </div>
        </div>

        <button id="ioLoadSubsBtn" class="btn-secondary btn-small">Load Subscriptions</button>
        <div id="ioStatus" class="status"></div>

        <div class="section-divider"></div>

        <h3 style="margin: 4px 0 6px; font-size: 15px;">Email Subscriptions (for selected Device + User)</h3>
        <div class="device-label-big">Event Types</div>
        <div id="ioEventTypesPanel"></div>

        <button id="ioSaveSubsBtn" class="btn-small">Save</button>

        <div class="small">
          Uses backend: <code>GET /devices/:deviceId/notifications</code> and <code>PUT /devices/:deviceId/users/:userId/notifications</code>.
        </div>

        <div class="section-divider"></div>

        <h3 style="margin: 4px 0 6px; font-size: 15px;">Outputs</h3>
        <button id="ioAux1PulseBtn" class="btn-secondary btn-small">AUX1 Pulse (1s)</button>
        <button id="ioOutput3PulseBtn" class="btn-secondary btn-small">Output 3 Pulse (2s)</button>
        <div id="ioOutputStatus" class="status"></div>

        <div class="small">
          AUX pulses use <code>/aux1-test</code> and <code>/aux2-test</code> (admin-only endpoints).
        </div>

        <div class="section-divider"></div>

        <h3 style="margin: 4px 0 6px; font-size: 15px;">Simulate Gate Events (to trigger emails if subscribed)</h3>
        <button id="simOpenRequestedBtn" class="btn-small">Sim OPEN_REQUESTED</button>
        <button id="simGateOpenedBtn" class="btn-small">Sim GATE_OPENED</button>
        <button id="simGateClosedBtn" class="btn-small">Sim GATE_CLOSED</button>
        <button id="simForcedBtn" class="btn-small">Sim GATE_FORCED_OPEN</button>
        <button id="simDoorForcedBtn" class="btn-small">Sim DOOR_FORCED_OPEN</button>
        <button id="simAjarBtn" class="btn-small">Sim GATE_OPEN_TOO_LONG</button>
        <button id="simTamperBtn" class="btn-small">Sim TAMPER_OPENED (+Output3 2s)</button>
        <div id="ioSimStatus" class="status"></div>

        <div class="small">
          Uses <code>POST /devices/:deviceId/simulate-event</code>.
        </div>
      </div>
    </section>

    <!-- USER LOOKUP (All) -->
    <section id="screen-directory" class="screen">
      <div class="topbar">
        <div class="topbar-left">
          <button class="btn-secondary btn-small" data-back>‚Üê Back</button>
          <button class="btn-secondary btn-small" data-home>üè† Home</button>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="pill-title">Directory</div>
            <h2 class="card-title">User Lookup (All Users)</h2>
            <p class="card-subtitle">Search by name, email, phone, or UID. Not restricted to any gate.</p>
          </div>
        </div>

        <label for="userSearchInput">Search</label>
        <input id="userSearchInput" type="text" placeholder="name / email / phone / uid (e.g. u_1765...)" />
        <button id="searchUsersBtn">Search</button>
        <button id="showAllUsersBtn" class="btn-secondary btn-small">Show All</button>
        <div id="userSearchStatus" class="status"></div>

        <div class="section-divider"></div>

        <label for="directoryDeviceSelect">Attach selected users to device</label>
        <select id="directoryDeviceSelect">
          <option value="">-- Select a device --</option>
        </select>
        <button id="attachSelectedUsersBtn" class="btn-secondary btn-small">Attach Selected Users</button>

        <table id="globalUsersTable">
          <thead>
            <tr>
              <th>Select</th>
              <th>User ID</th>
              <th>Name</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Devices (gate(role))</th>
              <th>Edit</th>
              <th>Delete</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="small">
          Edit jumps to Edit User Details (shows enrolled devices + subscription link).
        </div>
      </div>
    </section>

    <!-- EDIT USER DETAILS -->
    <section id="screen-edit-user" class="screen">
      <div class="topbar">
        <div class="topbar-left">
          <button class="btn-secondary btn-small" data-back>‚Üê Back</button>
          <button class="btn-secondary btn-small" data-home>üè† Home</button>
        </div>
        <div class="topbar-right">
          <button id="editUserEnableBtn" class="btn-secondary btn-small">Edit</button>
          <button id="editUserSaveTopBtn" class="btn-small" disabled>Save</button>
        </div>
      </div>

      <div id="editUserCard" class="card view-mode">
        <div class="card-header">
          <div>
            <div class="pill-title">Directory</div>
            <h2 class="card-title">Edit User Details</h2>
            <p class="card-subtitle">Shows user ID and enrolled devices. Includes Email Notifications link.</p>
          </div>
        </div>

        <div class="whitebox">
          <div class="row">
            <div><strong>User ID:</strong></div>
            <code id="editUserIdBox">(none)</code>
          </div>
        </div>

        <div class="two-column">
          <div>
            <label for="editUserName">Name</label>
            <input id="editUserName" type="text" disabled />
          </div>
          <div>
            <label for="editUserEmail">Email</label>
            <input id="editUserEmail" type="email" disabled />
          </div>
        </div>

        <div class="two-column">
          <div>
            <label for="editUserPhone">Phone</label>
            <input id="editUserPhone" type="tel" disabled />
          </div>
          <div>
            <label for="editUserPassword">Password</label>
            <input id="editUserPassword" type="password" placeholder="Leave blank to keep existing" disabled />
          </div>
        </div>

        <div class="section-divider"></div>

        <div class="device-label-big">Enrolled Devices</div>
        <div id="editUserDevicesPills"></div>

        <div class="section-divider"></div>

        <label for="editUserEmailDeviceSelect">Email Notifications: choose one of this user‚Äôs gates</label>
        <select id="editUserEmailDeviceSelect">
          <option value="">-- Select one of the user‚Äôs devices --</option>
        </select>
        <button id="openEmailNotificationsBtn" class="btn-secondary btn-small">Open Email Notifications for this User</button>

        <div id="editUserStatus" class="status"></div>
      </div>
    </section>

    <!-- ADD USER TO DEVICE -->
    <section id="screen-attach-user" class="screen">
      <div class="topbar">
        <div class="topbar-left">
          <button class="btn-secondary btn-small" data-back>‚Üê Back</button>
          <button class="btn-secondary btn-small" data-home>üè† Home</button>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="pill-title">Per Gate</div>
            <h2 class="card-title">Add User to Device</h2>
            <p class="card-subtitle">Device is selectable here (not restricted to Select Devices & Users).</p>
          </div>
        </div>

        <label for="attachDeviceSelect">Select Device</label>
        <select id="attachDeviceSelect">
          <option value="">-- Select a device --</option>
        </select>

        <p class="small">
          Option 1: enter phone/email to create or reuse a user.<br />
          Option 2: paste an existing <strong>User ID</strong> to attach.
        </p>

        <div class="two-column">
          <div>
            <label for="userNameInput">Name</label>
            <input id="userNameInput" type="text" placeholder="User name" />
          </div>
          <div>
            <label for="userEmailInput">Email</label>
            <input id="userEmailInput" type="email" placeholder="user@example.com" />
          </div>
        </div>

        <div class="two-column">
          <div>
            <label for="userPhoneInput">Phone</label>
            <input id="userPhoneInput" type="tel" placeholder="0861234567 or +353861234567" />
          </div>
          <div>
            <label for="userPasswordInput">Password</label>
            <input id="userPasswordInput" type="password" placeholder="Set/overwrite password (optional)" />
          </div>
        </div>

        <div class="two-column">
          <div>
            <label for="userRoleSelect">Role</label>
            <select id="userRoleSelect">
              <option value="operator">operator</option>
              <option value="admin">admin</option>
            </select>
          </div>
          <div>
            <label for="existingUserIdInput">Existing User ID (optional)</label>
            <input id="existingUserIdInput" type="text" placeholder="e.g. u_1765..." />
          </div>
        </div>

        <label for="attachUserScheduleSelect">Schedule</label>
        <select id="attachUserScheduleSelect">
          <option value="">24/7 (no schedule)</option>
        </select>

        <button id="attachUserBtn">Save</button>
        <div id="attachUserStatus" class="status"></div>

        <div class="small">
          After saving, the form resets for the next entry.
        </div>
      </div>
    </section>

    <!-- IMPORT/EXPORT -->
    <section id="screen-csv" class="screen">
      <div class="topbar">
        <div class="topbar-left">
          <button class="btn-secondary btn-small" data-back>‚Üê Back</button>
          <button class="btn-secondary btn-small" data-home>üè† Home</button>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="pill-title">Data</div>
            <h2 class="card-title">Import / Export (CSV)</h2>
            <p class="card-subtitle">Choose device here (independent).</p>
          </div>
        </div>

        <label for="csvDeviceSelect">Select Device</label>
        <select id="csvDeviceSelect">
          <option value="">-- Select a device --</option>
        </select>

        <div class="section-divider"></div>

        <div class="two-column">
          <div>
            <h3 style="margin: 4px 0 6px; font-size: 14px;">Bulk Import from CSV</h3>
            <p class="small">
              CSV columns: <code>name,email,phone,role</code>.
            </p>
            <input type="file" id="csvFileInput" accept=".csv,text/csv" />
            <button id="importCsvBtn" class="btn-secondary btn-small">Save (Import)</button>
          </div>

          <div>
            <h3 style="margin: 4px 0 6px; font-size: 14px;">Export to CSV</h3>
            <button id="exportCsvDeviceBtn" class="btn-secondary btn-small">Export Users on Selected Device</button>
            <button id="exportAllCsvBtn" class="btn-secondary btn-small">Export All Users &amp; Gates</button>
          </div>
        </div>

        <div id="csvImportStatus" class="status"></div>
      </div>
    </section>

    <!-- SCHEDULES -->
    <section id="screen-schedules" class="screen">
      <div class="topbar">
        <div class="topbar-left">
          <button class="btn-secondary btn-small" data-back>‚Üê Back</button>
          <button class="btn-secondary btn-small" data-home>üè† Home</button>
        </div>
        <div class="topbar-right">
          <button id="refreshSchedulesBtn" class="btn-secondary btn-small">Refresh</button>
          <button id="scheduleEnableBtn" class="btn-secondary btn-small">Edit</button>
          <button id="scheduleSaveTopBtn" class="btn-small" disabled>Save</button>
        </div>
      </div>

      <div id="scheduleCard" class="card view-mode">
        <div class="card-header">
          <div>
            <div class="pill-title">Time</div>
            <h2 class="card-title">Schedules</h2>
            <p class="card-subtitle">Create/edit a schedule, then assign it to users per gate.</p>
          </div>
        </div>

        <div id="scheduleStatus" class="status"></div>

        <table id="schedulesTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Slots</th>
              <th>Edit</th>
              <th>Delete</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="section-divider"></div>

        <h3 id="scheduleFormTitle" style="margin-top: 4px; font-size: 15px;">Create / Edit Schedule</h3>

        <label for="scheduleNameInput">Schedule Name</label>
        <input id="scheduleNameInput" type="text" placeholder="e.g. Weekdays 9‚Äì5" disabled />

        <label for="scheduleDescInput">Description (optional)</label>
        <input id="scheduleDescInput" type="text" placeholder="Short description" disabled />

        <p class="small">
          Days: 0‚Äì6 for Sun‚ÄìSat. Use ranges <code>1-5</code> or lists <code>1,2,3</code>. Blank days = all days.
        </p>

        <table>
          <thead>
            <tr>
              <th>Slot</th>
              <th>Days (0‚Äì6)</th>
              <th>Start</th>
              <th>End</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>1</td><td><input id="slot1Days" type="text" disabled /></td><td><input id="slot1Start" type="time" disabled /></td><td><input id="slot1End" type="time" disabled /></td>
            </tr>
            <tr>
              <td>2</td><td><input id="slot2Days" type="text" disabled /></td><td><input id="slot2Start" type="time" disabled /></td><td><input id="slot2End" type="time" disabled /></td>
            </tr>
            <tr>
              <td>3</td><td><input id="slot3Days" type="text" disabled /></td><td><input id="slot3Start" type="time" disabled /></td><td><input id="slot3End" type="time" disabled /></td>
            </tr>
            <tr>
              <td>4</td><td><input id="slot4Days" type="text" disabled /></td><td><input id="slot4Start" type="time" disabled /></td><td><input id="slot4End" type="time" disabled /></td>
            </tr>
            <tr>
              <td>5</td><td><input id="slot5Days" type="text" disabled /></td><td><input id="slot5Start" type="time" disabled /></td><td><input id="slot5End" type="time" disabled /></td>
            </tr>
            <tr>
              <td>6</td><td><input id="slot6Days" type="text" disabled /></td><td><input id="slot6Start" type="time" disabled /></td><td><input id="slot6End" type="time" disabled /></td>
            </tr>
          </tbody>
        </table>

        <button id="resetScheduleFormBtn" class="btn-secondary btn-small">Reset Form</button>

        <div class="small">
          After Save, the form resets for the next schedule.
        </div>
      </div>
    </section>

    <!-- EMAIL NOTIFICATIONS -->
    <section id="screen-emails" class="screen">
      <div class="topbar">
        <div class="topbar-left">
          <button class="btn-secondary btn-small" data-back>‚Üê Back</button>
          <button class="btn-secondary btn-small" data-home>üè† Home</button>
        </div>
        <div class="topbar-right">
          <button id="emailRefreshBtn" class="btn-secondary btn-small">Refresh</button>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="pill-title">Emails</div>
            <h2 class="card-title">Email Notifications</h2>
            <p class="card-subtitle">Pick a user + one of their devices.</p>
          </div>
        </div>

        <div class="two-column">
          <div>
            <label for="emailUserSelect">Select User</label>
            <select id="emailUserSelect">
              <option value="">-- Select a user --</option>
            </select>
          </div>
          <div>
            <label for="emailDeviceSelect">Select Device</label>
            <select id="emailDeviceSelect">
              <option value="">-- Select a device --</option>
            </select>
          </div>
        </div>

        <button id="emailLoadBtn" class="btn-secondary btn-small">Load</button>
        <div id="emailStatus" class="status"></div>

        <div class="section-divider"></div>

        <div class="device-label-big">Event Types</div>
        <div id="emailEventTypesPanel"></div>

        <button id="emailSaveBtn" class="btn-small">Save</button>

        <div class="small">
          Uses backend: <code>GET /devices/:deviceId/notifications</code> and <code>PUT /devices/:deviceId/users/:userId/notifications</code>.
        </div>
      </div>
    </section>

    <!-- REPORTS -->
    <section id="screen-reports" class="screen">
      <div class="topbar">
        <div class="topbar-left">
          <button class="btn-secondary btn-small" data-back>‚Üê Back</button>
          <button class="btn-secondary btn-small" data-home>üè† Home</button>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="pill-title">Audit</div>
            <h2 class="card-title">Reports / Audit Trail</h2>
          </div>
        </div>

        <div class="two-column">
          <div>
            <label for="reportDeviceSelect">Device</label>
            <select id="reportDeviceSelect">
              <option value="">-- Any device --</option>
            </select>
          </div>
          <div>
            <label for="reportUserIdInput">User ID (optional)</label>
            <input id="reportUserIdInput" type="text" placeholder="u_..." />
          </div>
        </div>

        <div class="two-column">
          <div>
            <label for="reportFromDate">From date</label>
            <input id="reportFromDate" type="date" />
          </div>
          <div>
            <label for="reportToDate">To date</label>
            <input id="reportToDate" type="date" />
          </div>
        </div>

        <button id="runReportBtn">Run</button>
        <button id="downloadReportCsvBtn" class="btn-secondary btn-small">Download CSV</button>
        <div id="reportStatus" class="status"></div>

        <table id="reportEventsTable">
          <thead>
            <tr>
              <th>Time (UTC)</th>
              <th>Device</th>
              <th>User</th>
              <th>Event</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- LOGS -->
    <section id="screen-logs" class="screen">
      <div class="topbar">
        <div class="topbar-left">
          <button class="btn-secondary btn-small" data-back>‚Üê Back</button>
          <button class="btn-secondary btn-small" data-home>üè† Home</button>
        </div>
        <div class="topbar-right">
          <button id="logsReloadBtn" class="btn-secondary btn-small">Refresh</button>
          <button id="logsEditBtn" class="btn-secondary btn-small">Edit</button>
          <button id="logsSaveBtn" class="btn-small" disabled>Save</button>
        </div>
      </div>

      <div id="logsCard" class="card view-mode">
        <div class="card-header">
          <div>
            <div class="pill-title">Logging</div>
            <h2 class="card-title">Logs</h2>
            <p class="card-subtitle">Tick to include/exclude from logging for each event type.</p>
          </div>
        </div>

        <div id="logsStatus" class="status"></div>

        <div class="whitebox">
          <div class="small" style="color:#1c3b4f;">
            This page calls <code>GET/PUT /log-settings</code>.
          </div>
        </div>

        <div id="logEventList"></div>
      </div>
    </section>

    <!-- RECENT EVENTS -->
    <section id="screen-events" class="screen">
      <div class="topbar">
        <div class="topbar-left">
          <button class="btn-secondary btn-small" data-back>‚Üê Back</button>
          <button class="btn-secondary btn-small" data-home>üè† Home</button>
        </div>
        <div class="topbar-right">
          <button id="eventsRefreshBtn" class="btn-secondary btn-small">Refresh</button>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="pill-title">Monitoring</div>
            <h2 class="card-title">Recent Events</h2>
            <p class="card-subtitle">Shows logged events (up to latest limit).</p>
          </div>
        </div>

        <div class="two-column">
          <div>
            <label for="eventsDeviceFilterSelect">Device (optional filter)</label>
            <select id="eventsDeviceFilterSelect">
              <option value="">-- Any device --</option>
            </select>
          </div>
          <div>
            <label for="eventsLimitInput">Limit</label>
            <input id="eventsLimitInput" type="number" min="10" max="5000" value="200" />
          </div>
        </div>

        <div class="inline-actions">
          <button id="eventsLoadBtn" class="btn-secondary btn-small">Load</button>
        </div>

        <div class="section-divider"></div>

        <div class="two-column">
          <div>
            <label for="purgeDaysInput">Purge events older than (days)</label>
            <input id="purgeDaysInput" type="number" min="1" max="3650" value="90" />
          </div>
          <div style="display:flex; align-items:flex-end; gap:8px; flex-wrap:wrap;">
            <button id="purgeBtn" class="btn-danger btn-small">Purge</button>
            <div class="small">Calls <code>POST /admin/purge-events</code>.</div>
          </div>
        </div>

        <div id="eventsStatus" class="status"></div>

        <table id="recentEventsTable">
          <thead>
            <tr>
              <th>Time (UTC)</th>
              <th>Device</th>
              <th>User</th>
              <th>Event</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

  </div>

  <script>
    // ------------------------------
    // Global state
    // ------------------------------
    let apiKey = localStorage.getItem("geata_admin_api_key") || "";
    let selectedDeviceId = localStorage.getItem("geata_admin_selected_device") || "";
    let allDevices = [];
    let allUsers = [];
    let allSchedules = [];

    let editingUserId = null;
    let editingUserDevices = []; // array of {deviceId, role}
    let preselectEmail = { userId: null, deviceId: null };

    const LOGGABLE_EVENTS = [
      "OPEN_REQUESTED",
      "AUX1_REQUESTED",
      "AUX2_REQUESTED",
      "CMD_COMPLETED",
      "GATE_OPENED",
      "GATE_CLOSED",
      "GATE_FORCED_OPEN",
      "DOOR_FORCED_OPEN",
      "GATE_OPEN_TOO_LONG",
      "TAMPER_OPENED",
      "ENGINEER_MODE_ON",
      "ENGINEER_MODE_OFF",
      "ENGINEER_MODE_TIMEOUT"
    ];

    // Email checkbox list (matches backend event_type strings)
    const EMAIL_EVENT_TYPES = [
      "OPEN_REQUESTED",
      "CMD_COMPLETED",
      "GATE_OPENED",
      "GATE_CLOSED",
      "GATE_FORCED_OPEN",
      "DOOR_FORCED_OPEN",
      "GATE_OPEN_TOO_LONG",
      "TAMPER_OPENED",
      "ACCESS_DENIED_NOT_ASSIGNED",
      "ACCESS_DENIED_SCHEDULE",
      "AUX1_REQUESTED",
      "AUX2_REQUESTED",
      "AUX1_DENIED_NOT_ASSIGNED",
      "AUX1_DENIED_SCHEDULE",
      "AUX2_DENIED_NOT_ASSIGNED",
      "AUX2_DENIED_SCHEDULE"
    ];

    // ------------------------------
    // Helpers
    // ------------------------------
    function $(id) { return document.getElementById(id); }

    function setStatus(el, msg, isError, autoClearMs = 20000) {
      if (!el) return;
      el.textContent = msg || "";
      el.className = "status" + (isError ? " error" : " ok");
      if (!isError && msg) {
        const token = Date.now().toString();
        el.dataset._token = token;
        setTimeout(() => {
          if (el.dataset._token === token) el.textContent = "";
        }, autoClearMs);
      }
    }

    function headersJson() {
      const h = { "Content-Type": "application/json" };
      if (apiKey) h["x-api-key"] = apiKey;
      return h;
    }

    async function apiJson(path, opts = {}) {
      const res = await fetch(path, {
        method: opts.method || "GET",
        headers: opts.headers || headersJson(),
        body: opts.body
      });
      const text = await res.text().catch(() => "");
      let data = null;
      try { data = text ? JSON.parse(text) : null; } catch { data = text; }
      if (!res.ok) {
        const msg = (data && data.error) ? data.error : (typeof data === "string" ? data : ("HTTP " + res.status));
        const err = new Error(msg);
        err.status = res.status;
        err.data = data;
        throw err;
      }
      return data;
    }

    function fillDeviceSelect(selectEl, includeBlank = true, blankText = "-- Select a device --") {
      if (!selectEl) return;
      const current = selectEl.value;
      selectEl.innerHTML = "";
      if (includeBlank) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = blankText;
        selectEl.appendChild(opt);
      }
      allDevices.forEach(d => {
        const opt = document.createElement("option");
        opt.value = d.id;
        opt.textContent = `${d.id} ‚Äì ${d.name}`;
        selectEl.appendChild(opt);
      });
      if (current && allDevices.some(d => d.id === current)) selectEl.value = current;
    }

    function fillUserSelect(selectEl, users = null, includeBlank = true, blankText = "-- Select a user --") {
      if (!selectEl) return;
      const current = selectEl.value;
      const list = users || allUsers;
      selectEl.innerHTML = "";
      if (includeBlank) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = blankText;
        selectEl.appendChild(opt);
      }
      list.forEach(u => {
        const label = `${u.name || "(no name)"} ${u.email ? "¬∑ " + u.email : ""} ${u.phone ? "¬∑ " + u.phone : ""} [${u.id}]`;
        const opt = document.createElement("option");
        opt.value = u.id;
        opt.textContent = label;
        selectEl.appendChild(opt);
      });
      if (current && list.some(u => u.id === current)) selectEl.value = current;
    }

    function describeUserDevices(devices) {
      if (!devices || !devices.length) return [];
      return devices.map(d => ({ deviceId: d.deviceId, role: d.role || "operator" }));
    }

    function getSettingsFromTextarea() {
      try { return JSON.parse($("deviceSettingsJson").value || "{}"); }
      catch { return {}; }
    }
    function setSettingsToTextarea(obj) {
      $("deviceSettingsJson").value = JSON.stringify(obj || {}, null, 2);
    }
    function setAux1ModeRadiosFromSettings(settings) {
      const mode = (settings && settings.aux1Mode) ? String(settings.aux1Mode) : "relay";
      document.querySelectorAll('input[name="aux1Mode"]').forEach(r => r.checked = (r.value === mode));
    }
    function applyAux1ModeToSettingsFromRadios() {
      const settings = getSettingsFromTextarea();
      const picked = document.querySelector('input[name="aux1Mode"]:checked');
      settings.aux1Mode = picked ? picked.value : "relay";
      setSettingsToTextarea(settings);
    }

    function updateDeviceContextLabels() {
      const selectedDeviceSelect = $("selectedDeviceSelect");
      const txt = $("selectedDeviceText");
      const txt2 = $("selectedDeviceTextUsers");
      let label = "None selected";
      if (selectedDeviceSelect && selectedDeviceSelect.value) {
        const opt = selectedDeviceSelect.options[selectedDeviceSelect.selectedIndex];
        if (opt) label = opt.textContent;
      }
      if (txt) txt.textContent = label;
      if (txt2) txt2.textContent = label;
    }

    // Checkbox panel helpers
    function renderEventCheckboxPanel(containerEl, eventTypes) {
      if (!containerEl) return;

      containerEl.innerHTML = "";
      const wrap = document.createElement("div");
      wrap.className = "whitebox";

      (eventTypes || []).forEach(ev => {
        const row = document.createElement("label");
        row.style.display = "flex";
        row.style.alignItems = "center";
        row.style.gap = "10px";
        row.style.margin = "6px 0";
        row.style.color = "#122b3a";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.value = ev;

        const txt = document.createElement("span");
        txt.textContent = ev;

        row.appendChild(cb);
        row.appendChild(txt);
        wrap.appendChild(row);
      });

      containerEl.appendChild(wrap);
    }

    function setPanelChecked(containerEl, selectedList) {
      if (!containerEl) return;
      const set = new Set((selectedList || []).map(String));
      containerEl.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.checked = set.has(cb.value);
      });
    }

    function getPanelChecked(containerEl) {
      if (!containerEl) return [];
      const out = [];
      containerEl.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => out.push(cb.value));
      return out;
    }

    // ------------------------------
    // Screen navigation
    // ------------------------------
    const navStack = ["screen-home"];

    function showScreen(screenId, pushHistory = true) {
      document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
      const el = $(screenId);
      if (el) el.classList.add("active");

      $("homeHeader").style.display = (screenId === "screen-home") ? "block" : "none";

      const needsContext = el && el.getAttribute("data-show-context") === "true";
      $("deviceContextBar").classList.toggle("active", !!needsContext);

      if (pushHistory) navStack.push(screenId);

      if (screenId === "screen-emails" && preselectEmail.userId) {
        $("emailUserSelect").value = preselectEmail.userId;
        onEmailUserChanged();
        if (preselectEmail.deviceId) $("emailDeviceSelect").value = preselectEmail.deviceId;
        preselectEmail = { userId: null, deviceId: null };
      }
    }

    function goBack() {
      if (navStack.length <= 1) {
        showScreen("screen-home", true);
        return;
      }
      navStack.pop();
      const prev = navStack[navStack.length - 1] || "screen-home";
      showScreen(prev, false);
    }

    function goHome() {
      navStack.length = 0;
      navStack.push("screen-home");
      showScreen("screen-home", false);
    }

    // ------------------------------
    // Data loading
    // ------------------------------
    async function loadDevices() {
      const devicesStatus = $("devicesStatus");
      try {
        const data = await apiJson("/devices");
        allDevices = Array.isArray(data) ? data : [];

        fillDeviceSelect($("selectedDeviceSelect"), true, "-- Select a device --");
        fillDeviceSelect($("deviceSettingsSelect"));
        fillDeviceSelect($("ioDeviceSelect"));
        fillDeviceSelect($("directoryDeviceSelect"));
        fillDeviceSelect($("attachDeviceSelect"));
        fillDeviceSelect($("csvDeviceSelect"));
        fillDeviceSelect($("reportDeviceSelect"), true, "-- Any device --");
        fillDeviceSelect($("eventsDeviceFilterSelect"), true, "-- Any device --");

        if (selectedDeviceId && allDevices.some(d => d.id === selectedDeviceId)) {
          $("selectedDeviceSelect").value = selectedDeviceId;
        } else {
          selectedDeviceId = $("selectedDeviceSelect").value || "";
        }
        updateDeviceContextLabels();

        if (devicesStatus) setStatus(devicesStatus, `Loaded ${allDevices.length} devices`, false);
      } catch (e) {
        if (devicesStatus) setStatus(devicesStatus, "Error loading devices: " + e.message, true);
      }
    }

    async function loadUsers(query = null) {
      const status = $("userSearchStatus");
      try {
        const url = query ? ("/users?q=" + encodeURIComponent(query)) : "/users";
        const data = await apiJson(url);
        allUsers = Array.isArray(data) ? data : [];
        fillUserSelect($("ioUserSelect"));
        fillUserSelect($("emailUserSelect"));
        if (status && !query) setStatus(status, `Loaded ${allUsers.length} users`, false);
      } catch (e) {
        if (status && !query) setStatus(status, "Error loading users: " + e.message, true);
      }
    }

    async function loadSchedules() {
      const scheduleStatus = $("scheduleStatus");
      try {
        const data = await apiJson("/schedules");
        allSchedules = Array.isArray(data) ? data : [];
        rebuildAttachUserScheduleOptions();
        if (scheduleStatus) setStatus(scheduleStatus, `Loaded ${allSchedules.length} schedules`, false);
      } catch (e) {
        if (scheduleStatus) setStatus(scheduleStatus, "Error loading schedules: " + e.message, true);
      }
    }

    // ------------------------------
    // AUTH
    // ------------------------------
    function initAuthUI() {
      $("apiKeyInput").value = apiKey || "";

      $("setApiKeyBtn").addEventListener("click", async () => {
        apiKey = $("apiKeyInput").value.trim();
        localStorage.setItem("geata_admin_api_key", apiKey);
        setStatus($("apiKeyStatus"), apiKey ? "API key saved" : "API key cleared", false);

        // Reload tables now that key is valid
        if (apiKey) {
          await loadDevices(); await renderDevicesTable();
          await loadUsers(null); await renderUserLookupTable(allUsers);
          await loadSchedules(); await renderSchedules();
          await logsLoad();
        }
      });

      $("clearApiKeyBtn").addEventListener("click", () => {
        apiKey = "";
        $("apiKeyInput").value = "";
        localStorage.removeItem("geata_admin_api_key");
        setStatus($("apiKeyStatus"), "API key cleared", false);
      });
    }

    // ------------------------------
    // DEVICES
    // ------------------------------
    async function renderDevicesTable() {
      const tbody = document.querySelector("#devicesTable tbody");
      if (!tbody) return;
      tbody.innerHTML = "";
      allDevices.forEach(d => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${d.id}</td><td>${d.name || ""}</td>`;
        tbody.appendChild(tr);
      });
    }

    function initDevicesUI() {
      $("refreshDevicesBtn").addEventListener("click", async () => {
        await loadDevices();
        await renderDevicesTable();
      });

      $("addDeviceBtn").addEventListener("click", async () => {
        const id = $("newDeviceId").value.trim();
        const name = $("newDeviceName").value.trim();
        if (!id || !name) {
          setStatus($("addDeviceStatus"), "Device ID and Name are required", true);
          return;
        }
        try {
          await apiJson("/devices", { method: "POST", body: JSON.stringify({ id, name }) });
          setStatus($("addDeviceStatus"), "Saved device", false);
          $("newDeviceId").value = "";
          $("newDeviceName").value = "";
          await loadDevices();
          await renderDevicesTable();
        } catch (e) {
          setStatus($("addDeviceStatus"), "Error: " + e.message, true);
        }
      });
    }

    // ------------------------------
    // SELECT DEVICES & USERS
    // ------------------------------
    function rebuildAttachUserScheduleOptions() {
      const sel = $("attachUserScheduleSelect");
      if (!sel) return;
      const current = sel.value;
      sel.innerHTML = "";
      const def = document.createElement("option");
      def.value = "";
      def.textContent = "24/7 (no schedule)";
      sel.appendChild(def);
      allSchedules.forEach(s => {
        const opt = document.createElement("option");
        opt.value = String(s.id);
        opt.textContent = s.name;
        sel.appendChild(opt);
      });
      if (current && allSchedules.some(s => String(s.id) === current)) sel.value = current;
    }

    async function loadDeviceUsers(deviceId) {
      const tbody = document.querySelector("#deviceUsersTable tbody");
      if (!tbody) return;
      tbody.innerHTML = "";
      if (!deviceId) {
        setStatus($("deviceUsersStatus"), "Select a device in the Device Context bar", true);
        return;
      }

      setStatus($("deviceUsersStatus"), "Loading users...", false);

      try {
        const users = await apiJson(`/devices/${encodeURIComponent(deviceId)}/users`);
        (users || []).forEach(u => {
          const tr = document.createElement("tr");

          const scheduleSelect = document.createElement("select");
          const def = document.createElement("option");
          def.value = "";
          def.textContent = "24/7 (no schedule)";
          scheduleSelect.appendChild(def);
          allSchedules.forEach(s => {
            const opt = document.createElement("option");
            opt.value = String(s.id);
            opt.textContent = s.name;
            scheduleSelect.appendChild(opt);
          });
          if (u.scheduleId) scheduleSelect.value = String(u.scheduleId);

          const btnSave = document.createElement("button");
          btnSave.textContent = "Save";
          btnSave.className = "btn-small";

          const btnEdit = document.createElement("button");
          btnEdit.textContent = "Edit";
          btnEdit.className = "btn-secondary btn-small";

          const btnRemove = document.createElement("button");
          btnRemove.textContent = "Remove";
          btnRemove.className = "btn-danger btn-small";

          const scheduleCell = document.createElement("td");
          scheduleCell.appendChild(scheduleSelect);

          const actions = document.createElement("div");
          actions.className = "inline-actions";
          actions.appendChild(btnSave);
          actions.appendChild(btnEdit);
          actions.appendChild(btnRemove);
          scheduleCell.appendChild(actions);

          btnSave.addEventListener("click", async () => {
            try {
              const scheduleId = scheduleSelect.value || null;
              await apiJson(`/devices/${encodeURIComponent(deviceId)}/users/${encodeURIComponent(u.userId)}/schedule-assignment`, {
                method: "PUT",
                body: JSON.stringify({ scheduleId })
              });
              setStatus($("deviceUsersStatus"), "Saved schedule for user", false);
            } catch (e) {
              setStatus($("deviceUsersStatus"), "Error saving schedule: " + e.message, true);
            }
          });

          btnEdit.addEventListener("click", async () => {
            await openEditUser(u.userId);
            showScreen("screen-edit-user");
          });

          btnRemove.addEventListener("click", async () => {
            if (!confirm(`Remove user ${u.userId} from device ${deviceId}?`)) return;
            try {
              await apiJson(`/devices/${encodeURIComponent(deviceId)}/users/${encodeURIComponent(u.userId)}`, { method: "DELETE" });
              setStatus($("deviceUsersStatus"), "Removed user from device", false);
              await loadDeviceUsers(deviceId);
            } catch (e) {
              setStatus($("deviceUsersStatus"), "Error removing user: " + e.message, true);
            }
          });

          tr.innerHTML = `
            <td>${u.userId}</td>
            <td>${u.name || ""}</td>
            <td>${u.email || ""}</td>
            <td>${u.phone || ""}</td>
            <td>${u.role || ""}</td>
          `;
          tr.appendChild(scheduleCell);
          tbody.appendChild(tr);
        });

        setStatus($("deviceUsersStatus"), `Loaded ${users.length} users for device`, false);
      } catch (e) {
        setStatus($("deviceUsersStatus"), "Error: " + e.message, true);
      }
    }

    function initDeviceUsersUI() {
      $("selectedDeviceSelect").addEventListener("change", async () => {
        selectedDeviceId = $("selectedDeviceSelect").value || "";
        localStorage.setItem("geata_admin_selected_device", selectedDeviceId);
        updateDeviceContextLabels();
        await loadDeviceUsers(selectedDeviceId);
      });

      $("refreshDeviceUsersBtn").addEventListener("click", async () => {
        await loadDeviceUsers(selectedDeviceId);
      });
    }

    // ------------------------------
    // EDIT USER DETAILS
    // ------------------------------
    async function fetchUserById(userId) {
      try {
        return await apiJson(`/users/${encodeURIComponent(userId)}`);
      } catch (e) {
        const list = await apiJson(`/users?q=${encodeURIComponent(userId)}`);
        if (Array.isArray(list)) return list.find(u => u.id === userId) || list[0] || null;
        return null;
      }
    }

    async function openEditUser(userId) {
      editingUserId = userId;
      $("editUserIdBox").textContent = userId || "(none)";
      $("editUserEmailDeviceSelect").innerHTML = `<option value="">-- Select one of the user‚Äôs devices --</option>`;
      $("editUserDevicesPills").innerHTML = "";

      try {
        const u = await fetchUserById(userId);
        if (!u) {
          setStatus($("editUserStatus"), "User not found", true);
          return;
        }

        $("editUserName").value = u.name || "";
        $("editUserEmail").value = u.email || "";
        $("editUserPhone").value = u.phone || "";
        $("editUserPassword").value = "";

        editingUserDevices = describeUserDevices(u.devices || []);
        if (editingUserDevices.length) {
          editingUserDevices.forEach(d => {
            const pill = document.createElement("span");
            pill.className = "pill";
            pill.textContent = `${d.deviceId} (${d.role})`;
            $("editUserDevicesPills").appendChild(pill);

            const opt = document.createElement("option");
            opt.value = d.deviceId;
            opt.textContent = d.deviceId;
            $("editUserEmailDeviceSelect").appendChild(opt);
          });
        } else {
          $("editUserDevicesPills").innerHTML = `<span class="small">No enrolled devices</span>`;
        }

        setEditUserEditing(false);
        setStatus($("editUserStatus"), "User loaded. Click Edit to modify.", false);
      } catch (e) {
        setStatus($("editUserStatus"), "Error loading user: " + e.message, true);
      }
    }

    function setEditUserEditing(enabled) {
      $("editUserName").disabled = !enabled;
      $("editUserEmail").disabled = !enabled;
      $("editUserPhone").disabled = !enabled;
      $("editUserPassword").disabled = !enabled;
      $("editUserSaveTopBtn").disabled = !enabled || !editingUserId;
    }

    function initEditUserUI() {
      $("editUserEnableBtn").addEventListener("click", () => {
        if (!editingUserId) {
          setStatus($("editUserStatus"), "Pick a user first (User Lookup ‚Üí Edit)", true);
          return;
        }
        const enable = $("editUserName").disabled;
        setEditUserEditing(enable);
        setStatus($("editUserStatus"), enable ? "Edit enabled. Click Save." : "Edit disabled.", false);
      });

      $("editUserSaveTopBtn").addEventListener("click", async () => {
        if (!editingUserId) return;
        try {
          await apiJson(`/users/${encodeURIComponent(editingUserId)}`, {
            method: "PUT",
            body: JSON.stringify({
              name: $("editUserName").value.trim(),
              email: $("editUserEmail").value.trim(),
              phone: $("editUserPhone").value.trim(),
              password: $("editUserPassword").value || ""
            })
          });
          $("editUserPassword").value = "";
          setEditUserEditing(false);
          setStatus($("editUserStatus"), "Saved user changes", false);
          await loadUsers(null);
        } catch (e) {
          setStatus($("editUserStatus"), "Error saving user: " + e.message, true);
        }
      });

      $("openEmailNotificationsBtn").addEventListener("click", () => {
        if (!editingUserId) return;
        const deviceId = $("editUserEmailDeviceSelect").value || "";
        preselectEmail = { userId: editingUserId, deviceId };
        showScreen("screen-emails");
      });
    }

    // ------------------------------
    // USER LOOKUP
    // ------------------------------
    async function renderUserLookupTable(users) {
      const tbody = document.querySelector("#globalUsersTable tbody");
      tbody.innerHTML = "";
      users.forEach(u => {
        const tr = document.createElement("tr");
        const devicesTd = document.createElement("td");
        if (u.devices && u.devices.length) {
          u.devices.forEach(d => {
            const pill = document.createElement("span");
            pill.className = "pill";
            pill.textContent = `${d.deviceId}(${d.role || "operator"})`;
            devicesTd.appendChild(pill);
          });
        }

        const tdSelect = document.createElement("td");
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.className = "userAttachCheckbox";
        cb.dataset.userId = u.id;
        tdSelect.appendChild(cb);

        const tdEdit = document.createElement("td");
        const editBtn = document.createElement("button");
        editBtn.textContent = "Edit";
        editBtn.className = "btn-small";
        editBtn.addEventListener("click", async () => {
          await openEditUser(u.id);
          showScreen("screen-edit-user");
        });
        tdEdit.appendChild(editBtn);

        const tdDel = document.createElement("td");
        const delBtn = document.createElement("button");
        delBtn.textContent = "Delete";
        delBtn.className = "btn-danger btn-small";
        delBtn.addEventListener("click", async () => {
          if (!confirm(`Delete user ${u.id} from all devices?`)) return;
          try {
            await apiJson(`/users/${encodeURIComponent(u.id)}`, { method: "DELETE" });
            setStatus($("userSearchStatus"), "Deleted user", false);
            await loadUsers(null);
            await renderUserLookupTable(allUsers);
          } catch (e) {
            setStatus($("userSearchStatus"), "Error deleting user: " + e.message, true);
          }
        });
        tdDel.appendChild(delBtn);

        tr.appendChild(tdSelect);
        tr.innerHTML += `
          <td>${u.id}</td>
          <td>${u.name || ""}</td>
          <td>${u.email || ""}</td>
          <td>${u.phone || ""}</td>
        `;
        tr.appendChild(devicesTd);
        tr.appendChild(tdEdit);
        tr.appendChild(tdDel);
        tbody.appendChild(tr);
      });
    }

    function initUserLookupUI() {
      $("searchUsersBtn").addEventListener("click", async () => {
        const q = $("userSearchInput").value.trim();
        try {
          const list = await apiJson(q ? `/users?q=${encodeURIComponent(q)}` : "/users");
          setStatus($("userSearchStatus"), `Found ${list.length} users`, false);
          await renderUserLookupTable(list);
        } catch (e) {
          setStatus($("userSearchStatus"), "Search error: " + e.message, true);
        }
      });

      $("showAllUsersBtn").addEventListener("click", async () => {
        $("userSearchInput").value = "";
        await loadUsers(null);
        setStatus($("userSearchStatus"), `Loaded ${allUsers.length} users`, false);
        await renderUserLookupTable(allUsers);
      });

      $("attachSelectedUsersBtn").addEventListener("click", async () => {
        const deviceId = $("directoryDeviceSelect").value;
        if (!deviceId) {
          setStatus($("userSearchStatus"), "Select a device first", true);
          return;
        }
        const checked = document.querySelectorAll(".userAttachCheckbox:checked");
        if (!checked.length) {
          setStatus($("userSearchStatus"), "No users selected", true);
          return;
        }
        const userIds = Array.from(checked).map(cb => cb.dataset.userId);

        try {
          for (const uid of userIds) {
            await apiJson(`/devices/${encodeURIComponent(deviceId)}/users`, {
              method: "POST",
              body: JSON.stringify({ userId: uid, role: "operator" })
            });
          }
          setStatus($("userSearchStatus"), `Attached ${userIds.length} users to ${deviceId}`, false);
          checked.forEach(cb => cb.checked = false);

          await loadUsers(null);
          await renderUserLookupTable(allUsers);
        } catch (e) {
          setStatus($("userSearchStatus"), "Attach error: " + e.message, true);
        }
      });
    }

    // ------------------------------
    // ADD USER TO DEVICE
    // ------------------------------
    function initAttachUserUI() {
      $("attachUserBtn").addEventListener("click", async () => {
        const deviceId = $("attachDeviceSelect").value;
        if (!deviceId) {
          setStatus($("attachUserStatus"), "Select a device first", true);
          return;
        }

        const existingUserId = $("existingUserIdInput").value.trim();
        const name = $("userNameInput").value.trim();
        const email = $("userEmailInput").value.trim();
        const phone = $("userPhoneInput").value.trim();
        const password = $("userPasswordInput").value;
        const role = $("userRoleSelect").value || "operator";
        const scheduleId = $("attachUserScheduleSelect").value || null;

        let body;
        if (existingUserId) {
          body = { userId: existingUserId, role };
        } else {
          if (!email && !phone) {
            setStatus($("attachUserStatus"), "Email or phone is required (or provide a User ID)", true);
            return;
          }
          body = { name, email, phone, password, role };
        }

        try {
          const data = await apiJson(`/devices/${encodeURIComponent(deviceId)}/users`, {
            method: "POST",
            body: JSON.stringify(body)
          });

          const attachedUserId = data.userId || (data.user && data.user.id) || existingUserId;
          if (attachedUserId && scheduleId) {
            await apiJson(`/devices/${encodeURIComponent(deviceId)}/users/${encodeURIComponent(attachedUserId)}/schedule-assignment`, {
              method: "PUT",
              body: JSON.stringify({ scheduleId })
            });
          }

          setStatus($("attachUserStatus"), "Saved user + attached to device", false);

          $("userNameInput").value = "";
          $("userEmailInput").value = "";
          $("userPhoneInput").value = "";
          $("userPasswordInput").value = "";
          $("existingUserIdInput").value = "";
          $("userRoleSelect").value = "operator";
          $("attachUserScheduleSelect").value = "";

          await loadUsers(null);
        } catch (e) {
          setStatus($("attachUserStatus"), "Error: " + e.message, true);
        }
      });
    }

    // ------------------------------
    // IMPORT/EXPORT
    // ------------------------------
    function parseCsv(text) {
      const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      if (!lines.length) return [];
      const header = lines[0].split(",").map(h => h.trim().toLowerCase());
      const idx = (name) => header.indexOf(name);
      const rows = [];
      for (let i = 1; i < lines.length; i++) {
        const parts = lines[i].split(",").map(p => p.trim());
        rows.push({
          name:  idx("name")  >= 0 ? (parts[idx("name")]  || "") : "",
          email: idx("email") >= 0 ? (parts[idx("email")] || "") : "",
          phone: idx("phone") >= 0 ? (parts[idx("phone")] || "") : "",
          role:  idx("role")  >= 0 ? (parts[idx("role")]  || "") : ""
        });
      }
      return rows;
    }

    function initCsvUI() {
      $("importCsvBtn").addEventListener("click", () => {
        const deviceId = $("csvDeviceSelect").value;
        if (!deviceId) {
          setStatus($("csvImportStatus"), "Select a device first", true);
          return;
        }
        const file = $("csvFileInput").files[0];
        if (!file) {
          setStatus($("csvImportStatus"), "Choose a CSV file", true);
          return;
        }
        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const rows = parseCsv(e.target.result);
            if (!rows.length) {
              setStatus($("csvImportStatus"), "No rows found in CSV", true);
              return;
            }
            await apiJson(`/devices/${encodeURIComponent(deviceId)}/users/import`, {
              method: "POST",
              body: JSON.stringify({ rows })
            });
            setStatus($("csvImportStatus"), `Imported ${rows.length} rows`, false);
            $("csvFileInput").value = "";
          } catch (err) {
            setStatus($("csvImportStatus"), "Import error: " + err.message, true);
          }
        };
        reader.readAsText(file);
      });

      $("exportCsvDeviceBtn").addEventListener("click", async () => {
        const deviceId = $("csvDeviceSelect").value;
        if (!deviceId) {
          setStatus($("csvImportStatus"), "Select a device first", true);
          return;
        }
        try {
          const res = await fetch(`/devices/${encodeURIComponent(deviceId)}/users/export`, { headers: headersJson() });
          if (!res.ok) throw new Error(await res.text());
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `device-${deviceId}-users.csv`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
          setStatus($("csvImportStatus"), "Downloaded device CSV", false);
        } catch (e) {
          setStatus($("csvImportStatus"), "Export error: " + e.message, true);
        }
      });

      $("exportAllCsvBtn").addEventListener("click", async () => {
        try {
          const res = await fetch("/users/export-csv", { headers: headersJson() });
          if (!res.ok) throw new Error(await res.text());
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "geata-users-devices.csv";
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
          setStatus($("csvImportStatus"), "Downloaded global CSV", false);
        } catch (e) {
          setStatus($("csvImportStatus"), "Export error: " + e.message, true);
        }
      });
    }

    // ------------------------------
    // SCHEDULES (unchanged logic from your version)
    // ------------------------------
    function dayName(d) { return ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][d] || "?"; }

    function describeSlots(slots) {
      if (!slots || slots.length === 0) return "No slots";
      return slots.map(s => {
        const days = Array.isArray(s.daysOfWeek) ? s.daysOfWeek : [];
        const dayStr = days.length ? days.map(dayName).join(",") : "All days";
        return `${dayStr} ${s.start || ""}-${s.end || ""}`;
      }).join(" | ");
    }

    function parseDaysString(str) {
      const result = [];
      const s = (str || "").trim();
      if (!s) return [];
      const parts = s.split(",");
      parts.forEach(part => {
        const t = part.trim();
        if (!t) return;
        if (t.includes("-")) {
          const [aS, bS] = t.split("-");
          const a = parseInt(aS.trim(), 10);
          const b = parseInt(bS.trim(), 10);
          if (Number.isFinite(a) && Number.isFinite(b)) {
            const step = a <= b ? 1 : -1;
            for (let d = a; step > 0 ? d <= b : d >= b; d += step) {
              if (d >= 0 && d <= 6 && !result.includes(d)) result.push(d);
            }
          }
        } else {
          const n = parseInt(t, 10);
          if (Number.isFinite(n) && n >= 0 && n <= 6 && !result.includes(n)) result.push(n);
        }
      });
      result.sort((x,y) => x-y);
      return result;
    }

    let editingScheduleId = null;

    function setScheduleEditing(enabled) {
      $("scheduleNameInput").disabled = !enabled;
      $("scheduleDescInput").disabled = !enabled;
      for (let i=1;i<=6;i++) {
        $(`slot${i}Days`).disabled = !enabled;
        $(`slot${i}Start`).disabled = !enabled;
        $(`slot${i}End`).disabled = !enabled;
      }
      $("scheduleSaveTopBtn").disabled = !enabled;
    }

    function resetScheduleForm() {
      editingScheduleId = null;
      $("scheduleFormTitle").textContent = "Create / Edit Schedule";
      $("scheduleNameInput").value = "";
      $("scheduleDescInput").value = "";
      for (let i=1;i<=6;i++) {
        $(`slot${i}Days`).value = "";
        $(`slot${i}Start`).value = "";
        $(`slot${i}End`).value = "";
      }
      setScheduleEditing(false);
    }

    function readSlotsFromForm() {
      const slots = [];
      for (let i=1;i<=6;i++) {
        const daysStr = $(`slot${i}Days`).value.trim();
        const start = $(`slot${i}Start`).value;
        const end = $(`slot${i}End`).value;
        if (!daysStr && !start && !end) continue;
        if (!start || !end) continue;
        slots.push({ daysOfWeek: parseDaysString(daysStr), start, end });
      }
      return slots;
    }

    function fillSlotsFormFromSchedule(s) {
      for (let i=1;i<=6;i++) {
        $(`slot${i}Days`).value = "";
        $(`slot${i}Start`).value = "";
        $(`slot${i}End`).value = "";
      }
      const slots = s.slots || [];
      for (let i=0; i<slots.length && i<6; i++) {
        const sl = slots[i];
        $(`slot${i+1}Days`).value = (sl.daysOfWeek || []).join(",");
        $(`slot${i+1}Start`).value = sl.start || "";
        $(`slot${i+1}End`).value = sl.end || "";
      }
    }

    async function renderSchedules() {
      const tbody = document.querySelector("#schedulesTable tbody");
      tbody.innerHTML = "";
      allSchedules.forEach(s => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${s.id}</td>
          <td>${s.name}</td>
          <td>${describeSlots(s.slots || [])}</td>
          <td></td>
          <td></td>
        `;
        const tdEdit = tr.children[3];
        const tdDel = tr.children[4];

        const btnEdit = document.createElement("button");
        btnEdit.textContent = "Edit";
        btnEdit.className = "btn-small";
        btnEdit.addEventListener("click", () => {
          editingScheduleId = s.id;
          $("scheduleFormTitle").textContent = `Editing schedule ${s.id}`;
          $("scheduleNameInput").value = s.name || "";
          $("scheduleDescInput").value = s.description || "";
          fillSlotsFormFromSchedule(s);
          setScheduleEditing(true);
          setStatus($("scheduleStatus"), "Edit enabled. Adjust and Save.", false);
        });
        tdEdit.appendChild(btnEdit);

        const btnDel = document.createElement("button");
        btnDel.textContent = "Delete";
        btnDel.className = "btn-danger btn-small";
        btnDel.addEventListener("click", async () => {
          if (!confirm(`Delete schedule "${s.name}"?`)) return;
          try {
            await apiJson(`/schedules/${encodeURIComponent(s.id)}`, { method: "DELETE" });
            setStatus($("scheduleStatus"), "Deleted schedule", false);
            resetScheduleForm();
            await loadSchedules();
            await renderSchedules();
          } catch (e) {
            setStatus($("scheduleStatus"), "Delete error: " + e.message, true);
          }
        });
        tdDel.appendChild(btnDel);

        tbody.appendChild(tr);
      });
    }

    function initSchedulesUI() {
      $("refreshSchedulesBtn").addEventListener("click", async () => {
        await loadSchedules();
        await renderSchedules();
      });

      $("scheduleEnableBtn").addEventListener("click", () => {
        const enable = $("scheduleNameInput").disabled;
        setScheduleEditing(enable);
        setStatus($("scheduleStatus"), enable ? "Edit enabled." : "Edit disabled.", false);
      });

      $("scheduleSaveTopBtn").addEventListener("click", async () => {
        const name = $("scheduleNameInput").value.trim();
        if (!name) {
          setStatus($("scheduleStatus"), "Schedule name required", true);
          return;
        }
        const payload = {
          name,
          description: $("scheduleDescInput").value.trim(),
          slots: readSlotsFromForm()
        };

        try {
          if (editingScheduleId) {
            await apiJson(`/schedules/${encodeURIComponent(editingScheduleId)}`, { method: "PUT", body: JSON.stringify(payload) });
          } else {
            await apiJson("/schedules", { method: "POST", body: JSON.stringify(payload) });
          }
          setStatus($("scheduleStatus"), "Saved schedule", false);
          resetScheduleForm();
          await loadSchedules();
          await renderSchedules();
        } catch (e) {
          setStatus($("scheduleStatus"), "Save error: " + e.message, true);
        }
      });

      $("resetScheduleFormBtn").addEventListener("click", resetScheduleForm);
    }

    // ------------------------------
    // DEVICE SETTINGS
    // ------------------------------
    let deviceSettingsEditing = false;

    function setDeviceSettingsEditing(enabled) {
      deviceSettingsEditing = enabled;
      $("deviceSettingsJson").readOnly = !enabled;
      $("deviceSettingsSaveBtn").disabled = !enabled;

      // disable/enable radios too
      document.querySelectorAll('input[name="aux1Mode"]').forEach(r => r.disabled = !enabled);
    }

    function initDeviceSettingsUI() {
      $("deviceSettingsEditBtn").addEventListener("click", () => {
        const enable = !deviceSettingsEditing;
        setDeviceSettingsEditing(enable);
        setStatus($("deviceSettingsStatus"), enable ? "Edit enabled. Save when done." : "Edit disabled.", false);
      });

      $("deviceSettingsLoadBtn").addEventListener("click", async () => {
        const deviceId = $("deviceSettingsSelect").value;
        if (!deviceId) {
          setStatus($("deviceSettingsStatus"), "Select a device first", true);
          return;
        }
        try {
          const data = await apiJson(`/devices/${encodeURIComponent(deviceId)}/settings`);
          setSettingsToTextarea(data);
          setAux1ModeRadiosFromSettings(data);
          setDeviceSettingsEditing(false);
          setStatus($("deviceSettingsStatus"), "Loaded device settings", false);
        } catch (e) {
          setStatus($("deviceSettingsStatus"), "Load error: " + e.message, true);
        }
      });

      $("deviceSettingsSaveBtn").addEventListener("click", async () => {
        const deviceId = $("deviceSettingsSelect").value;
        if (!deviceId) {
          setStatus($("deviceSettingsStatus"), "Select a device first", true);
          return;
        }
        try {
          applyAux1ModeToSettingsFromRadios();
          const parsed = JSON.parse($("deviceSettingsJson").value || "{}");
          await apiJson(`/devices/${encodeURIComponent(deviceId)}/settings`, {
            method: "PUT",
            body: JSON.stringify(parsed)
          });
          setDeviceSettingsEditing(false);
          setStatus($("deviceSettingsStatus"), "Saved device settings", false);
        } catch (e) {
          setStatus($("deviceSettingsStatus"), "Save error: " + e.message, true);
        }
      });

      // keep JSON synced with radios (only when editing)
      document.querySelectorAll('input[name="aux1Mode"]').forEach(r => {
        r.addEventListener("change", () => {
          if (!deviceSettingsEditing) return;
          applyAux1ModeToSettingsFromRadios();
        });
      });

      // default (locked)
      setDeviceSettingsEditing(false);
    }

    // ------------------------------
    // SUBSCRIPTIONS (shared)
    // ------------------------------
    async function loadSubscriptionsFor(userId, deviceId, statusEl, panelEl) {
      const subs = await apiJson(`/devices/${encodeURIComponent(deviceId)}/notifications`);
      const row = (subs || []).find(r => r.userId === userId);
      const list = row ? (row.eventTypes || []) : [];
      setPanelChecked(panelEl, list);
      setStatus(statusEl, "Loaded subscriptions", false);
    }

    // ------------------------------
    // EMAIL NOTIFICATIONS
    // ------------------------------
    function onEmailUserChanged() {
      const userId = $("emailUserSelect").value;
      const user = allUsers.find(u => u.id === userId);
      const sel = $("emailDeviceSelect");
      const current = sel.value;

      sel.innerHTML = `<option value="">-- Select a device --</option>`;
      if (!user) return;

      const enrolled = (user.devices || []).map(d => d.deviceId);
      enrolled.forEach(devId => {
        const d = allDevices.find(x => x.id === devId);
        const opt = document.createElement("option");
        opt.value = devId;
        opt.textContent = d ? `${d.id} ‚Äì ${d.name}` : devId;
        sel.appendChild(opt);
      });

      if (current && enrolled.includes(current)) sel.value = current;
    }

    function initEmailUI() {
      renderEventCheckboxPanel($("emailEventTypesPanel"), EMAIL_EVENT_TYPES);

      $("emailUserSelect").addEventListener("change", onEmailUserChanged);

      $("emailLoadBtn").addEventListener("click", async () => {
        const userId = $("emailUserSelect").value;
        const deviceId = $("emailDeviceSelect").value;
        if (!userId || !deviceId) {
          setStatus($("emailStatus"), "Select both User and Device", true);
          return;
        }
        try {
          await loadSubscriptionsFor(userId, deviceId, $("emailStatus"), $("emailEventTypesPanel"));
        } catch (e) {
          setStatus($("emailStatus"), "Load error: " + e.message, true);
        }
      });

      $("emailSaveBtn").addEventListener("click", async () => {
        const userId = $("emailUserSelect").value;
        const deviceId = $("emailDeviceSelect").value;
        if (!userId || !deviceId) {
          setStatus($("emailStatus"), "Select both User and Device", true);
          return;
        }
        try {
          const eventTypes = getPanelChecked($("emailEventTypesPanel"));
          await apiJson(`/devices/${encodeURIComponent(deviceId)}/users/${encodeURIComponent(userId)}/notifications`, {
            method: "PUT",
            body: JSON.stringify({ eventTypes })
          });
          setStatus($("emailStatus"), "Saved subscriptions", false);
        } catch (e) {
          setStatus($("emailStatus"), "Save error: " + e.message, true);
        }
      });

      $("emailRefreshBtn").addEventListener("click", async () => {
        await loadUsers(null);
        fillUserSelect($("emailUserSelect"));
        onEmailUserChanged();
        setStatus($("emailStatus"), "Refreshed users list", false);
      });
    }

    // ------------------------------
    // DEVICE I/O TEST
    // ------------------------------
    async function ioLoadSubs() {
      const deviceId = $("ioDeviceSelect").value;
      const userId = $("ioUserSelect").value;
      if (!deviceId || !userId) {
        setStatus($("ioStatus"), "Select both device and user", true);
        return;
      }
      try {
        await loadSubscriptionsFor(userId, deviceId, $("ioStatus"), $("ioEventTypesPanel"));
      } catch (e) {
        setStatus($("ioStatus"), "Load error: " + e.message, true);
      }
    }

    async function ioSaveSubs() {
      const deviceId = $("ioDeviceSelect").value;
      const userId = $("ioUserSelect").value;
      if (!deviceId || !userId) {
        setStatus($("ioStatus"), "Select both device and user", true);
        return;
      }
      try {
        const eventTypes = getPanelChecked($("ioEventTypesPanel"));
        await apiJson(`/devices/${encodeURIComponent(deviceId)}/users/${encodeURIComponent(userId)}/notifications`, {
          method: "PUT",
          body: JSON.stringify({ eventTypes })
        });
        setStatus($("ioStatus"), "Saved subscriptions", false);
      } catch (e) {
        setStatus($("ioStatus"), "Save error: " + e.message, true);
      }
    }

    async function ioPulse(path, durationMs, statusEl) {
      const deviceId = $("ioDeviceSelect").value;
      if (!deviceId) {
        setStatus(statusEl, "Select a device first", true);
        return;
      }
      try {
        await apiJson(`/devices/${encodeURIComponent(deviceId)}/${path}`, {
          method: "POST",
          body: JSON.stringify({ durationMs })
        });
        setStatus(statusEl, `Triggered ${path} (${durationMs}ms)`, false);
      } catch (e) {
        setStatus(statusEl, "Error: " + e.message, true);
      }
    }

    async function ioSim(type, alsoPulseOutput3 = false) {
      const deviceId = $("ioDeviceSelect").value;
      if (!deviceId) { setStatus($("ioSimStatus"), "Select a device", true); return; }
      try {
        await apiJson(`/devices/${encodeURIComponent(deviceId)}/simulate-event`, {
          method: "POST",
          body: JSON.stringify({ type })
        });
        if (alsoPulseOutput3) {
          await apiJson(`/devices/${encodeURIComponent(deviceId)}/aux2-test`, {
            method: "POST",
            body: JSON.stringify({ durationMs: 2000 })
          });
        }
        setStatus($("ioSimStatus"), "Simulated " + type, false);
      } catch (e) {
        setStatus($("ioSimStatus"), "Sim error: " + e.message, true);
      }
    }

    function initIoUI() {
      renderEventCheckboxPanel($("ioEventTypesPanel"), EMAIL_EVENT_TYPES);

      $("ioLoadSubsBtn").addEventListener("click", ioLoadSubs);
      $("ioSaveSubsBtn").addEventListener("click", ioSaveSubs);

      $("ioAux1PulseBtn").addEventListener("click", () => ioPulse("aux1-test", 1000, $("ioOutputStatus")));
      $("ioOutput3PulseBtn").addEventListener("click", () => ioPulse("aux2-test", 2000, $("ioOutputStatus")));

      $("simOpenRequestedBtn").addEventListener("click", () => ioSim("OPEN_REQUESTED"));
      $("simGateOpenedBtn").addEventListener("click", () => ioSim("GATE_OPENED"));
      $("simGateClosedBtn").addEventListener("click", () => ioSim("GATE_CLOSED"));
      $("simForcedBtn").addEventListener("click", () => ioSim("GATE_FORCED_OPEN"));
      $("simDoorForcedBtn").addEventListener("click", () => ioSim("DOOR_FORCED_OPEN"));
      $("simAjarBtn").addEventListener("click", () => ioSim("GATE_OPEN_TOO_LONG"));
      $("simTamperBtn").addEventListener("click", () => ioSim("TAMPER_OPENED", true));
    }

    // ------------------------------
    // REPORTS
    // ------------------------------
    function buildReportQueryParams() {
      const params = [];
      const deviceId = $("reportDeviceSelect").value;
      const userId = $("reportUserIdInput").value.trim();
      if (deviceId) params.push("deviceId=" + encodeURIComponent(deviceId));
      if (userId) params.push("userId=" + encodeURIComponent(userId));
      if ($("reportFromDate").value) params.push("from=" + encodeURIComponent($("reportFromDate").value + "T00:00:00"));
      if ($("reportToDate").value) params.push("to=" + encodeURIComponent($("reportToDate").value + "T23:59:59"));
      params.push("limit=1000");
      return params.join("&");
    }

    async function runReport() {
      const tbody = document.querySelector("#reportEventsTable tbody");
      tbody.innerHTML = "";
      setStatus($("reportStatus"), "Loading report...", false);
      try {
        const qs = buildReportQueryParams();
        const data = await apiJson("/events?" + qs);
        (data || []).forEach(ev => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${ev.at || ""}</td>
            <td>${(ev.device_id || "")}${ev.device_name ? " ‚Äì " + ev.device_name : ""}</td>
            <td>${[ev.user_name, ev.user_phone, ev.user_id ? "[" + ev.user_id + "]" : ""].filter(Boolean).join(" | ")}</td>
            <td>${ev.event_type || ""}</td>
            <td>${ev.details || ""}</td>
          `;
          tbody.appendChild(tr);
        });
        setStatus($("reportStatus"), "Report loaded: " + (data ? data.length : 0) + " events", false);
      } catch (e) {
        setStatus($("reportStatus"), "Report error: " + e.message, true);
      }
    }

    async function downloadReportCsv() {
      try {
        const qs = buildReportQueryParams();
        const res = await fetch("/events?" + qs + "&format=csv", { headers: headersJson() });
        if (!res.ok) throw new Error(await res.text());
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "events-report.csv";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (e) {
        setStatus($("reportStatus"), "CSV error: " + e.message, true);
      }
    }

    function initReportsUI() {
      $("runReportBtn").addEventListener("click", runReport);
      $("downloadReportCsvBtn").addEventListener("click", downloadReportCsv);
    }

    // ------------------------------
    // LOGS
    // ------------------------------
    let logsEditing = false;
    let logEnabledSet = new Set(LOGGABLE_EVENTS);

    function setLogsEditing(enabled) {
      logsEditing = enabled;
      $("logsSaveBtn").disabled = !enabled;
      document.querySelectorAll("#logEventList input[type=checkbox]").forEach(cb => cb.disabled = !enabled);
    }

    function renderLogEventList() {
      const wrap = $("logEventList");
      wrap.innerHTML = "";
      LOGGABLE_EVENTS.forEach(ev => {
        const row = document.createElement("div");
        row.className = "whitebox";
        row.style.margin = "8px 0";
        row.style.padding = "10px 12px";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = logEnabledSet.has(ev);
        cb.disabled = !logsEditing;

        const label = document.createElement("span");
        label.style.marginLeft = "10px";
        label.style.fontWeight = "600";
        label.style.color = "#122b3a";
        label.textContent = ev;

        cb.addEventListener("change", () => {
          if (cb.checked) logEnabledSet.add(ev);
          else logEnabledSet.delete(ev);
        });

        row.appendChild(cb);
        row.appendChild(label);
        wrap.appendChild(row);
      });
    }

    async function logsLoad() {
      setStatus($("logsStatus"), "Loading log settings...", false);
      try {
        const data = await apiJson("/log-settings");
        if (data && Array.isArray(data.enabledEvents)) {
          logEnabledSet = new Set(data.enabledEvents);
        } else if (data && Array.isArray(data.disabledEvents)) {
          logEnabledSet = new Set(LOGGABLE_EVENTS.filter(x => !data.disabledEvents.includes(x)));
        } else {
          logEnabledSet = new Set(LOGGABLE_EVENTS);
        }
        renderLogEventList();
        setLogsEditing(false);
        setStatus($("logsStatus"), "Loaded log settings", false);
      } catch (e) {
        const local = localStorage.getItem("geata_log_enabled_events");
        if (local) {
          try { logEnabledSet = new Set(JSON.parse(local)); } catch {}
        }
        renderLogEventList();
        setLogsEditing(false);
        setStatus($("logsStatus"), "Backend /log-settings not available. Using local settings.", true);
      }
    }

    async function logsSave() {
      try {
        const enabledEvents = Array.from(logEnabledSet.values());
        try {
          await apiJson("/log-settings", { method: "PUT", body: JSON.stringify({ enabledEvents }) });
          setStatus($("logsStatus"), "Saved log settings", false);
        } catch {
          localStorage.setItem("geata_log_enabled_events", JSON.stringify(enabledEvents));
          setStatus($("logsStatus"), "Saved locally (backend endpoint not available)", false);
        }
        setLogsEditing(false);
        renderLogEventList();
      } catch (e) {
        setStatus($("logsStatus"), "Save error: " + e.message, true);
      }
    }

    function initLogsUI() {
      $("logsReloadBtn").addEventListener("click", logsLoad);
      $("logsEditBtn").addEventListener("click", () => {
        setLogsEditing(!logsEditing);
        setStatus($("logsStatus"), logsEditing ? "Edit enabled. Tick items then Save." : "Edit disabled.", false);
        renderLogEventList();
      });
      $("logsSaveBtn").addEventListener("click", logsSave);
    }

    // ------------------------------
    // RECENT EVENTS
    // ------------------------------
    async function loadRecentEvents() {
      const tbody = document.querySelector("#recentEventsTable tbody");
      tbody.innerHTML = "";
      setStatus($("eventsStatus"), "Loading events...", false);

      const deviceId = $("eventsDeviceFilterSelect").value;
      const limit = Math.max(10, Math.min(5000, parseInt($("eventsLimitInput").value || "200", 10)));

      const qs = new URLSearchParams();
      if (deviceId) qs.set("deviceId", deviceId);
      qs.set("limit", String(limit));

      try {
        const data = await apiJson("/events?" + qs.toString());
        (data || []).forEach(ev => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${ev.at || ""}</td>
            <td>${(ev.device_id || "")}${ev.device_name ? " ‚Äì " + ev.device_name : ""}</td>
            <td>${[ev.user_name, ev.user_phone, ev.user_id ? "[" + ev.user_id + "]" : ""].filter(Boolean).join(" | ")}</td>
            <td>${ev.event_type || ""}</td>
            <td>${ev.details || ""}</td>
          `;
          tbody.appendChild(tr);
        });
        setStatus($("eventsStatus"), `Loaded ${data.length} events`, false);
      } catch (e) {
        setStatus($("eventsStatus"), "Load error: " + e.message, true);
      }
    }

    async function purgeEvents() {
      const days = Math.max(1, parseInt($("purgeDaysInput").value || "90", 10));
      if (!confirm(`Purge events older than ${days} days?`)) return;
      try {
        await apiJson("/admin/purge-events", { method: "POST", body: JSON.stringify({ olderThanDays: days }) });
        setStatus($("eventsStatus"), "Purge complete", false);
        await loadRecentEvents();
      } catch (e) {
        setStatus($("eventsStatus"), "Purge failed: " + e.message, true);
      }
    }

    function initEventsUI() {
      $("eventsRefreshBtn").addEventListener("click", loadRecentEvents);
      $("eventsLoadBtn").addEventListener("click", loadRecentEvents);
      $("purgeBtn").addEventListener("click", purgeEvents);
    }

    // ------------------------------
    // NAV wiring
    // ------------------------------
    function initNavigation() {
      document.querySelectorAll("[data-nav]").forEach(btn => {
        btn.addEventListener("click", () => showScreen(btn.getAttribute("data-nav")));
      });
      document.querySelectorAll("[data-back]").forEach(btn => {
        btn.addEventListener("click", () => goBack());
      });
      document.querySelectorAll("[data-home]").forEach(btn => {
        btn.addEventListener("click", () => goHome());
      });
    }

    // ------------------------------
    // Page init
    // ------------------------------
    window.addEventListener("load", async () => {
      initNavigation();
      initAuthUI();
      initDevicesUI();
      initDeviceUsersUI();
      initDeviceSettingsUI();
      initIoUI();
      initUserLookupUI();
      initEditUserUI();
      initAttachUserUI();
      initCsvUI();
      initSchedulesUI();
      initEmailUI();
      initReportsUI();
      initLogsUI();
      initEventsUI();

      await loadDevices();
      await renderDevicesTable();

      await loadUsers(null);
      await renderUserLookupTable(allUsers);

      await loadSchedules();
      await renderSchedules();

      if ($("selectedDeviceSelect")) {
        $("selectedDeviceSelect").value = selectedDeviceId || "";
        updateDeviceContextLabels();
        if (selectedDeviceId) await loadDeviceUsers(selectedDeviceId);
      }

      $("editUserIdBox").textContent = "(none)";
      $("editUserDevicesPills").innerHTML = `<span class="small">Use User Lookup ‚Üí Edit to open a user here.</span>`;

      onEmailUserChanged();
      await logsLoad();
    });
  </script>
</body>
</html>
