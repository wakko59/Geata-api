<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Geata Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg-main: #cfdfee;
      --bg-card: #0b2535;
      --bg-card-soft: #123653;
      --accent: #1c5e86;
      --accent-dark: #1c5e86;
      --accent-soft: rgba(28, 94, 134, 0.2);
      --danger: #d9534f;
      --text-main: #f5f7fa;
      --text-dark: #f5f7fa;
      --text-muted: #7b8a9b;
    }

    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #1e3f5d 0, var(--bg-main) 45%, #b3cde5 100%);
      color: var(--text-main);
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px 16px 40px;
    }
    h1 {
      margin: 0 0 12px;
      font-size: 26px;
      letter-spacing: 0.04em;
    }
    .subtitle {
      margin: 0 0 20px;
      font-size: 13px;
      color: var(--text-muted);
    }
    .card {
      background: var(--bg-card);
      color: var(--text-main);
      border-radius: 14px;
      padding: 14px 16px 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.18);
      margin-bottom: 16px;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .card-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      margin-bottom: 8px;
      gap: 12px;
      flex-wrap: wrap;
    }
    .card-title {
      margin: 0;
      font-size: 18px;
      letter-spacing: 0.02em;
    }
    .card-subtitle {
      margin: 0;
      font-size: 12px;
      color: #2e7d32;
    }
    .pill-title {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent-dark);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 6px;
    }
    label {
      display: block;
      margin-bottom: 4px;
      font-size: 13px;
      font-weight: 500;
      color: #e3f2fd;
    }
    input, select, textarea {
      padding: 7px 9px;
      margin-bottom: 8px;
      border-radius: 8px;
      border: 1px solid #ccd2dd;
      font-size: 13px;
      width: 100%;
    }
    textarea { min-height: 70px; resize: vertical; }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent-dark);
      box-shadow: 0 0 0 1px rgba(0, 123, 255, 0.35);
    }
    button {
      padding: 7px 11px;
      border-radius: 999px;
      border: none;
      background: var(--accent-dark);
      color: #fff;
      font-size: 13px;
      cursor: pointer;
      margin-right: 6px;
      margin-bottom: 6px;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    button.btn-secondary { background: #345a77; }
    button.btn-danger { background: var(--danger); }
    button[disabled] { opacity: 0.5; cursor: default; }

    .btn-small { font-size: 12px; padding: 5px 9px; }

    .status {
      font-size: 12px;
      min-height: 16px;
      margin-top: 4px;
    }
    .status.error { color: #b00020; }
    .status.ok { color: #ffb300; }
    .small { font-size: 12px; color: #2e7d32; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      table-layout: auto;
      min-width: 650px;
      background: var(--bg-card-soft);
      border-radius: 10px;
      overflow: hidden;
    }
    th, td {
      border: 1px solid #2a4358;
      padding: 6px;
      text-align: left;
      vertical-align: top;
    }
    th { background: #17405f; font-weight: 600; }

    .pill {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      background: var(--accent-soft);
      font-size: 11px;
      margin-right: 4px;
      margin-bottom: 2px;
      color: var(--text-main);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .two-column {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }
    @media (max-width: 900px) { .two-column { grid-template-columns: 1fr; } }

    .device-label-big {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #ECFEFF;
    }
    .device-label-value {
      font-size: 13px;
      color: #e3f2fd;
    }
    .section-divider {
      height: 1px;
      margin: 10px 0 12px;
      background: linear-gradient(to right, rgba(0,0,0,0.05), rgba(0,0,0,0));
    }

    .import-export-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: flex-end;
    }
    .import-export-row > div { flex: 1 1 260px; }

    .toggle-row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin: 6px 0 8px;
    }
    .toggle-row input[type="checkbox"] {
      width: auto;
      margin: 0;
      transform: translateY(1px);
    }

    .check-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px 10px;
      margin: 6px 0 8px;
    }
    @media (max-width: 900px) { .check-grid { grid-template-columns: 1fr; } }

    .check-item {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      padding: 8px 10px;
    }
    .check-item input[type="checkbox"] { width: auto; margin: 0; }
    .check-item label { margin: 0; font-weight: 500; }

    code { color: #E3F2FD; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Geata Admin Panel</h1>
    <p class="subtitle">Configure gates, users, schedules, notifications, and audit logs. Admin endpoints require a valid admin API key.</p>

    <!-- Admin Authentication -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="pill-title">Security</div>
          <h2 class="card-title">Admin Authentication</h2>
        </div>
      </div>
      <label for="apiKeyInput">Admin API Key</label>
      <input id="apiKeyInput" type="text" placeholder="Enter admin API key" />
      <button id="setApiKeyBtn">Set Key</button>
      <div id="apiKeyStatus" class="status"></div>
      <p class="small">
        This key must match <code>ADMIN_API_KEY</code> on the backend (Render / local Node).
      </p>
    </div>

    <!-- Devices (list + add) -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="pill-title">Gates</div>
          <h2 class="card-title">Devices</h2>
          <p class="card-subtitle">List and register gate controllers.</p>
        </div>
        <button id="refreshDevicesBtn" class="btn-secondary btn-small">Refresh</button>
      </div>

      <div id="devicesStatus" class="status"></div>

      <table id="devicesTable">
        <thead>
          <tr>
            <th>Device ID</th>
            <th>Name</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="section-divider"></div>

      <h3 style="margin-top: 6px; font-size: 15px;">Add Device</h3>
      <div class="two-column">
        <div>
          <label for="newDeviceId">Device ID</label>
          <input id="newDeviceId" type="text" placeholder="e.g. gate1" />
        </div>
        <div>
          <label for="newDeviceName">Name</label>
          <input id="newDeviceName" type="text" placeholder="e.g. Warehouse Gate" />
        </div>
      </div>
      <button id="addDeviceBtn">Add Device</button>
      <div id="addDeviceStatus" class="status"></div>
    </div>

    <!-- Select Device + Users on selected device -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="pill-title">Per Gate</div>
          <h2 class="card-title">Select Device & Users</h2>
          <p class="card-subtitle">Choose a gate to manage its local users.</p>
        </div>
      </div>

      <label for="selectedDeviceSelect" style="font-size: 14px;">Select Device</label>
      <select id="selectedDeviceSelect">
        <option value="">-- Select a device --</option>
      </select>
      <div class="device-label-big">
        Current Device:
        <span id="selectedDeviceText" class="device-label-value">None selected</span>
      </div>

      <div class="section-divider"></div>

      <h3 style="margin-top: 4px; font-size: 15px;">Users on Selected Device</h3>
      <div id="deviceUsersStatus" class="status"></div>

      <table id="deviceUsersTable">
        <thead>
          <tr>
            <th>User ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Role</th>
            <th>Schedule</th>
            <th>Remove</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- NEW: Email Notifications -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="pill-title">Alerts</div>
          <h2 class="card-title">Email Notifications</h2>
          <p class="card-subtitle">Choose who gets emailed for events on the selected gate.</p>
        </div>
        <div>
          <button id="refreshNotificationsBtn" class="btn-secondary btn-small">Refresh</button>
        </div>
      </div>

      <div class="device-label-big">
        Select Device:
        <span id="selectedDeviceTextNotify" class="device-label-value">None selected</span>
      </div>

      <label for="notifyUserSelect">User</label>
      <select id="notifyUserSelect">
        <option value="">-- Select a user on this device --</option>
      </select>

      <p class="small">
        Tip: choose <code>*</code> to receive all events for this device.
      </p>

      <div id="notifyEventsWrap" class="check-grid"></div>

      <button id="saveNotificationsBtn">Save Notifications</button>
      <div id="notifyStatus" class="status"></div>

      <div class="section-divider"></div>
      <h3 style="margin-top: 4px; font-size: 15px;">Current subscriptions (enabled)</h3>

      <table id="notifyTable">
        <thead>
          <tr>
            <th>User</th>
            <th>Email</th>
            <th>Event Types</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- NEW: Device I/O + Alarm Settings -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="pill-title">I/O + Alarms</div>
          <h2 class="card-title">Device Settings</h2>
          <p class="card-subtitle">Per gate configuration for Aux1 mode, forced/ajar/tamper thresholds and recipients.</p>
        </div>
        <div>
          <button id="loadDeviceSettingsBtn" class="btn-secondary btn-small">Load</button>
        </div>
      </div>

      <div class="device-label-big">
        Select Device:
        <span id="selectedDeviceTextSettings" class="device-label-value">None selected</span>
      </div>

      <div class="two-column">
        <div>
          <label for="aux1ModeSelect">Aux 1 Mode</label>
          <select id="aux1ModeSelect">
            <option value="relay">Option 1: Relay On/Off (RLA ON/OFF)</option>
            <option value="contact">Option 2: Opened/Closed (Input 2 door monitor)</option>
          </select>
          <p class="small">
            Relay mode: app shows RLA ON persistent, OFF for 3s after off. <br/>
            Contact mode: app shows Opened/Closed from Input 2 (3s).
          </p>
        </div>
        <div>
          <label for="supervisorEmailInput">Supervisor Email</label>
          <input id="supervisorEmailInput" type="email" placeholder="supervisor@example.com" />
          <label for="engineerEmailInput">Engineer Email</label>
          <input id="engineerEmailInput" type="email" placeholder="engineer@example.com" />
          <p class="small">
            These are used by backend rules for forced/ajar/tamper/engineer-mode notifications.
          </p>
        </div>
      </div>

      <div class="section-divider"></div>

      <h3 style="margin-top: 4px; font-size: 15px;">Forced + Ajar thresholds</h3>
      <div class="two-column">
        <div>
          <label for="gateAjarWarnInput">Gate Ajar Warn After (HH:MM)</label>
          <input id="gateAjarWarnInput" type="text" placeholder="e.g. 00:02 (2 minutes)" />
          <label for="gateAjarEmailInput">Gate Ajar Email After (HH:MM)</label>
          <input id="gateAjarEmailInput" type="text" placeholder="e.g. 00:05 (5 minutes)" />
          <p class="small">
            Backend should warn in app, then email user + supervisor if still open past Email After.
          </p>
        </div>

        <div>
          <label for="engineerModeMaxInput">Engineer Mode Max Duration (HH:MM)</label>
          <input id="engineerModeMaxInput" type="text" placeholder="e.g. 00:30 (30 minutes)" />
          <div class="toggle-row">
            <input id="emailOnEngineerModeEnable" type="checkbox" />
            <label for="emailOnEngineerModeEnable">Email supervisor + engineer when Engineer Mode activated</label>
          </div>
          <div class="toggle-row">
            <input id="emailOnEngineerModeTimeoutEnable" type="checkbox" />
            <label for="emailOnEngineerModeTimeoutEnable">Email again if Engineer Mode exceeds max duration</label>
          </div>
        </div>
      </div>

      <div class="section-divider"></div>

      <h3 style="margin-top: 4px; font-size: 15px;">Tamper behavior (Input 3)</h3>
      <div class="toggle-row">
        <input id="tamperEmailSupervisorEnable" type="checkbox" />
        <label for="tamperEmailSupervisorEnable">Email supervisor on tamper</label>
      </div>
      <div class="toggle-row">
        <input id="tamperEmailEngineerEnable" type="checkbox" />
        <label for="tamperEmailEngineerEnable">Email engineer on tamper</label>
      </div>
      <div class="toggle-row">
        <input id="tamperRelay3Enable" type="checkbox" />
        <label for="tamperRelay3Enable">In normal mode, switch Relay 3 ON when tamper opens (local siren)</label>
      </div>

      <div class="section-divider"></div>

      <h3 style="margin-top: 4px; font-size: 15px;">Forced rules (email + app)</h3>
      <div class="toggle-row">
        <input id="forcedGateEnable" type="checkbox" />
        <label for="forcedGateEnable">Forced Gate detection (Input 1 opens without valid OPEN command)</label>
      </div>
      <div class="toggle-row">
        <input id="forcedDoorEnable" type="checkbox" />
        <label for="forcedDoorEnable">Forced Door detection (Input 2 opens without valid OPEN command)</label>
      </div>
      <p class="small">
        Backend should email supervisor with last user + time since last command (hh:mm) and trigger flashing app message.
      </p>

      <button id="saveDeviceSettingsBtn">Save Device Settings</button>
      <div id="deviceSettingsStatus" class="status"></div>

      <p class="small">
        Note: this UI calls <code>GET /devices/:id/settings</code> and <code>PUT /devices/:id/settings</code>.
        Add those endpoints in the backend to persist these values.
      </p>
    </div>

    <!-- Add / Attach User to Device -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="pill-title">Per Gate</div>
          <h2 class="card-title">Add / Attach User to Device</h2>
          <p class="card-subtitle">Create new users or attach existing ones to the selected gate.</p>
        </div>
      </div>

      <div class="device-label-big">
        Select Device:
        <span id="selectedDeviceTextAttach" class="device-label-value">None selected</span>
      </div>

      <p class="small">
        Option 1: enter phone/email to create or reuse a user.<br />
        Option 2: paste an existing <strong>User ID</strong> to attach that user directly.
      </p>

      <div class="two-column">
        <div>
          <label for="userNameInput">Name</label>
          <input id="userNameInput" type="text" placeholder="User name" />
        </div>
        <div>
          <label for="userEmailInput">Email</label>
          <input id="userEmailInput" type="email" placeholder="user@example.com" />
        </div>
      </div>

      <div class="two-column">
        <div>
          <label for="userPhoneInput">Phone</label>
          <input id="userPhoneInput" type="tel" placeholder="0861234567 or +353861234567" />
        </div>
        <div>
          <label for="userPasswordInput">Password</label>
          <input id="userPasswordInput" type="password" placeholder="Set/overwrite password (optional)" />
        </div>
      </div>

      <div class="two-column">
        <div>
          <label for="userRoleSelect">Role</label>
          <select id="userRoleSelect">
            <option value="operator">operator</option>
            <option value="admin">admin</option>
          </select>
        </div>
        <div>
          <label for="existingUserIdInput">Existing User ID (optional)</label>
          <input id="existingUserIdInput" type="text" placeholder="e.g. u_1765..." />
        </div>
      </div>

      <label for="attachUserScheduleSelect">Schedule</label>
      <select id="attachUserScheduleSelect">
        <option value="">24/7 (no schedule)</option>
      </select>

      <button id="attachUserBtn">Create/Reuse + Attach</button>
      <div id="attachUserStatus" class="status"></div>
    </div>

    <!-- Bulk Import & Bulk Export -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="pill-title">Data</div>
          <h2 class="card-title">Bulk Import / Export (CSV)</h2>
          <p class="card-subtitle">Import users from CSV or export them for backup/migration.</p>
        </div>
      </div>

      <div class="device-label-big">
        Select Device:
        <span id="selectedDeviceTextCsv" class="device-label-value">None selected</span>
      </div>

      <div class="import-export-row">
        <div>
          <h3 style="margin: 4px 0 6px; font-size: 14px;">Bulk Import from CSV</h3>
          <p class="small">
            CSV columns (header row required): <code>name,email,phone,role</code>.<br />
            <code>role</code> can be <code>admin</code> or <code>operator</code> (default is operator).
          </p>
          <input type="file" id="csvFileInput" accept=".csv,text/csv" />
          <button id="importCsvBtn" class="btn-secondary btn-small">Import CSV for Selected Device</button>
        </div>

        <div>
          <h3 style="margin: 4px 0 6px; font-size: 14px;">Bulk Export to CSV</h3>
          <p class="small">
            Download CSV of users currently attached to the selected gate, or all users/gates.
          </p>
          <button id="exportCsvDeviceBtn" class="btn-secondary btn-small">
            Export Users on Selected Device
          </button>
          <button id="exportAllCsvBtn" class="btn-secondary btn-small">
            Export All Users &amp; Gates
          </button>
        </div>
      </div>

      <div id="csvImportStatus" class="status"></div>
    </div>

    <!-- Device I/O Test -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="pill-title">Hardware</div>
          <h2 class="card-title">Device I/O Test</h2>
          <p class="card-subtitle">Exercise relays and simulate basic behaviour before hardware arrives.</p>
        </div>
      </div>

      <div class="device-label-big">
        Select Device:
        <span id="selectedDeviceTextIo" class="device-label-value">None selected</span>
      </div>

      <p class="small">
        AUX1 and AUX2 test pulses create commands with no user attached (admin test).
      </p>
      <button id="aux1Btn">Test AUX1 Pulse</button>
      <button id="aux2Btn">Test AUX2 Pulse</button>
      <div id="auxStatus" class="status"></div>

      <div class="section-divider"></div>

      <h3 style="margin-top: 4px; font-size: 15px;">Simulate Gate Inputs</h3>
      <p class="small">
        Simulate gate state changes: open, closed, forced open, or gate ajar / open too long.
      </p>
      <button id="simGateOpenedBtn" class="btn-small">Sim Gate Opened</button>
      <button id="simGateClosedBtn" class="btn-small">Sim Gate Closed</button>
      <button id="simGateForcedBtn" class="btn-small">Sim Forced Open</button>
      <button id="simGateAjarBtn" class="btn-small">Sim Gate Ajar / Open Too Long</button>
      <div id="simStatus" class="status"></div>
    </div>

    <!-- Recent Events for Selected Device -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="pill-title">Monitoring</div>
          <h2 class="card-title">Recent Events for Selected Device</h2>
          <p class="card-subtitle">Live view of commands and alerts for the chosen gate.</p>
        </div>
        <button id="refreshDeviceEventsBtn" class="btn-secondary btn-small">Refresh Events</button>
      </div>

      <div class="device-label-big">
        Select Device:
        <span id="selectedDeviceTextEvents" class="device-label-value">None selected</span>
      </div>

      <table id="deviceEventsTable">
        <thead>
          <tr>
            <th>Time (UTC)</th>
            <th>Event</th>
            <th>User</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- User Lookup (All Users) -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="pill-title">Directory</div>
          <h2 class="card-title">User Lookup (All Users)</h2>
          <p class="card-subtitle">Search, inspect and manage users across all gates.</p>
        </div>
      </div>

      <label for="userSearchInput">Search</label>
      <input id="userSearchInput" type="text" placeholder="Search by name, email, or phone" />
      <button id="searchUsersBtn">Search</button>
      <button id="showAllUsersBtn" class="btn-secondary btn-small">Show All</button>
      <div id="userSearchStatus" class="status"></div>

      <div class="device-label-big">
        Attach to Device:
        <span id="selectedDeviceTextDirectory" class="device-label-value">None selected</span>
      </div>
      <button id="attachSelectedUsersBtn" class="btn-secondary btn-small">
        Attach Selected Users to Device
      </button>

      <table id="globalUsersTable">
        <thead>
          <tr>
            <th>Select</th>
            <th>User ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Devices (gate(role))</th>
            <th>Edit</th>
            <th>Delete User</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Edit User Details (global) -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="pill-title">Directory</div>
          <h2 class="card-title">Edit User Details (global)</h2>
          <p class="card-subtitle">Changes apply to the user across all gates.</p>
        </div>
      </div>

      <p id="editUserTarget" class="small"></p>

      <div class="two-column">
        <div>
          <label for="editUserName">Name</label>
          <input id="editUserName" type="text" />
        </div>
        <div>
          <label for="editUserEmail">Email</label>
          <input id="editUserEmail" type="email" />
        </div>
      </div>

      <div class="two-column">
        <div>
          <label for="editUserPhone">Phone</label>
          <input id="editUserPhone" type="tel" />
        </div>
        <div>
          <label for="editUserPassword">Password</label>
          <input id="editUserPassword" type="password" placeholder="Leave blank to keep existing" />
        </div>
      </div>

      <button id="saveUserChangesBtn">Save Changes</button>
      <div id="editUserStatus" class="status"></div>
    </div>

    <!-- Schedules -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="pill-title">Time Control</div>
          <h2 class="card-title">Schedules (Time Templates)</h2>
          <p class="card-subtitle">Define named schedules with up to 6 daily time slots.</p>
        </div>
        <button id="refreshSchedulesBtn" class="btn-secondary btn-small">Refresh</button>
      </div>

      <div id="scheduleStatus" class="status"></div>

      <table id="schedulesTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Slots</th>
            <th>Edit</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="section-divider"></div>

      <h3 id="scheduleFormTitle" style="margin-top: 4px; font-size: 15px;">Create / Edit Schedule</h3>

      <label for="scheduleNameInput">Schedule Name</label>
      <input id="scheduleNameInput" type="text" placeholder="e.g. Weekdays 9–5" />

      <label for="scheduleDescInput">Description (optional)</label>
      <input id="scheduleDescInput" type="text" placeholder="Short description" />

      <p class="small">
        Days: use <code>0–6</code> for Sun–Sat. You can enter ranges like <code>1-5</code> for Mon–Fri,
        or lists like <code>1,2,3,4,5</code>. Blank days = all days.
      </p>

      <table>
        <thead>
          <tr>
            <th>Slot</th>
            <th>Days (0–6)</th>
            <th>Start (HH:MM)</th>
            <th>End (HH:MM)</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>1</td>
            <td><input id="slot1Days" type="text" placeholder="1-5" /></td>
            <td><input id="slot1Start" type="time" /></td>
            <td><input id="slot1End" type="time" /></td>
          </tr>
          <tr>
            <td>2</td>
            <td><input id="slot2Days" type="text" placeholder="1-5" /></td>
            <td><input id="slot2Start" type="time" /></td>
            <td><input id="slot2End" type="time" /></td>
          </tr>
          <tr>
            <td>3</td>
            <td><input id="slot3Days" type="text" placeholder="1-5" /></td>
            <td><input id="slot3Start" type="time" /></td>
            <td><input id="slot3End" type="time" /></td>
          </tr>
          <tr>
            <td>4</td>
            <td><input id="slot4Days" type="text" placeholder="1-5" /></td>
            <td><input id="slot4Start" type="time" /></td>
            <td><input id="slot4End" type="time" /></td>
          </tr>
          <tr>
            <td>5</td>
            <td><input id="slot5Days" type="text" placeholder="1-5" /></td>
            <td><input id="slot5Start" type="time" /></td>
            <td><input id="slot5End" type="time" /></td>
          </tr>
          <tr>
            <td>6</td>
            <td><input id="slot6Days" type="text" placeholder="1-5" /></td>
            <td><input id="slot6Start" type="time" /></td>
            <td><input id="slot6End" type="time" /></td>
          </tr>
        </tbody>
      </table>

      <button id="saveScheduleBtn">Save Schedule</button>
      <button id="resetScheduleFormBtn" class="btn-secondary btn-small">Reset Form</button>
    </div>

    <!-- Reports / Audit Trail -->
    <div class="card">
      <div class="card-header">
        <div>
          <div class="pill-title">Audit</div>
          <h2 class="card-title">Reports / Audit Trail</h2>
          <p class="card-subtitle">Generate reports of gate events by device, user and date range.</p>
        </div>
      </div>

      <div class="two-column">
        <div>
          <label for="reportDeviceSelect" style="font-size: 14px;">Select Device</label>
          <select id="reportDeviceSelect">
            <option value="">-- Any device --</option>
          </select>
        </div>
        <div>
          <label for="reportUserIdInput" style="font-size: 14px;">Select User ID (optional)</label>
          <input id="reportUserIdInput" type="text" placeholder="Paste User ID, e.g. u_..." />
        </div>
      </div>

      <div class="two-column">
        <div>
          <label for="reportFromDate">From date</label>
          <input id="reportFromDate" type="date" />
        </div>
        <div>
          <label for="reportToDate">To date</label>
          <input id="reportToDate" type="date" />
        </div>
      </div>

      <button id="runReportBtn">Run Report</button>
      <button id="downloadReportCsvBtn" class="btn-secondary btn-small">Download CSV</button>
      <div id="reportStatus" class="status"></div>

      <table id="reportEventsTable">
        <thead>
          <tr>
            <th>Time (UTC)</th>
            <th>Device</th>
            <th>User</th>
            <th>Event</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="section-divider"></div>

      <!-- NEW: Purge logs -->
      <h3 style="margin-top: 4px; font-size: 15px;">Purge Logs</h3>
      <p class="small">
        Purge device_events older than a chosen number of days (admin action). Requires backend endpoint <code>POST /admin/purge-events</code>.
      </p>
      <div class="two-column">
        <div>
          <label for="purgeOlderThanDays">Delete events older than (days)</label>
          <input id="purgeOlderThanDays" type="number" min="1" value="90" />
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="purgeEventsBtn" class="btn-danger">Purge</button>
        </div>
      </div>
      <div id="purgeStatus" class="status"></div>
    </div>

  </div>

<script>
  let apiKey = "";
  let selectedDeviceId = "";
  let allSchedules = [];
  let editingUserId = null;
  let editingScheduleId = null;
  let deviceEventsPollTimer = null;

  function setStatus(el, msg, isError) {
    if (!el) return;
    el.textContent = msg || "";
    el.className = "status" + (isError ? " error" : " ok");
  }

  function getHeadersJson() {
    const headers = { "Content-Type": "application/json" };
    if (apiKey) headers["x-api-key"] = apiKey;
    return headers;
  }

  async function fetchJson(url, opts) {
    const res = await fetch(url, opts);
    const data = await res.json().catch(() => ({}));
    return { res, data };
  }

  function dayName(d) {
    return ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][d] || "?";
  }

  function describeSlots(slots) {
    if (!slots || slots.length === 0) return "No slots (no access)";
    return slots.map(function (s) {
      var days = Array.isArray(s.daysOfWeek) ? s.daysOfWeek : [];
      var dayStr = days.length ? days.map(dayName).join(",") : "All days";
      return dayStr + " " + (s.start || "") + "-" + (s.end || "");
    }).join(" | ");
  }

  function parseDaysString(str) {
    var result = [];
    var s = (str || "").trim();
    if (!s) return [];
    var parts = s.split(",");
    parts.forEach(function (part) {
      var t = part.trim();
      if (!t) return;
      if (t.indexOf("-") !== -1) {
        var ab = t.split("-");
        var a = parseInt(ab[0].trim(), 10);
        var b = parseInt(ab[1].trim(), 10);
        if (!isNaN(a) && !isNaN(b)) {
          var step = a <= b ? 1 : -1;
          for (var d = a; step > 0 ? d <= b : d >= b; d += step) {
            if (d >= 0 && d <= 6 && result.indexOf(d) === -1) result.push(d);
          }
        }
      } else {
        var n = parseInt(t, 10);
        if (!isNaN(n) && n >= 0 && n <= 6 && result.indexOf(n) === -1) result.push(n);
      }
    });
    result.sort(function (a,b) { return a - b; });
    return result;
  }

  function updateSelectedDeviceLabels(selectedDeviceSelect) {
    var labelText = "None selected";
    if (selectedDeviceSelect) {
      var opt = selectedDeviceSelect.options[selectedDeviceSelect.selectedIndex];
      if (opt && opt.value) labelText = opt.textContent;
    }
    [
      "selectedDeviceText",
      "selectedDeviceTextAttach",
      "selectedDeviceTextCsv",
      "selectedDeviceTextIo",
      "selectedDeviceTextEvents",
      "selectedDeviceTextDirectory",
      "selectedDeviceTextNotify",
      "selectedDeviceTextSettings"
    ].forEach(function (id) {
      var el = document.getElementById(id);
      if (el) el.textContent = labelText;
    });
  }

  function startDeviceEventsPolling(selectedDeviceSelect) {
    if (deviceEventsPollTimer) clearInterval(deviceEventsPollTimer);
    if (!selectedDeviceId) return;
    deviceEventsPollTimer = setInterval(function () {
      loadDeviceEvents(selectedDeviceId);
    }, 5000);
    updateSelectedDeviceLabels(selectedDeviceSelect);
  }

  function stopDeviceEventsPolling() {
    if (deviceEventsPollTimer) {
      clearInterval(deviceEventsPollTimer);
      deviceEventsPollTimer = null;
    }
  }

  // Duration parse: "HH:MM" -> seconds
  function parseHHMMToSeconds(s) {
    const t = String(s || "").trim();
    if (!t) return null;
    const m = t.match(/^(\d{1,2}):(\d{2})$/);
    if (!m) return null;
    const hh = parseInt(m[1], 10);
    const mm = parseInt(m[2], 10);
    if (isNaN(hh) || isNaN(mm)) return null;
    return hh * 3600 + mm * 60;
  }

  function secondsToHHMM(sec) {
    if (sec == null || isNaN(sec)) return "";
    sec = Math.max(0, Number(sec));
    const hh = Math.floor(sec / 3600);
    const mm = Math.floor((sec % 3600) / 60);
    const pad = n => (n < 10 ? "0" + n : "" + n);
    return pad(hh) + ":" + pad(mm);
  }

  // ===== Notifications =====
  const EVENT_TYPES = [
    "*",
    "OPEN_REQUESTED",
    "AUX1_REQUESTED",
    "AUX2_REQUESTED",
    "CMD_COMPLETED",
    "GATE_OPENED",
    "GATE_CLOSED",
    "GATE_FORCED_OPEN",
    "GATE_OPEN_TOO_LONG",
    "DOOR_FORCED_OPEN",
    "TAMPER_OPENED",
    "ENGINEER_MODE_ON",
    "ENGINEER_MODE_TIMEOUT",
    "ENGINEER_MODE_OFF"
  ];

  function buildNotifyCheckboxes() {
    var wrap = document.getElementById("notifyEventsWrap");
    if (!wrap) return;
    wrap.innerHTML = "";
    EVENT_TYPES.forEach(function (ev) {
      var row = document.createElement("div");
      row.className = "check-item";
      var cb = document.createElement("input");
      cb.type = "checkbox";
      cb.dataset.ev = ev;
      cb.id = "ev_" + ev;

      var lab = document.createElement("label");
      lab.htmlFor = cb.id;
      lab.textContent = ev;

      row.appendChild(cb);
      row.appendChild(lab);
      wrap.appendChild(row);
    });
  }

  function getSelectedEventTypes() {
    var wrap = document.getElementById("notifyEventsWrap");
    if (!wrap) return [];
    var cbs = wrap.querySelectorAll("input[type=checkbox]:checked");
    return Array.prototype.map.call(cbs, function (cb) { return cb.dataset.ev; });
  }

  async function loadDeviceNotifications(deviceId) {
    var tbody = document.querySelector("#notifyTable tbody");
    var status = document.getElementById("notifyStatus");
    if (!tbody || !status) return;
    tbody.innerHTML = "";
    setStatus(status, "Loading notifications...", false);

    try {
      var out = await fetchJson("/devices/" + encodeURIComponent(deviceId) + "/notifications", {
        method: "GET",
        headers: getHeadersJson()
      });

      if (!out.res.ok) {
        setStatus(status, (out.data && out.data.error) ? out.data.error : ("HTTP " + out.res.status), true);
        return;
      }

      (out.data || []).forEach(function (row) {
        var tr = document.createElement("tr");
        var tdName = document.createElement("td");
        var tdEmail = document.createElement("td");
        var tdTypes = document.createElement("td");
        tdName.textContent = row.name || row.userId || "";
        tdEmail.textContent = row.email || "";
        tdTypes.textContent = (row.eventTypes || []).join(", ");
        tr.appendChild(tdName);
        tr.appendChild(tdEmail);
        tr.appendChild(tdTypes);
        tbody.appendChild(tr);
      });

      setStatus(status, "Loaded " + (out.data ? out.data.length : 0) + " subscriptions", false);
    } catch (err) {
      console.error(err);
      setStatus(status, "Error loading notifications", true);
    }
  }

  async function saveUserNotifications(deviceId, userId, eventTypes) {
    var status = document.getElementById("notifyStatus");
    setStatus(status, "Saving notifications...", false);

    try {
      var out = await fetchJson("/devices/" + encodeURIComponent(deviceId) + "/users/" + encodeURIComponent(userId) + "/notifications", {
        method: "PUT",
        headers: getHeadersJson(),
        body: JSON.stringify({ eventTypes: eventTypes })
      });

      if (!out.res.ok) {
        setStatus(status, (out.data && out.data.error) ? out.data.error : ("HTTP " + out.res.status), true);
        return;
      }

      setStatus(status, "Saved", false);
      await loadDeviceNotifications(deviceId);
    } catch (err) {
      console.error(err);
      setStatus(status, "Error saving notifications", true);
    }
  }

  // ===== Device Settings (expects backend endpoints) =====
  async function loadDeviceSettings(deviceId) {
    var st = document.getElementById("deviceSettingsStatus");
    setStatus(st, "Loading device settings...", false);

    try {
      var out = await fetchJson("/devices/" + encodeURIComponent(deviceId) + "/settings", {
        method: "GET",
        headers: getHeadersJson()
      });

      if (!out.res.ok) {
        setStatus(st, (out.data && out.data.error) ? out.data.error : ("Not implemented (HTTP " + out.res.status + ")"), true);
        return;
      }

      var s = out.data || {};

      document.getElementById("aux1ModeSelect").value = s.aux1Mode || "relay";
      document.getElementById("supervisorEmailInput").value = s.supervisorEmail || "";
      document.getElementById("engineerEmailInput").value = s.engineerEmail || "";

      document.getElementById("gateAjarWarnInput").value = secondsToHHMM(s.gateAjarWarnSec);
      document.getElementById("gateAjarEmailInput").value = secondsToHHMM(s.gateAjarEmailSec);
      document.getElementById("engineerModeMaxInput").value = secondsToHHMM(s.engineerModeMaxSec);

      document.getElementById("emailOnEngineerModeEnable").checked = !!s.emailOnEngineerModeEnable;
      document.getElementById("emailOnEngineerModeTimeoutEnable").checked = !!s.emailOnEngineerModeTimeoutEnable;

      document.getElementById("tamperEmailSupervisorEnable").checked = !!s.tamperEmailSupervisorEnable;
      document.getElementById("tamperEmailEngineerEnable").checked = !!s.tamperEmailEngineerEnable;
      document.getElementById("tamperRelay3Enable").checked = !!s.tamperRelay3Enable;

      document.getElementById("forcedGateEnable").checked = !!s.forcedGateEnable;
      document.getElementById("forcedDoorEnable").checked = !!s.forcedDoorEnable;

      setStatus(st, "Loaded settings", false);
    } catch (err) {
      console.error(err);
      setStatus(st, "Error loading settings", true);
    }
  }

  async function saveDeviceSettings(deviceId) {
    var st = document.getElementById("deviceSettingsStatus");

    const payload = {
      aux1Mode: document.getElementById("aux1ModeSelect").value,
      supervisorEmail: document.getElementById("supervisorEmailInput").value.trim(),
      engineerEmail: document.getElementById("engineerEmailInput").value.trim(),

      gateAjarWarnSec: parseHHMMToSeconds(document.getElementById("gateAjarWarnInput").value),
      gateAjarEmailSec: parseHHMMToSeconds(document.getElementById("gateAjarEmailInput").value),
      engineerModeMaxSec: parseHHMMToSeconds(document.getElementById("engineerModeMaxInput").value),

      emailOnEngineerModeEnable: document.getElementById("emailOnEngineerModeEnable").checked,
      emailOnEngineerModeTimeoutEnable: document.getElementById("emailOnEngineerModeTimeoutEnable").checked,

      tamperEmailSupervisorEnable: document.getElementById("tamperEmailSupervisorEnable").checked,
      tamperEmailEngineerEnable: document.getElementById("tamperEmailEngineerEnable").checked,
      tamperRelay3Enable: document.getElementById("tamperRelay3Enable").checked,

      forcedGateEnable: document.getElementById("forcedGateEnable").checked,
      forcedDoorEnable: document.getElementById("forcedDoorEnable").checked
    };

    // Basic validation for HH:MM fields
    const bad =
      (document.getElementById("gateAjarWarnInput").value.trim() && payload.gateAjarWarnSec == null) ||
      (document.getElementById("gateAjarEmailInput").value.trim() && payload.gateAjarEmailSec == null) ||
      (document.getElementById("engineerModeMaxInput").value.trim() && payload.engineerModeMaxSec == null);

    if (bad) {
      setStatus(st, "Invalid time format. Use HH:MM (e.g. 00:05).", true);
      return;
    }

    setStatus(st, "Saving device settings...", false);

    try {
      var out = await fetchJson("/devices/" + encodeURIComponent(deviceId) + "/settings", {
        method: "PUT",
        headers: getHeadersJson(),
        body: JSON.stringify(payload)
      });

      if (!out.res.ok) {
        setStatus(st, (out.data && out.data.error) ? out.data.error : ("Not implemented (HTTP " + out.res.status + ")"), true);
        return;
      }

      setStatus(st, "Saved settings", false);
    } catch (err) {
      console.error(err);
      setStatus(st, "Error saving settings", true);
    }
  }

  // ===== Purge logs (expects backend endpoint) =====
  async function purgeEventsOlderThan(days) {
    var st = document.getElementById("purgeStatus");
    if (!days || days < 1) {
      setStatus(st, "Enter a valid number of days", true);
      return;
    }
    if (!window.confirm("Permanently delete events older than " + days + " days?")) return;

    setStatus(st, "Purging...", false);

    try {
      var out = await fetchJson("/admin/purge-events", {
        method: "POST",
        headers: getHeadersJson(),
        body: JSON.stringify({ olderThanDays: days })
      });

      if (!out.res.ok) {
        setStatus(st, (out.data && out.data.error) ? out.data.error : ("Not implemented (HTTP " + out.res.status + ")"), true);
        return;
      }

      setStatus(st, "Purge complete", false);
    } catch (err) {
      console.error(err);
      setStatus(st, "Error purging events", true);
    }
  }

  // ===== Existing page logic =====
  window.addEventListener("load", function () {
    buildNotifyCheckboxes();

    var apiKeyInput = document.getElementById("apiKeyInput");
    var setApiKeyBtn = document.getElementById("setApiKeyBtn");
    var apiKeyStatus = document.getElementById("apiKeyStatus");

    var refreshDevicesBtn = document.getElementById("refreshDevicesBtn");
    var devicesTableBody = document.querySelector("#devicesTable tbody");
    var devicesStatus = document.getElementById("devicesStatus");
    var newDeviceIdInput = document.getElementById("newDeviceId");
    var newDeviceNameInput = document.getElementById("newDeviceName");
    var addDeviceBtn = document.getElementById("addDeviceBtn");
    var addDeviceStatus = document.getElementById("addDeviceStatus");
    var selectedDeviceSelect = document.getElementById("selectedDeviceSelect");

    var deviceUsersTableBody = document.querySelector("#deviceUsersTable tbody");
    var deviceUsersStatus = document.getElementById("deviceUsersStatus");

    var userNameInput = document.getElementById("userNameInput");
    var userEmailInput = document.getElementById("userEmailInput");
    var userPhoneInput = document.getElementById("userPhoneInput");
    var userPasswordInput = document.getElementById("userPasswordInput");
    var userRoleSelect = document.getElementById("userRoleSelect");
    var existingUserIdInput = document.getElementById("existingUserIdInput");
    var attachUserScheduleSelect = document.getElementById("attachUserScheduleSelect");
    var attachUserBtn = document.getElementById("attachUserBtn");
    var attachUserStatus = document.getElementById("attachUserStatus");

    var csvFileInput = document.getElementById("csvFileInput");
    var importCsvBtn = document.getElementById("importCsvBtn");
    var exportCsvDeviceBtn = document.getElementById("exportCsvDeviceBtn");
    var exportAllCsvBtn = document.getElementById("exportAllCsvBtn");
    var csvImportStatus = document.getElementById("csvImportStatus");

    var aux1Btn = document.getElementById("aux1Btn");
    var aux2Btn = document.getElementById("aux2Btn");
    var auxStatus = document.getElementById("auxStatus");

    var simGateOpenedBtn = document.getElementById("simGateOpenedBtn");
    var simGateClosedBtn = document.getElementById("simGateClosedBtn");
    var simGateForcedBtn = document.getElementById("simGateForcedBtn");
    var simGateAjarBtn = document.getElementById("simGateAjarBtn");
    var simStatus = document.getElementById("simStatus");

    var deviceEventsTableBody = document.querySelector("#deviceEventsTable tbody");
    var refreshDeviceEventsBtn = document.getElementById("refreshDeviceEventsBtn");

    var userSearchInput = document.getElementById("userSearchInput");
    var searchUsersBtn = document.getElementById("searchUsersBtn");
    var showAllUsersBtn = document.getElementById("showAllUsersBtn");
    var userSearchStatus = document.getElementById("userSearchStatus");
    var globalUsersTableBody = document.querySelector("#globalUsersTable tbody");
    var attachSelectedUsersBtn = document.getElementById("attachSelectedUsersBtn");

    var editUserTarget = document.getElementById("editUserTarget");
    var editUserName = document.getElementById("editUserName");
    var editUserEmail = document.getElementById("editUserEmail");
    var editUserPhone = document.getElementById("editUserPhone");
    var editUserPassword = document.getElementById("editUserPassword");
    var saveUserChangesBtn = document.getElementById("saveUserChangesBtn");
    var editUserStatus = document.getElementById("editUserStatus");

    var schedulesTableBody = document.querySelector("#schedulesTable tbody");
    var refreshSchedulesBtn = document.getElementById("refreshSchedulesBtn");
    var scheduleStatus = document.getElementById("scheduleStatus");
    var scheduleFormTitle = document.getElementById("scheduleFormTitle");
    var scheduleNameInput = document.getElementById("scheduleNameInput");
    var scheduleDescInput = document.getElementById("scheduleDescInput");
    var saveScheduleBtn = document.getElementById("saveScheduleBtn");
    var resetScheduleFormBtn = document.getElementById("resetScheduleFormBtn");

    var reportDeviceSelect = document.getElementById("reportDeviceSelect");
    var reportUserIdInput = document.getElementById("reportUserIdInput");
    var reportFromDate = document.getElementById("reportFromDate");
    var reportToDate = document.getElementById("reportToDate");
    var runReportBtn = document.getElementById("runReportBtn");
    var downloadReportCsvBtn = document.getElementById("downloadReportCsvBtn");
    var reportStatus = document.getElementById("reportStatus");
    var reportEventsTableBody = document.querySelector("#reportEventsTable tbody");

    var notifyUserSelect = document.getElementById("notifyUserSelect");
    var refreshNotificationsBtn = document.getElementById("refreshNotificationsBtn");
    var saveNotificationsBtn = document.getElementById("saveNotificationsBtn");

    var loadDeviceSettingsBtn = document.getElementById("loadDeviceSettingsBtn");
    var saveDeviceSettingsBtn = document.getElementById("saveDeviceSettingsBtn");

    var purgeEventsBtn = document.getElementById("purgeEventsBtn");
    var purgeOlderThanDays = document.getElementById("purgeOlderThanDays");
    var purgeStatus = document.getElementById("purgeStatus");

    var slotInputs = [];
    for (var i = 1; i <= 6; i++) {
      slotInputs.push({
        days:  document.getElementById("slot" + i + "Days"),
        start: document.getElementById("slot" + i + "Start"),
        end:   document.getElementById("slot" + i + "End")
      });
    }

    // --- Admin key handler with auto-refresh ---
    if (setApiKeyBtn) {
      setApiKeyBtn.addEventListener("click", function () {
        apiKey = apiKeyInput.value.trim();
        const hasKey = !!apiKey;

        setStatus(apiKeyStatus, hasKey ? "API key set" : "API key cleared", false);

        // Clear previous errors from panels
        setStatus(devicesStatus, "", false);
        setStatus(deviceUsersStatus, "", false);
        setStatus(csvImportStatus, "", false);
        setStatus(auxStatus, "", false);
        setStatus(simStatus, "", false);
        setStatus(userSearchStatus, "", false);
        setStatus(editUserStatus, "", false);
        setStatus(scheduleStatus, "", false);
        setStatus(reportStatus, "", false);
        setStatus(document.getElementById("notifyStatus"), "", false);
        setStatus(document.getElementById("deviceSettingsStatus"), "", false);
        setStatus(purgeStatus, "", false);

        if (hasKey) {
          loadDevices();
          loadUsers(null);
          loadSchedules();

          if (selectedDeviceId) {
            loadDeviceUsers(selectedDeviceId);
            loadDeviceEvents(selectedDeviceId);
            loadDeviceNotifications(selectedDeviceId);
          }
        }
      });
    }

    // ---- Devices ----
    function rebuildAttachUserScheduleOptions() {
      var sel = attachUserScheduleSelect;
      if (!sel) return;
      var currentValue = sel.value;
      sel.innerHTML = "";
      var defOpt = document.createElement("option");
      defOpt.value = "";
      defOpt.textContent = "24/7 (no schedule)";
      sel.appendChild(defOpt);
      allSchedules.forEach(function (s) {
        var opt = document.createElement("option");
        opt.value = String(s.id);
        opt.textContent = s.name;
        sel.appendChild(opt);
      });
      if (currentValue && allSchedules.some(function (s) { return String(s.id) === currentValue; })) {
        sel.value = currentValue;
      }
    }

    async function loadDevices() {
      if (!devicesTableBody || !devicesStatus || !selectedDeviceSelect) return;
      devicesTableBody.innerHTML = "";
      selectedDeviceSelect.innerHTML = '<option value="">-- Select a device --</option>';
      if (reportDeviceSelect) reportDeviceSelect.innerHTML = '<option value="">-- Any device --</option>';
      setStatus(devicesStatus, "Loading devices...", false);

      try {
        var out = await fetchJson("/devices", { method: "GET", headers: getHeadersJson() });
        if (!out.res.ok) {
          setStatus(devicesStatus, out.data.error || ("HTTP " + out.res.status), true);
          return;
        }

        (out.data || []).forEach(function (d) {
          var tr = document.createElement("tr");
          var tdId = document.createElement("td");
          var tdName = document.createElement("td");
          tdId.textContent = d.id;
          tdName.textContent = d.name;
          tr.appendChild(tdId);
          tr.appendChild(tdName);
          devicesTableBody.appendChild(tr);

          var opt = document.createElement("option");
          opt.value = d.id;
          opt.textContent = d.id + " – " + d.name;
          selectedDeviceSelect.appendChild(opt);

          if (reportDeviceSelect) {
            var opt2 = document.createElement("option");
            opt2.value = d.id;
            opt2.textContent = d.id + " – " + d.name;
            reportDeviceSelect.appendChild(opt2);
          }
        });

        updateSelectedDeviceLabels(selectedDeviceSelect);
        setStatus(devicesStatus, "Loaded " + (out.data ? out.data.length : 0) + " devices", false);
      } catch (err) {
        console.error(err);
        setStatus(devicesStatus, "Error loading devices", true);
      }
    }

    if (refreshDevicesBtn) refreshDevicesBtn.addEventListener("click", function () { loadDevices(); });

    if (addDeviceBtn) {
      addDeviceBtn.addEventListener("click", async function () {
        var id = newDeviceIdInput.value.trim();
        var name = newDeviceNameInput.value.trim();
        if (!id || !name) {
          setStatus(addDeviceStatus, "Device ID and Name are required", true);
          return;
        }
        setStatus(addDeviceStatus, "Creating device...", false);
        try {
          var out = await fetchJson("/devices", {
            method: "POST",
            headers: getHeadersJson(),
            body: JSON.stringify({ id: id, name: name })
          });
          if (!out.res.ok) {
            setStatus(addDeviceStatus, out.data.error || ("HTTP " + out.res.status), true);
            return;
          }
          setStatus(addDeviceStatus, "Device created", false);
          newDeviceIdInput.value = "";
          newDeviceNameInput.value = "";
          await loadDevices();
        } catch (err) {
          console.error(err);
          setStatus(addDeviceStatus, "Error creating device", true);
        }
      });
    }

    if (selectedDeviceSelect) {
      selectedDeviceSelect.addEventListener("change", function () {
        selectedDeviceId = selectedDeviceSelect.value;

        if (deviceUsersTableBody) deviceUsersTableBody.innerHTML = "";
        if (deviceEventsTableBody) deviceEventsTableBody.innerHTML = "";

        setStatus(deviceUsersStatus, "", false);
        setStatus(auxStatus, "", false);
        setStatus(simStatus, "", false);

        updateSelectedDeviceLabels(selectedDeviceSelect);

        if (selectedDeviceId) {
          loadDeviceUsers(selectedDeviceId);
          loadDeviceEvents(selectedDeviceId);
          loadDeviceNotifications(selectedDeviceId);
          startDeviceEventsPolling(selectedDeviceSelect);
        } else {
          stopDeviceEventsPolling();
        }
      });
    }

    async function loadDeviceUsers(deviceId) {
      if (!deviceUsersTableBody || !deviceUsersStatus) return;
      deviceUsersTableBody.innerHTML = "";
      setStatus(deviceUsersStatus, "Loading users...", false);

      try {
        var out = await fetchJson("/devices/" + encodeURIComponent(deviceId) + "/users", {
          method: "GET",
          headers: getHeadersJson()
        });

        if (!out.res.ok) {
          setStatus(deviceUsersStatus, out.data.error || ("HTTP " + out.res.status), true);
          return;
        }

        // Populate notification user dropdown from device users
        if (notifyUserSelect) {
          notifyUserSelect.innerHTML = '<option value="">-- Select a user on this device --</option>';
          (out.data || []).forEach(function (u) {
            var opt = document.createElement("option");
            opt.value = u.userId;
            opt.textContent = (u.name || u.userId) + (u.email ? (" <" + u.email + ">") : "");
            notifyUserSelect.appendChild(opt);
          });
        }

        (out.data || []).forEach(function (u) {
          var tr = document.createElement("tr");
          var tdId = document.createElement("td");
          var tdName = document.createElement("td");
          var tdEmail = document.createElement("td");
          var tdPhone = document.createElement("td");
          var tdRole = document.createElement("td");
          var tdSchedule = document.createElement("td");
          var tdRemove = document.createElement("td");

          tdId.textContent = u.userId;
          tdName.textContent = u.name || "";
          tdEmail.textContent = u.email || "";
          tdPhone.textContent = u.phone || "";
          tdRole.textContent = u.role || "";

          var sel = document.createElement("select");
          var defOpt = document.createElement("option");
          defOpt.value = "";
          defOpt.textContent = "24/7 (no schedule)";
          sel.appendChild(defOpt);

          allSchedules.forEach(function (s) {
            var opt = document.createElement("option");
            opt.value = String(s.id);
            opt.textContent = s.name;
            sel.appendChild(opt);
          });

          if (u.scheduleId) sel.value = String(u.scheduleId);

          var saveBtn = document.createElement("button");
          saveBtn.textContent = "Save";
          saveBtn.className = "btn-small";
          saveBtn.style.marginLeft = "6px";
          saveBtn.addEventListener("click", function () {
            var chosen = sel.value || null;
            assignScheduleToUser(deviceId, u.userId, chosen);
          });

          tdSchedule.appendChild(sel);
          tdSchedule.appendChild(saveBtn);

          var removeBtn = document.createElement("button");
          removeBtn.textContent = "Remove";
          removeBtn.className = "btn-danger btn-small";
          removeBtn.addEventListener("click", function () {
            removeUserFromDevice(deviceId, u.userId);
          });
          tdRemove.appendChild(removeBtn);

          tr.appendChild(tdId);
          tr.appendChild(tdName);
          tr.appendChild(tdEmail);
          tr.appendChild(tdPhone);
          tr.appendChild(tdRole);
          tr.appendChild(tdSchedule);
          tr.appendChild(tdRemove);
          deviceUsersTableBody.appendChild(tr);
        });

        setStatus(deviceUsersStatus, "Loaded " + (out.data ? out.data.length : 0) + " users for device", false);
      } catch (err) {
        console.error(err);
        setStatus(deviceUsersStatus, "Error loading device users", true);
      }
    }

    async function removeUserFromDevice(deviceId, userId) {
      if (!window.confirm("Remove user " + userId + " from device " + deviceId + "?")) return;
      try {
        var out = await fetchJson("/devices/" + encodeURIComponent(deviceId) + "/users/" + encodeURIComponent(userId), {
          method: "DELETE",
          headers: getHeadersJson()
        });
        if (!out.res.ok) {
          setStatus(deviceUsersStatus, out.data.error || ("HTTP " + out.res.status), true);
          return;
        }
        setStatus(deviceUsersStatus, "Removed user " + userId + " from device", false);
        await loadDeviceUsers(deviceId);
      } catch (err) {
        console.error(err);
        setStatus(deviceUsersStatus, "Error removing user", true);
      }
    }

    async function assignScheduleToUser(deviceId, userId, scheduleId) {
      setStatus(deviceUsersStatus, "Saving schedule...", false);
      try {
        var out = await fetchJson("/devices/" + encodeURIComponent(deviceId) + "/users/" + encodeURIComponent(userId) + "/schedule-assignment", {
          method: "PUT",
          headers: getHeadersJson(),
          body: JSON.stringify({ scheduleId: scheduleId })
        });
        if (!out.res.ok) {
          setStatus(deviceUsersStatus, out.data.error || ("HTTP " + out.res.status), true);
          return;
        }
        setStatus(deviceUsersStatus, "Schedule updated", false);
      } catch (err) {
        console.error(err);
        setStatus(deviceUsersStatus, "Error saving schedule", true);
      }
    }

    if (attachUserBtn) {
      attachUserBtn.addEventListener("click", async function () {
        if (!selectedDeviceId) {
          setStatus(attachUserStatus, "Select a device first", true);
          return;
        }
        var name = userNameInput.value.trim();
        var email = userEmailInput.value.trim();
        var phone = userPhoneInput.value.trim();
        var password = userPasswordInput.value;
        var role = userRoleSelect.value || "operator";
        var scheduleId = attachUserScheduleSelect.value || null;
        var existingUserId = existingUserIdInput.value.trim();

        var body;
        if (existingUserId) {
          body = { userId: existingUserId, role: role };
        } else {
          if (!email && !phone) {
            setStatus(attachUserStatus, "At least email or phone is required (or provide a User ID)", true);
            return;
          }
          body = { name: name, email: email, phone: phone, password: password, role: role };
        }

        setStatus(attachUserStatus, "Attaching user...", false);
        try {
          var out = await fetchJson("/devices/" + encodeURIComponent(selectedDeviceId) + "/users", {
            method: "POST",
            headers: getHeadersJson(),
            body: JSON.stringify(body)
          });
          if (!out.res.ok) {
            setStatus(attachUserStatus, out.data.error || ("HTTP " + out.res.status), true);
            return;
          }
          var attachedUserId = out.data.userId || (out.data.user && out.data.user.id);
          if (attachedUserId && scheduleId) {
            await assignScheduleToUser(selectedDeviceId, attachedUserId, scheduleId);
          }
          setStatus(attachUserStatus, "User attached to device", false);
          existingUserIdInput.value = "";
          await loadDeviceUsers(selectedDeviceId);
        } catch (err) {
          console.error(err);
          setStatus(attachUserStatus, "Error attaching user", true);
        }
      });
    }

    // ---- CSV parsing / import / export ----
    function parseCsv(text) {
      var lines = text
        .split(/\r?\n/)
        .map(function (l) { return l.trim(); })
        .filter(function (l) { return l.length > 0; });

      if (lines.length === 0) return [];
      var header = lines[0].split(",").map(function (h) { return h.trim().toLowerCase(); });
      var nameIdx  = header.indexOf("name");
      var emailIdx = header.indexOf("email");
      var phoneIdx = header.indexOf("phone");
      var roleIdx  = header.indexOf("role");
      var rows = [];
      for (var i = 1; i < lines.length; i++) {
        var parts = lines[i].split(",").map(function (p) { return p.trim(); });
        var row = {
          name:  nameIdx  >= 0 ? (parts[nameIdx]  || "") : "",
          email: emailIdx >= 0 ? (parts[emailIdx] || "") : "",
          phone: phoneIdx >= 0 ? (parts[phoneIdx] || "") : "",
          role:  roleIdx  >= 0 ? (parts[roleIdx]  || "") : ""
        };
        rows.push(row);
      }
      return rows;
    }

    if (importCsvBtn) {
      importCsvBtn.addEventListener("click", function () {
        if (!selectedDeviceId) {
          setStatus(csvImportStatus, "Select a device first", true);
          return;
        }
        var file = csvFileInput.files[0];
        if (!file) {
          setStatus(csvImportStatus, "Choose a CSV file first", true);
          return;
        }
        setStatus(csvImportStatus, "Reading CSV...", false);
        var reader = new FileReader();
        reader.onload = async function (e) {
          try {
            var text = e.target.result;
            var rows = parseCsv(text);
            if (rows.length === 0) {
              setStatus(csvImportStatus, "No data rows found in CSV", true);
              return;
            }
            setStatus(csvImportStatus, "Importing " + rows.length + " rows...", false);
            var out = await fetchJson("/devices/" + encodeURIComponent(selectedDeviceId) + "/users/import", {
              method: "POST",
              headers: getHeadersJson(),
              body: JSON.stringify({ rows: rows })
            });
            if (!out.res.ok) {
              setStatus(csvImportStatus, out.data.error || ("HTTP " + out.res.status), true);
              return;
            }
            setStatus(csvImportStatus,
              "Created " + out.data.created.length + " users, reused " + out.data.reused.length,
              false
            );
            await loadDeviceUsers(selectedDeviceId);
          } catch (err) {
            console.error(err);
            setStatus(csvImportStatus, "Error importing CSV", true);
          }
        };
        reader.readAsText(file);
      });
    }

    if (exportCsvDeviceBtn) {
      exportCsvDeviceBtn.addEventListener("click", async function () {
        if (!selectedDeviceId) {
          setStatus(csvImportStatus, "Select a device first", true);
          return;
        }
        setStatus(csvImportStatus, "Preparing device CSV...", false);
        try {
          var res = await fetch("/devices/" + encodeURIComponent(selectedDeviceId) + "/users/export", {
            method: "GET",
            headers: getHeadersJson()
          });
          if (!res.ok) {
            var txt = await res.text();
            setStatus(csvImportStatus, "Error exporting CSV: " + txt, true);
            return;
          }
          var blob = await res.blob();
          var url = window.URL.createObjectURL(blob);
          var a = document.createElement("a");
          a.href = url;
          a.download = "device-" + selectedDeviceId + "-users.csv";
          document.body.appendChild(a);
          a.click();
          a.remove();
          window.URL.revokeObjectURL(url);
          setStatus(csvImportStatus, "Device CSV downloaded", false);
        } catch (err) {
          console.error(err);
          setStatus(csvImportStatus, "Error exporting CSV", true);
        }
      });
    }

    if (exportAllCsvBtn) {
      exportAllCsvBtn.addEventListener("click", async function () {
        setStatus(csvImportStatus, "Preparing global CSV...", false);
        try {
          var res = await fetch("/users/export-csv", {
            method: "GET",
            headers: getHeadersJson()
          });
          if (!res.ok) {
            var txt = await res.text();
            setStatus(csvImportStatus, "Error exporting CSV: " + txt, true);
            return;
          }
          var blob = await res.blob();
          var url = window.URL.createObjectURL(blob);
          var a = document.createElement("a");
          a.href = url;
          a.download = "geata-users-devices.csv";
          document.body.appendChild(a);
          a.click();
          a.remove();
          window.URL.revokeObjectURL(url);
          setStatus(csvImportStatus, "Global CSV downloaded", false);
        } catch (err) {
          console.error(err);
          setStatus(csvImportStatus, "Error exporting global CSV", true);
        }
      });
    }

    // ---- AUX test + simulate events ----
    async function callAux(which) {
      if (!selectedDeviceId) {
        setStatus(auxStatus, "Select a device first", true);
        return;
      }
      var path = (which === "aux1") ? "aux1-test" : "aux2-test";
      setStatus(auxStatus, "Triggering " + which.toUpperCase() + " (admin test)...", false);
      try {
        var out = await fetchJson("/devices/" + encodeURIComponent(selectedDeviceId) + "/" + path, {
          method: "POST",
          headers: getHeadersJson(),
          body: JSON.stringify({ durationMs: 1000 })
        });
        if (!out.res.ok) {
          setStatus(auxStatus, out.data.error || ("HTTP " + out.res.status), true);
          return;
        }
        setStatus(auxStatus, which.toUpperCase() + " command queued (id: " + out.data.id + ")", false);
        await loadDeviceEvents(selectedDeviceId);
      } catch (err) {
        console.error(err);
        setStatus(auxStatus, "Error sending AUX command", true);
      }
    }

    if (aux1Btn) aux1Btn.addEventListener("click", function () { callAux("aux1"); });
    if (aux2Btn) aux2Btn.addEventListener("click", function () { callAux("aux2"); });

    async function simulateEvent(type) {
      if (!selectedDeviceId) {
        setStatus(simStatus, "Select a device first", true);
        return;
      }
      setStatus(simStatus, "Simulating " + type + "...", false);
      try {
        var out = await fetchJson("/devices/" + encodeURIComponent(selectedDeviceId) + "/simulate-event", {
          method: "POST",
          headers: getHeadersJson(),
          body: JSON.stringify({ type: type })
        });
        if (!out.res.ok) {
          setStatus(simStatus, out.data.error || ("HTTP " + out.res.status), true);
          return;
        }
        setStatus(simStatus, "Event simulated", false);
        await loadDeviceEvents(selectedDeviceId);
      } catch (err) {
        console.error(err);
        setStatus(simStatus, "Error simulating event", true);
      }
    }

    if (simGateOpenedBtn) simGateOpenedBtn.addEventListener("click", function () { simulateEvent("GATE_OPENED"); });
    if (simGateClosedBtn) simGateClosedBtn.addEventListener("click", function () { simulateEvent("GATE_CLOSED"); });
    if (simGateForcedBtn) simGateForcedBtn.addEventListener("click", function () { simulateEvent("GATE_FORCED_OPEN"); });
    if (simGateAjarBtn)   simGateAjarBtn.addEventListener("click", function () { simulateEvent("GATE_OPEN_TOO_LONG"); });

    async function loadDeviceEvents(deviceId) {
      if (!deviceEventsTableBody) return;
      deviceEventsTableBody.innerHTML = "";
      try {
        var out = await fetchJson("/devices/" + encodeURIComponent(deviceId) + "/events?limit=20", {
          method: "GET",
          headers: getHeadersJson()
        });
        if (!out.res.ok) return;

        (out.data || []).forEach(function (ev) {
          var tr = document.createElement("tr");
          var tdTime = document.createElement("td");
          var tdEvent = document.createElement("td");
          var tdUser = document.createElement("td");
          var tdDetails = document.createElement("td");
          tdTime.textContent = ev.at || "";
          tdEvent.textContent = ev.event_type || "";
          var bits = [];
          if (ev.user_name) bits.push(ev.user_name);
          if (ev.user_phone) bits.push(ev.user_phone);
          if (ev.user_id) bits.push("[" + ev.user_id + "]");
          tdUser.textContent = bits.join(" | ");
          tdDetails.textContent = ev.details || "";
          tr.appendChild(tdTime);
          tr.appendChild(tdEvent);
          tr.appendChild(tdUser);
          tr.appendChild(tdDetails);
          deviceEventsTableBody.appendChild(tr);
        });
      } catch (err) { console.error(err); }
    }

    if (refreshDeviceEventsBtn) {
      refreshDeviceEventsBtn.addEventListener("click", function () {
        if (selectedDeviceId) loadDeviceEvents(selectedDeviceId);
      });
    }

    // ---- Notifications buttons ----
    if (refreshNotificationsBtn) {
      refreshNotificationsBtn.addEventListener("click", function () {
        if (!selectedDeviceId) return setStatus(document.getElementById("notifyStatus"), "Select a device first", true);
        loadDeviceNotifications(selectedDeviceId);
      });
    }

    if (saveNotificationsBtn) {
      saveNotificationsBtn.addEventListener("click", function () {
        if (!selectedDeviceId) return setStatus(document.getElementById("notifyStatus"), "Select a device first", true);
        var uid = notifyUserSelect && notifyUserSelect.value;
        if (!uid) return setStatus(document.getElementById("notifyStatus"), "Select a user first", true);
        saveUserNotifications(selectedDeviceId, uid, getSelectedEventTypes());
      });
    }

    // ---- Device settings buttons ----
    if (loadDeviceSettingsBtn) {
      loadDeviceSettingsBtn.addEventListener("click", function () {
        if (!selectedDeviceId) return setStatus(document.getElementById("deviceSettingsStatus"), "Select a device first", true);
        loadDeviceSettings(selectedDeviceId);
      });
    }

    if (saveDeviceSettingsBtn) {
      saveDeviceSettingsBtn.addEventListener("click", function () {
        if (!selectedDeviceId) return setStatus(document.getElementById("deviceSettingsStatus"), "Select a device first", true);
        saveDeviceSettings(selectedDeviceId);
      });
    }

    // ---- Purge events ----
    if (purgeEventsBtn) {
      purgeEventsBtn.addEventListener("click", function () {
        var days = Number(purgeOlderThanDays.value || 0);
        purgeEventsOlderThan(days);
      });
    }

    // ---- Global users (directory) ----
    async function loadUsers(query) {
      if (!globalUsersTableBody || !userSearchStatus) return;
      globalUsersTableBody.innerHTML = "";
      setStatus(userSearchStatus, "Loading users...", false);
      try {
        var url = query ? ("/users?q=" + encodeURIComponent(query)) : "/users";
        var out = await fetchJson(url, { method: "GET", headers: getHeadersJson() });
        if (!out.res.ok) {
          setStatus(userSearchStatus, out.data.error || ("HTTP " + out.res.status), true);
          return;
        }

        (out.data || []).forEach(function (u) {
          var tr = document.createElement("tr");

          var tdSelect = document.createElement("td");
          var cb = document.createElement("input");
          cb.type = "checkbox";
          cb.className = "userAttachCheckbox";
          cb.dataset.userId = u.id;
          tdSelect.appendChild(cb);

          var tdId = document.createElement("td");
          var tdName = document.createElement("td");
          var tdEmail = document.createElement("td");
          var tdPhone = document.createElement("td");
          var tdDevices = document.createElement("td");
          var tdEdit = document.createElement("td");
          var tdDelete = document.createElement("td");

          tdId.textContent = u.id;
          tdName.textContent = u.name || "";
          tdEmail.textContent = u.email || "";
          tdPhone.textContent = u.phone || "";

          if (u.devices && u.devices.length > 0) {
            u.devices.forEach(function (d) {
              var span = document.createElement("span");
              span.className = "pill";
              span.textContent = d.deviceId + "(" + (d.role || "operator") + ")";
              tdDevices.appendChild(span);
            });
          }

          var editBtn = document.createElement("button");
          editBtn.textContent = "Edit";
          editBtn.className = "btn-small";
          editBtn.addEventListener("click", function () { startEditUser(u); });
          tdEdit.appendChild(editBtn);

          var delBtn = document.createElement("button");
          delBtn.textContent = "Delete";
          delBtn.className = "btn-danger btn-small";
          delBtn.addEventListener("click", function () { deleteUser(u.id); });
          tdDelete.appendChild(delBtn);

          tr.appendChild(tdSelect);
          tr.appendChild(tdId);
          tr.appendChild(tdName);
          tr.appendChild(tdEmail);
          tr.appendChild(tdPhone);
          tr.appendChild(tdDevices);
          tr.appendChild(tdEdit);
          tr.appendChild(tdDelete);
          globalUsersTableBody.appendChild(tr);
        });

        setStatus(userSearchStatus, "Loaded " + (out.data ? out.data.length : 0) + " users", false);
      } catch (err) {
        console.error(err);
        setStatus(userSearchStatus, "Error loading users", true);
      }
    }

    if (attachSelectedUsersBtn) {
      attachSelectedUsersBtn.addEventListener("click", async function () {
        if (!selectedDeviceId) {
          setStatus(userSearchStatus, 'Select a device first in "Select Device & Users".', true);
          return;
        }
        var checkboxes = globalUsersTableBody.querySelectorAll("input.userAttachCheckbox:checked");
        if (!checkboxes.length) {
          setStatus(userSearchStatus, "No users selected to attach", true);
          return;
        }

        var userIds = Array.prototype.map.call(checkboxes, function (cb) { return cb.dataset.userId; });
        setStatus(userSearchStatus, "Attaching " + userIds.length + " users to " + selectedDeviceId + "...", false);

        try {
          for (var i = 0; i < userIds.length; i++) {
            var userId = userIds[i];
            var out = await fetchJson("/devices/" + encodeURIComponent(selectedDeviceId) + "/users", {
              method: "POST",
              headers: getHeadersJson(),
              body: JSON.stringify({ userId: userId, role: "operator" })
            });
            if (!out.res.ok) console.warn("Failed to attach user", userId, out.data);
          }

          setStatus(userSearchStatus, "Attached " + userIds.length + " users to " + selectedDeviceId, false);
          Array.prototype.forEach.call(checkboxes, function (cb) { cb.checked = false; });

          if (selectedDeviceId) await loadDeviceUsers(selectedDeviceId);
        } catch (err) {
          console.error(err);
          setStatus(userSearchStatus, "Error attaching selected users", true);
        }
      });
    }

    if (searchUsersBtn) searchUsersBtn.addEventListener("click", function () {
      var q = userSearchInput.value.trim();
      loadUsers(q || null);
    });

    if (showAllUsersBtn) showAllUsersBtn.addEventListener("click", function () {
      userSearchInput.value = "";
      loadUsers(null);
    });

    function startEditUser(u) {
      editingUserId = u.id;
      editUserTarget.textContent = "Editing user " + u.id;
      editUserName.value = u.name || "";
      editUserEmail.value = u.email || "";
      editUserPhone.value = u.phone || "";
      editUserPassword.value = "";
      setStatus(editUserStatus, "", false);
    }

    async function deleteUser(userId) {
      if (!window.confirm("Delete user " + userId + " from all devices?")) return;
      try {
        var out = await fetchJson("/users/" + encodeURIComponent(userId), {
          method: "DELETE",
          headers: getHeadersJson()
        });
        if (!out.res.ok) {
          window.alert("Error deleting user: " + (out.data.error || ("HTTP " + out.res.status)));
          return;
        }
        window.alert("User deleted");
        if (editingUserId === userId) {
          editingUserId = null;
          editUserTarget.textContent = "";
          editUserName.value = "";
          editUserEmail.value = "";
          editUserPhone.value = "";
          editUserPassword.value = "";
        }
        await loadUsers(userSearchInput.value.trim() || null);
        if (selectedDeviceId) await loadDeviceUsers(selectedDeviceId);
      } catch (err) {
        console.error(err);
        window.alert("Error deleting user");
      }
    }

    if (saveUserChangesBtn) {
      saveUserChangesBtn.addEventListener("click", async function () {
        if (!editingUserId) {
          setStatus(editUserStatus, "No user selected for editing", true);
          return;
        }
        var name = editUserName.value.trim();
        var email = editUserEmail.value.trim();
        var phone = editUserPhone.value.trim();
        var password = editUserPassword.value;
        setStatus(editUserStatus, "Saving changes...", false);
        try {
          var out = await fetchJson("/users/" + encodeURIComponent(editingUserId), {
            method: "PUT",
            headers: getHeadersJson(),
            body: JSON.stringify({ name: name, email: email, phone: phone, password: password })
          });
          if (!out.res.ok) {
            setStatus(editUserStatus, out.data.error || ("HTTP " + out.res.status), true);
            return;
          }
          setStatus(editUserStatus, "User updated", false);
          editUserPassword.value = "";
          await loadUsers(userSearchInput.value.trim() || null);
          if (selectedDeviceId) await loadDeviceUsers(selectedDeviceId);
        } catch (err) {
          console.error(err);
          setStatus(editUserStatus, "Error saving user changes", true);
        }
      });
    }

    // ---- Schedules ----
    function resetScheduleForm() {
      editingScheduleId = null;
      scheduleFormTitle.textContent = "Create / Edit Schedule";
      scheduleNameInput.value = "";
      scheduleDescInput.value = "";
      slotInputs.forEach(function (s) {
        s.days.value = "";
        s.start.value = "";
        s.end.value = "";
      });
      setStatus(scheduleStatus, "", false);
    }

    function readSlotsFromForm() {
      var slots = [];
      slotInputs.forEach(function (s) {
        var daysStr = s.days.value.trim();
        var start = s.start.value;
        var end = s.end.value;
        if (!daysStr && !start && !end) return;
        if (!start || !end) return;
        var days = parseDaysString(daysStr);
        slots.push({ daysOfWeek: days, start: start, end: end });
      });
      return slots;
    }

    function fillSlotsFormFromSchedule(sched) {
      slotInputs.forEach(function (s) {
        s.days.value = "";
        s.start.value = "";
        s.end.value = "";
      });
      if (!sched || !sched.slots) return;
      var slots = sched.slots;
      for (var i = 0; i < slots.length && i < slotInputs.length; i++) {
        var sl = slots[i];
        var days = Array.isArray(sl.daysOfWeek) ? sl.daysOfWeek : [];
        slotInputs[i].days.value = days.join(",");
        slotInputs[i].start.value = sl.start || "";
        slotInputs[i].end.value = sl.end || "";
      }
    }

    async function loadSchedules() {
      if (!schedulesTableBody || !scheduleStatus) return;
      schedulesTableBody.innerHTML = "";
      setStatus(scheduleStatus, "Loading schedules...", false);
      try {
        var out = await fetchJson("/schedules", { method: "GET", headers: getHeadersJson() });
        if (!out.res.ok) {
          setStatus(scheduleStatus, out.data.error || ("HTTP " + out.res.status), true);
          return;
        }
        allSchedules = out.data || [];
        rebuildAttachUserScheduleOptions();

        (out.data || []).forEach(function (s) {
          var tr = document.createElement("tr");
          var tdId = document.createElement("td");
          var tdName = document.createElement("td");
          var tdSlots = document.createElement("td");
          var tdEdit = document.createElement("td");
          var tdDelete = document.createElement("td");
          tdId.textContent = s.id;
          tdName.textContent = s.name;
          tdSlots.textContent = describeSlots(s.slots || []);
          var editBtn = document.createElement("button");
          editBtn.textContent = "Edit";
          editBtn.className = "btn-small";
          editBtn.addEventListener("click", function () {
            editingScheduleId = s.id;
            scheduleFormTitle.textContent = "Editing schedule " + s.id;
            scheduleNameInput.value = s.name || "";
            scheduleDescInput.value = s.description || "";
            fillSlotsFormFromSchedule(s);
            setStatus(scheduleStatus, "Editing schedule " + s.id, false);
          });
          tdEdit.appendChild(editBtn);

          var delBtn = document.createElement("button");
          delBtn.textContent = "Delete";
          delBtn.className = "btn-danger btn-small";
          delBtn.addEventListener("click", async function () {
            if (!window.confirm('Delete schedule "' + s.name + '"?')) return;
            try {
              var out2 = await fetchJson("/schedules/" + s.id, {
                method: "DELETE",
                headers: getHeadersJson()
              });
              if (!out2.res.ok) {
                window.alert("Error deleting schedule: " + (out2.data.error || ("HTTP " + out2.res.status)));
                return;
              }
              resetScheduleForm();
              await loadSchedules();
              if (selectedDeviceId) await loadDeviceUsers(selectedDeviceId);
            } catch (err) {
              console.error(err);
              window.alert("Error deleting schedule");
            }
          });
          tdDelete.appendChild(delBtn);

          tr.appendChild(tdId);
          tr.appendChild(tdName);
          tr.appendChild(tdSlots);
          tr.appendChild(tdEdit);
          tr.appendChild(tdDelete);
          schedulesTableBody.appendChild(tr);
        });

        setStatus(scheduleStatus, "Loaded " + (out.data ? out.data.length : 0) + " schedules", false);
      } catch (err) {
        console.error(err);
        setStatus(scheduleStatus, "Error loading schedules", true);
      }
    }

    if (refreshSchedulesBtn) refreshSchedulesBtn.addEventListener("click", function () { loadSchedules(); });
    if (resetScheduleFormBtn) resetScheduleFormBtn.addEventListener("click", function () { resetScheduleForm(); });

    if (saveScheduleBtn) {
      saveScheduleBtn.addEventListener("click", async function () {
        var name = scheduleNameInput.value.trim();
        var description = scheduleDescInput.value.trim();
        var slots = readSlotsFromForm();
        if (!name) {
          setStatus(scheduleStatus, "Schedule name is required", true);
          return;
        }
        if (slots.length === 0) {
          if (!window.confirm("No slots defined. This schedule will give NO access. Continue?")) return;
        }
        var payload = { name: name, description: description, slots: slots };
        try {
          if (editingScheduleId) {
            setStatus(scheduleStatus, "Updating schedule...", false);
            var out = await fetchJson("/schedules/" + editingScheduleId, {
              method: "PUT",
              headers: getHeadersJson(),
              body: JSON.stringify(payload)
            });
            if (!out.res.ok) {
              setStatus(scheduleStatus, out.data.error || ("HTTP " + out.res.status), true);
              return;
            }
          } else {
            setStatus(scheduleStatus, "Creating schedule...", false);
            var out2 = await fetchJson("/schedules", {
              method: "POST",
              headers: getHeadersJson(),
              body: JSON.stringify(payload)
            });
            if (!out2.res.ok) {
              setStatus(scheduleStatus, out2.data.error || ("HTTP " + out2.res.status), true);
              return;
            }
          }
          resetScheduleForm();
          await loadSchedules();
          if (selectedDeviceId) await loadDeviceUsers(selectedDeviceId);
        } catch (err) {
          console.error(err);
          setStatus(scheduleStatus, "Error saving schedule", true);
        }
      });
    }

    // ---- Reports / audit ----
    function buildReportQueryParams() {
      var params = [];
      if (reportDeviceSelect && reportDeviceSelect.value) params.push("deviceId=" + encodeURIComponent(reportDeviceSelect.value));
      if (reportUserIdInput && reportUserIdInput.value.trim()) params.push("userId=" + encodeURIComponent(reportUserIdInput.value.trim()));
      if (reportFromDate && reportFromDate.value) params.push("from=" + encodeURIComponent(reportFromDate.value + "T00:00:00"));
      if (reportToDate && reportToDate.value) params.push("to=" + encodeURIComponent(reportToDate.value + "T23:59:59"));
      params.push("limit=1000");
      return params.join("&");
    }

    async function runReport() {
      if (!reportEventsTableBody || !reportStatus) return;
      reportEventsTableBody.innerHTML = "";
      var qs = buildReportQueryParams();
      setStatus(reportStatus, "Loading report...", false);
      try {
        var out = await fetchJson("/events" + (qs ? ("?" + qs) : ""), {
          method: "GET",
          headers: getHeadersJson()
        });
        if (!out.res.ok) {
          setStatus(reportStatus, out.data.error || ("HTTP " + out.res.status), true);
          return;
        }

        (out.data || []).forEach(function (ev) {
          var tr = document.createElement("tr");
          var tdTime = document.createElement("td");
          var tdDevice = document.createElement("td");
          var tdUser = document.createElement("td");
          var tdEvent = document.createElement("td");
          var tdDetails = document.createElement("td");
          tdTime.textContent = ev.at || "";
          tdDevice.textContent = (ev.device_id || "") + (ev.device_name ? (" – " + ev.device_name) : "");
          var userBits = [];
          if (ev.user_name) userBits.push(ev.user_name);
          if (ev.user_phone) userBits.push(ev.user_phone);
          if (ev.user_id) userBits.push("[" + ev.user_id + "]");
          tdUser.textContent = userBits.join(" | ");
          tdEvent.textContent = ev.event_type || "";
          tdDetails.textContent = ev.details || "";
          tr.appendChild(tdTime);
          tr.appendChild(tdDevice);
          tr.appendChild(tdUser);
          tr.appendChild(tdEvent);
          tr.appendChild(tdDetails);
          reportEventsTableBody.appendChild(tr);
        });

        setStatus(reportStatus, "Report loaded: " + (out.data ? out.data.length : 0) + " events", false);
      } catch (err) {
        console.error(err);
        setStatus(reportStatus, "Error loading report", true);
      }
    }

    async function downloadReportCsv() {
      var qs = buildReportQueryParams();
      setStatus(reportStatus, "Preparing CSV...", false);
      try {
        var res = await fetch("/events" + (qs ? ("?" + qs + "&format=csv") : "?format=csv"), {
          method: "GET",
          headers: getHeadersJson()
        });
        if (!res.ok) {
          var txt = await res.text();
          setStatus(reportStatus, "Error downloading CSV: " + txt, true);
          return;
        }
        var blob = await res.blob();
        var url = window.URL.createObjectURL(blob);
        var a = document.createElement("a");
        a.href = url;
        a.download = "events-report.csv";
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
        setStatus(reportStatus, "CSV downloaded", false);
      } catch (err) {
        console.error(err);
        setStatus(reportStatus, "Error downloading CSV", true);
      }
    }

    if (runReportBtn) runReportBtn.addEventListener("click", function () { runReport(); });
    if (downloadReportCsvBtn) downloadReportCsvBtn.addEventListener("click", function () { downloadReportCsv(); });

    // ---- Initial load ----
    loadDevices();
    loadUsers(null);
    loadSchedules();
  });
</script>
</body>
</html>
