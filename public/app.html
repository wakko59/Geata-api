<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Geata – Gate Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#000000" />
  <link rel="manifest" href="/manifest.json" />
<style>
  :root {
    /* same palette as admin */
    --bg-main: #cfdfee;
    --bg-card: #0b2535;
    --bg-card-soft: #123653;
    --accent: #1c5e86;
    --accent-dark: #1c5e86;
    --accent-soft: rgba(28, 94, 134, 0.2);
    --danger: #d9534f;
    --text-main: #f5f7fa;
    --text-dark: #f5f7fa;
    --text-muted: #7b8a9b;
  }

  * {
    box-sizing: border-box;
  }

  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    margin: 0;
    padding: 0;
    background: radial-gradient(circle at top, #1e3f2fd 0, var(--bg-main) 45%, #b3cde5 100%);
    color: var(--text-main);
  }

  .container {
    max-width: 480px;
    margin: 0 auto;
    padding: 20px 16px 40px;
  }

  h1 {
    margin: 0 0 12px;
    font-size: 26px;
    letter-spacing: 0.04em;
  }

  /* cards – same rounded look as admin */
  .card {
    background: var(--bg-card);
    color: var(--text-main);
    border-radius: 14px;
    padding: 14px 16px 16px;
    box-shadow: 0 12px 30px rgba(0,0,0,0.18);
    margin-bottom: 16px;
    border: 1px solid rgba(255,255,255,0.08);
  }

  label {
    display: block;
    margin-bottom: 4px;
    font-size: 13px;
    font-weight: 500;
    color: #e3f2fd;
  }

  input {
    padding: 7px 9px;
    margin-bottom: 8px;
    border-radius: 8px;
    border: 1px solid #ccd2dd;
    font-size: 13px;
    width: 100%;
  }

  input:focus {
    outline: none;
    border-color: var(--accent-dark);
    box-shadow: 0 0 0 1px rgba(0, 123, 255, 0.35);
  }

  button {
    padding: 7px 11px;
    border-radius: 999px;
    border: none;
    background: var(--accent-dark);
    color: #fff;
    font-size: 13px;
    cursor: pointer;
    margin-right: 6px;
    margin-bottom: 6px;
    white-space: nowrap;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }

  button.btn-secondary {
    background: #345a77;
  }

  button.btn-danger {
    background: var(--danger);
  }

  button[disabled] {
    opacity: 0.5;
    cursor: default;
  }

  .status {
    font-size: 12px;
    min-height: 16px;
    margin-top: 4px;
    color: #ffb300;
  }

  .status.error {
    color: #b00020;
  }

  .status.ok {
    color: #ffb300;
  }

  /* per-gate styling */
  .gate-card {
    background: var(--bg-card-soft);
  }

  .gate-name {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 4px;
  }

  .gate-id {
    font-size: 12px;
    color: var(--text-muted);
    margin-bottom: 8px;
  }

  .footer {
    margin-top: 12px;
    font-size: 12px;
    color: var(--text-muted);
    text-align: center;
  }
</style>


</head>
<body>
  <div class="container">
    <h1>Geata</h1>

    <!-- Login card -->
    <div class="card" id="loginCard">
      <h2 style="margin-top: 0; font-size: 18px;">Login</h2>
      <label for="loginIdInput">Phone or Email</label>
      <input id="loginIdInput" type="text" placeholder="e.g. 0861234567 or user@example.com" />
      <label for="loginPasswordInput">Password</label>
      <input id="loginPasswordInput" type="password" placeholder="Password" />
      <button id="loginBtn">Login</button>
      <div id="loginStatus" class="status"></div>
      <p style="font-size: 12px; color: #555; margin-top: 8px;">
        Use the same phone/email and password that your admin assigned to you.
      </p>
    </div>

    <!-- Logged-in card -->
    <div class="card" id="userCard" style="display:none;">
      <div id="userInfo" style="font-size: 14px; margin-bottom: 8px;"></div>
      <button id="logoutBtn" class="btn-secondary">Log out</button>
      <div id="userStatus" class="status"></div>
    </div>

    <!-- Devices card -->
    <div class="card" id="devicesCard" style="display:none;">
      <h2 style="margin-top: 0; font-size: 18px;">My Gates</h2>
      <div id="devicesList"></div>
      <div id="devicesStatus" class="status"></div>
    </div>

    <div class="footer">
      Geata – secure gate control
    </div>
  </div>

      <script>
    console.log("Geata app script loaded v2");

    let authToken = null;
    let currentUser = null;
    let myDevices = [];

    function setStatus(el, msg, isError) {
      if (!el) return;
      el.textContent = msg || "";
      el.className = "status" + (isError ? " error" : " ok");
    }

    function getAuthHeaders() {
      const headers = { "Content-Type": "application/json" };
      if (authToken) {
        headers["authorization"] = "Bearer " + authToken;
      }
      return headers;
    }

    function showLoggedInUI() {
      const loginCard = document.getElementById("loginCard");
      const userCard = document.getElementById("userCard");
      const devicesCard = document.getElementById("devicesCard");
      const userInfo = document.getElementById("userInfo");

      if (currentUser && authToken) {
        loginCard.style.display = "none";
        userCard.style.display = "block";
        devicesCard.style.display = "block";
        const bits = [];
        if (currentUser.name) bits.push(currentUser.name);
        if (currentUser.phone) bits.push(currentUser.phone);
        if (currentUser.email) bits.push(currentUser.email);
        userInfo.textContent = bits.join(" • ");
      } else {
        loginCard.style.display = "block";
        userCard.style.display = "none";
        devicesCard.style.display = "none";
      }
    }

    async function tryLoadMe() {
      // Called on startup when there's a stored token
      const userStatus = document.getElementById("userStatus");
      const devicesStatus = document.getElementById("devicesStatus");
      try {
        const res = await fetch("/me", {
          method: "GET",
          headers: getAuthHeaders()
        });
        if (!res.ok) {
          // token invalid
          authToken = null;
          currentUser = null;
          localStorage.removeItem("geata_token");
          localStorage.removeItem("geata_user");
          showLoggedInUI();
          return;
        }
        const data = await res.json();
        currentUser = data;
        showLoggedInUI();
        setStatus(userStatus, "Logged in", false);
        await loadMyDevices();
      } catch (err) {
        console.error(err);
        setStatus(userStatus, "Error checking login", true);
        setStatus(devicesStatus, "Error loading devices", true);
      }
    }

    async function loadMyDevices() {
      const devicesList = document.getElementById("devicesList");
      const devicesStatus = document.getElementById("devicesStatus");
      devicesList.innerHTML = "";
      setStatus(devicesStatus, "Loading gates...", false);
      try {
        const res = await fetch("/me/devices", {
          method: "GET",
          headers: getAuthHeaders()
        });
        const data = await res.json().catch(() => []);
        if (!res.ok) {
          setStatus(devicesStatus, data.error || ("HTTP " + res.status), true);
          return;
        }
        myDevices = data;
        if (myDevices.length === 0) {
          devicesList.innerHTML = "<p>You have no gates assigned.</p>";
          setStatus(devicesStatus, "", false);
          return;
        }

        myDevices.forEach((d) => {
          const card = document.createElement("div");
          // use the same rounded card style as admin
          card.className = "card gate-card";

          const nameEl = document.createElement("div");
          nameEl.className = "gate-name";
          nameEl.textContent = d.name || "Gate";

          const idEl = document.createElement("div");
          idEl.className = "gate-id";
          idEl.textContent = d.id + " • role: " + (d.role || "operator");

          const btnOpen = document.createElement("button");
          btnOpen.textContent = "Open Gate";
          btnOpen.addEventListener("click", () => {
            sendCommand("open", d.id, 1000);
          });

          const btnAux1 = document.createElement("button");
          btnAux1.textContent = "Aux 1";
          btnAux1.addEventListener("click", () => {
            sendCommand("aux1", d.id, 1000);
          });

          const btnAux2 = document.createElement("button");
          btnAux2.textContent = "Aux 2";
          btnAux2.addEventListener("click", () => {
            sendCommand("aux2", d.id, 1000);
          });

          const statusEl = document.createElement("div");
          statusEl.className = "status";
          statusEl.style.marginTop = "6px";

          card.appendChild(nameEl);
          card.appendChild(idEl);
          card.appendChild(btnOpen);
          card.appendChild(btnAux1);
          card.appendChild(btnAux2);
          card.appendChild(statusEl);

          devicesList.appendChild(card);

          // attach per-card status element
          card._statusEl = statusEl;
        });

        setStatus(devicesStatus, "", false);
      } catch (err) {
        console.error(err);
        setStatus(devicesStatus, "Error loading gates", true);
      }
    }

    function findCardStatusEl(deviceId) {
      const list = document.getElementById("devicesList");
      if (!list) return null;
      const cards = list.children;
      for (let i = 0; i < cards.length; i++) {
        const card = cards[i];
        const idEl = card.querySelector(".gate-id");
        if (!idEl) continue;
        // idEl text contains "deviceId • role: ..."
        if (idEl.textContent.startsWith(deviceId + " ")) {
          return card._statusEl || null;
        }
      }
      return null;
    }

async function sendCommand(kind, deviceId, durationMs) {
  const route =
    kind === "open"
      ? "/devices/" + encodeURIComponent(deviceId) + "/open"
      : "/devices/" + encodeURIComponent(deviceId) + "/" + kind;

  const statusEl = findCardStatusEl(deviceId);

  if (statusEl) {
    setStatus(statusEl, "Sending " + kind.toUpperCase() + "...", false);
  }

  try {
    const res = await fetch(route, {
      method: "POST",
      headers: getAuthHeaders(),
      body: JSON.stringify({ durationMs: durationMs })
    });
    const data = await res.json().catch(() => ({}));

    if (!res.ok) {
      const msg = data.error || ("HTTP " + res.status);
      if (statusEl) {
        // For errors, show and DO NOT auto-clear
        setStatus(statusEl, msg, true);
      }
      return;
    }

    if (statusEl) {
      // Show success message
      setStatus(
        statusEl,
        kind.toUpperCase() + " command queued (id: " + (data.id || data.commandId || "?") + ")",
        false
      );

      // Auto-clear after 5 seconds, but only if no newer message has appeared
      const clearToken = Date.now();
      statusEl._clearToken = clearToken;

      setTimeout(() => {
        // Only clear if this is still the latest message and it's not an error
        if (
          statusEl._clearToken === clearToken &&
          !statusEl.classList.contains("error")
        ) {
          statusEl.textContent = "";
          statusEl.className = "status";
        }
      }, 5000);
    }
  } catch (err) {
    console.error(err);
    if (statusEl) {
      // Network/other error, keep visible
      setStatus(statusEl, "Error sending " + kind.toUpperCase(), true);
    }
  }
}


    window.addEventListener("load", () => {
      const loginIdInput = document.getElementById("loginIdInput");
      const loginPasswordInput = document.getElementById("loginPasswordInput");
      const loginBtn = document.getElementById("loginBtn");
      const loginStatus = document.getElementById("loginStatus");
      const logoutBtn = document.getElementById("logoutBtn");
      const userStatus = document.getElementById("userStatus");

      // Restore token/user from localStorage if present
      try {
        const savedToken = localStorage.getItem("geata_token");
        const savedUser = localStorage.getItem("geata_user");
        if (savedToken) {
          authToken = savedToken;
          if (savedUser) {
            currentUser = JSON.parse(savedUser);
          }
          showLoggedInUI();
          tryLoadMe(); // verify token and load devices
        }
      } catch (err) {
        console.error("Error restoring saved session", err);
      }

      if (loginBtn) {
        loginBtn.addEventListener("click", async () => {
          const idValue = (loginIdInput.value || "").trim();
          const password = loginPasswordInput.value;

          if (!idValue || !password) {
            setStatus(loginStatus, "Phone/email and password are required", true);
            return;
          }

          let body;
          if (idValue.indexOf("@") !== -1) {
            // looks like email
            body = { email: idValue, password: password };
          } else {
            // treat as phone
            body = { phone: idValue, password: password };
          }

          setStatus(loginStatus, "Logging in...", false);
          try {
            const res = await fetch("/auth/login", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(body)
            });
            const data = await res.json().catch(() => ({}));
            if (!res.ok) {
              setStatus(loginStatus, data.error || ("HTTP " + res.status), true);
              return;
            }
            authToken = data.token;
            currentUser = data.user;
            localStorage.setItem("geata_token", authToken);
            localStorage.setItem("geata_user", JSON.stringify(currentUser));
            loginPasswordInput.value = "";
            setStatus(loginStatus, "", false);
            setStatus(userStatus, "Logged in", false);
            showLoggedInUI();
            await loadMyDevices();
          } catch (err) {
            console.error(err);
            setStatus(loginStatus, "Error logging in", true);
          }
        });
      }

      if (logoutBtn) {
        logoutBtn.addEventListener("click", () => {
          authToken = null;
          currentUser = null;
          myDevices = [];
          localStorage.removeItem("geata_token");
          localStorage.removeItem("geata_user");
          setStatus(userStatus, "Logged out", false);
          showLoggedInUI();
        });
      }

      // Register service worker (for PWA install/offline)
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("/sw.js").catch((err) => {
          console.warn("Service worker registration failed", err);
        });
      }
    });
  </script>
 </body>
</html>
